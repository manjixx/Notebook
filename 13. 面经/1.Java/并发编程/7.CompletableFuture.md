- [ä¸€ã€ CompletableFuture ç®€ä»‹](#ä¸€-completablefuture-ç®€ä»‹)
- [äºŒã€å¸¸è§æ“ä½œ](#äºŒå¸¸è§æ“ä½œ)
  - [2.1 åˆ›å»º CompletableFuture](#21-åˆ›å»º-completablefuture)
    - [2.1.1 new å…³é”®å­—](#211-new-å…³é”®å­—)
    - [2.1.2 é™æ€å·¥å‚æ–¹æ³•](#212-é™æ€å·¥å‚æ–¹æ³•)
  - [2.2 å¤„ç†å¼‚æ­¥ç»“ç®—çš„ç»“æœ](#22-å¤„ç†å¼‚æ­¥ç»“ç®—çš„ç»“æœ)
    - [2.2.1 thenApply()æ–¹æ³•](#221-thenapplyæ–¹æ³•)
    - [2.2.2 thenAccept() å’Œ thenRun()æ–¹æ³•](#222-thenaccept-å’Œ-thenrunæ–¹æ³•)
    - [2.2.3 whenComplete()](#223-whencomplete)
  - [2.3 å¼‚å¸¸å¤„ç†](#23-å¼‚å¸¸å¤„ç†)
    - [2.3.1 ä½¿ç”¨handle()æ–¹æ³•å¤„ç†å¼‚å¸¸](#231-ä½¿ç”¨handleæ–¹æ³•å¤„ç†å¼‚å¸¸)
    - [2.3.2 é€šè¿‡exceptionally()æ–¹æ³•å¤„ç†å¼‚å¸¸](#232-é€šè¿‡exceptionallyæ–¹æ³•å¤„ç†å¼‚å¸¸)
  - [2.4 ç»„åˆ CompletableFuture](#24-ç»„åˆ-completablefuture)
  - [2.5 å¹¶è¡Œè¿è¡Œå¤šä¸ª CompletableFuture](#25-å¹¶è¡Œè¿è¡Œå¤šä¸ª-completablefuture)
  - [åè®°](#åè®°)
  
# ä¸€ã€ CompletableFuture ç®€ä»‹

`CompletableFuture` æ˜¯Java 8 æ‰è¢«å¼•å…¥çš„ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„ç”¨äºå¼‚æ­¥ç¼–ç¨‹çš„ç±»ã€‚

`CompletableFuture` åŒæ—¶å®ç°äº† `Future` å’Œ `CompletionStage` æ¥å£ã€‚

```java
public class CompletableFuture<T> implements Future<T>, CompletionStage<T> {
}
```

`CompletableFuture` é™¤äº†æä¾›äº†æ›´ä¸ºå¥½ç”¨å’Œå¼ºå¤§çš„ `Future` ç‰¹æ€§ä¹‹å¤–ï¼Œè¿˜æä¾›äº†å‡½æ•°å¼ç¼–ç¨‹çš„èƒ½åŠ›ã€‚

![](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/javaguide/image-20210902092441434.png)

> `Future` æ¥å£æœ‰ 5 ä¸ªæ–¹æ³•ï¼š

- `boolean cancel(boolean mayInterruptIfRunning)` ï¼šå°è¯•å–æ¶ˆæ‰§è¡Œä»»åŠ¡ã€‚
- `boolean isCancelled()` ï¼šåˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆã€‚
- `boolean isDone()` ï¼š åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²ç»è¢«æ‰§è¡Œå®Œæˆã€‚
- `get()` ï¼šç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆå¹¶è·å–è¿ç®—ç»“æœã€‚
- `get(long timeout, TimeUnit unit)` ï¼šå¤šäº†ä¸€ä¸ªè¶…æ—¶æ—¶é—´ã€‚

![](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/javaguide/image-20210902093026059.png)

`CompletionStage<T>` æ¥å£ä¸­çš„æ–¹æ³•æ¯”è¾ƒå¤šï¼Œ`CompletableFuture` çš„å‡½æ•°å¼èƒ½åŠ›å°±æ˜¯è¿™ä¸ªæ¥å£èµ‹äºˆçš„ã€‚ä»è¿™ä¸ªæ¥å£çš„æ–¹æ³•å‚æ•°ä½ å°±å¯ä»¥å‘ç°å…¶å¤§é‡ä½¿ç”¨äº† Java8 å¼•å…¥çš„å‡½æ•°å¼ç¼–ç¨‹ã€‚

ç”±äºæ–¹æ³•ä¼—å¤šï¼Œæ‰€ä»¥è¿™é‡Œä¸èƒ½ä¸€ä¸€è®²è§£ï¼Œä¸‹æ–‡ä¸­æˆ‘ä¼šä»‹ç»å¤§éƒ¨åˆ†å¸¸è§æ–¹æ³•çš„ä½¿ç”¨ã€‚

# äºŒã€å¸¸è§æ“ä½œ

## 2.1 åˆ›å»º CompletableFuture

å¸¸è§çš„åˆ›å»º `CompletableFuture` å¯¹è±¡çš„æ–¹æ³•å¦‚ä¸‹ï¼š

1. é€šè¿‡ new å…³é”®å­—ã€‚
2. åŸºäº `CompletableFuture` è‡ªå¸¦çš„é™æ€å·¥å‚æ–¹æ³•ï¼š`runAsync()` ã€`supplyAsync()` ã€‚

### 2.1.1 new å…³é”®å­—

é€šè¿‡ new å…³é”®å­—åˆ›å»º `CompletableFuture` å¯¹è±¡è¿™ç§ä½¿ç”¨æ–¹å¼å¯ä»¥çœ‹ä½œæ˜¯å°† `CompletableFuture` å½“åš `Future` æ¥ä½¿ç”¨ã€‚

åœ¨å¼€æºé¡¹ç›® [guide-rpc-framework](https://github.com/Snailclimb/guide-rpc-framework) ä¸­å°±æ˜¯è¿™ç§æ–¹å¼åˆ›å»ºçš„ `CompletableFuture` å¯¹è±¡ã€‚

> ğŸ™‹â€â™‚ï¸ğŸŒ°

æˆ‘ä»¬é€šè¿‡åˆ›å»ºäº†ä¸€ä¸ªç»“æœå€¼ç±»å‹ä¸º `RpcResponse<Object>` çš„ `CompletableFuture`ï¼Œä½ å¯ä»¥æŠŠ `resultFuture` çœ‹ä½œæ˜¯å¼‚æ­¥è¿ç®—ç»“æœçš„è½½ä½“ã€‚

```java
CompletableFuture<RpcResponse<Object>> resultFuture = new CompletableFuture<>();
```

å‡è®¾åœ¨æœªæ¥çš„æŸä¸ªæ—¶åˆ»ï¼Œæˆ‘ä»¬å¾—åˆ°äº†æœ€ç»ˆçš„ç»“æœã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨ `complete()` æ–¹æ³•ä¸ºå…¶ä¼ å…¥ç»“æœï¼Œè¿™è¡¨ç¤º `resultFuture` å·²ç»è¢«å®Œæˆäº†ã€‚

```java
// complete() æ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œåç»­è°ƒç”¨å°†è¢«å¿½ç•¥ã€‚
resultFuture.complete(rpcResponse);
```

ä½ å¯ä»¥é€šè¿‡ `isDone()` æ–¹æ³•æ¥æ£€æŸ¥æ˜¯å¦å·²ç»å®Œæˆã€‚

```java
public boolean isDone() {
    return result != null;
}
```

è·å–å¼‚æ­¥è®¡ç®—çš„ç»“æœä¹Ÿéå¸¸ç®€å•ï¼Œç›´æ¥è°ƒç”¨ `get()` æ–¹æ³•å³å¯ã€‚è°ƒç”¨ `get()` æ–¹æ³•çš„çº¿ç¨‹ä¼šé˜»å¡ç›´åˆ° `CompletableFuture` å®Œæˆè¿ç®—ã€‚

```java
rpcResponse = completableFuture.get();
```

å¦‚æœä½ å·²ç»çŸ¥é“è®¡ç®—çš„ç»“æœçš„è¯ï¼Œå¯ä»¥ä½¿ç”¨é™æ€æ–¹æ³• `completedFuture()` æ¥åˆ›å»º `CompletableFuture` ã€‚

```java
CompletableFuture<String> future = CompletableFuture.completedFuture("hello!");
assertEquals("hello!", future.get());
```

`completedFuture()` æ–¹æ³•åº•å±‚è°ƒç”¨çš„æ˜¯å¸¦å‚æ•°çš„ new æ–¹æ³•ï¼Œåªä¸è¿‡ï¼Œè¿™ä¸ªæ–¹æ³•ä¸å¯¹å¤–æš´éœ²ã€‚

```java
public static <U> CompletableFuture<U> completedFuture(U value) {
    return new CompletableFuture<U>((value == null) ? NIL : value);
}
```

### 2.1.2 é™æ€å·¥å‚æ–¹æ³•

è¿™ä¸¤ä¸ªæ–¹æ³•å¯ä»¥å¸®åŠ©æˆ‘ä»¬å°è£…è®¡ç®—é€»è¾‘ã€‚

```java
static <U> CompletableFuture<U> supplyAsync(Supplier<U> supplier);
// ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± (æ¨è)
static <U> CompletableFuture<U> supplyAsync(Supplier<U> supplier, Executor executor);
static CompletableFuture<Void> runAsync(Runnable runnable);
// ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± (æ¨è)
static CompletableFuture<Void> runAsync(Runnable runnable, Executor executor);
```

- `runAsync()` æ–¹æ³•æ¥å—çš„å‚æ•°æ˜¯ `Runnable` ï¼Œè¿™æ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œä¸å…è®¸è¿”å›å€¼ã€‚å½“ä½ éœ€è¦å¼‚æ­¥æ“ä½œä¸”ä¸å…³å¿ƒè¿”å›ç»“æœçš„æ—¶å€™å¯ä»¥ä½¿ç”¨ `runAsync()` æ–¹æ³•ã€‚

```java
@FunctionalInterface
public interface Runnable {
    public abstract void run();
}
```

- `supplyAsync()` æ–¹æ³•æ¥å—çš„å‚æ•°æ˜¯ `Supplier<U>` ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œ`U` æ˜¯è¿”å›ç»“æœå€¼çš„ç±»å‹ã€‚

```java
@FunctionalInterface
public interface Supplier<T> {

    /**
     * Gets a result.
     *
     * @return a result
     */
    T get();
}
```

å½“ä½ éœ€è¦å¼‚æ­¥æ“ä½œä¸”å…³å¿ƒè¿”å›ç»“æœçš„æ—¶å€™,å¯ä»¥ä½¿ç”¨ `supplyAsync()` æ–¹æ³•ã€‚

```java
CompletableFuture<Void> future = CompletableFuture.runAsync(() -> System.out.println("hello!"));
future.get();// è¾“å‡º "hello!"
CompletableFuture<String> future2 = CompletableFuture.supplyAsync(() -> "hello!");
assertEquals("hello!", future2.get());
```

## 2.2 å¤„ç†å¼‚æ­¥ç»“ç®—çš„ç»“æœ

å½“æˆ‘ä»¬è·å–åˆ°å¼‚æ­¥è®¡ç®—çš„ç»“æœä¹‹åï¼Œè¿˜å¯ä»¥å¯¹å…¶è¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„æ–¹æ³•æœ‰ä¸‹é¢å‡ ä¸ªï¼š

- `thenApply()`
- `thenAccept()`
- `thenRun()`
- `whenComplete()`

### 2.2.1 thenApply()æ–¹æ³•

`thenApply()` æ–¹æ³•æ¥å—ä¸€ä¸ª `Function` å®ä¾‹ï¼Œç”¨å®ƒæ¥å¤„ç†ç»“æœã€‚

```java
// æ²¿ç”¨ä¸Šä¸€ä¸ªä»»åŠ¡çš„çº¿ç¨‹æ± 
public <U> CompletableFuture<U> thenApply(
    Function<? super T,? extends U> fn) {
    return uniApplyStage(null, fn);
}

//ä½¿ç”¨é»˜è®¤çš„ ForkJoinPool çº¿ç¨‹æ± ï¼ˆä¸æ¨èï¼‰
public <U> CompletableFuture<U> thenApplyAsync(
    Function<? super T,? extends U> fn) {
    return uniApplyStage(defaultExecutor(), fn);
}
// ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± (æ¨è)
public <U> CompletableFuture<U> thenApplyAsync(
    Function<? super T,? extends U> fn, Executor executor) {
    return uniApplyStage(screenExecutor(executor), fn);
}
```

`thenApply()` æ–¹æ³•ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š

```java
CompletableFuture<String> future = CompletableFuture.completedFuture("hello!")
        .thenApply(s -> s + "world!");
assertEquals("hello!world!", future.get());
// è¿™æ¬¡è°ƒç”¨å°†è¢«å¿½ç•¥ã€‚
future.thenApply(s -> s + "nice!");
assertEquals("hello!world!", future.get());
```

ä½ è¿˜å¯ä»¥è¿›è¡Œ **æµå¼è°ƒç”¨**ï¼š

```java
CompletableFuture<String> future = CompletableFuture.completedFuture("hello!")
        .thenApply(s -> s + "world!").thenApply(s -> s + "nice!");
assertEquals("hello!world!nice!", future.get());
```

### 2.2.2 thenAccept() å’Œ thenRun()æ–¹æ³•

**å¦‚æœä½ ä¸éœ€è¦ä»å›è°ƒå‡½æ•°ä¸­è·å–è¿”å›ç»“æœï¼Œå¯ä»¥ä½¿ç”¨ `thenAccept()` æˆ–è€… `thenRun()`ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•çš„åŒºåˆ«åœ¨äº `thenRun()` ä¸èƒ½è®¿é—®å¼‚æ­¥è®¡ç®—çš„ç»“æœã€‚**

> **thenAccept()æ–¹æ³•**

`thenAccept()` æ–¹æ³•çš„å‚æ•°æ˜¯ `Consumer<? super T>` ã€‚

```java
public CompletableFuture<Void> thenAccept(Consumer<? super T> action) {
    return uniAcceptStage(null, action);
}

public CompletableFuture<Void> thenAcceptAsync(Consumer<? super T> action) {
    return uniAcceptStage(defaultExecutor(), action);
}

public CompletableFuture<Void> thenAcceptAsync(Consumer<? super T> action,
                                               Executor executor) {
    return uniAcceptStage(screenExecutor(executor), action);
}
```

é¡¾åæ€ä¹‰ï¼Œ`Consumer` å±äºæ¶ˆè´¹å‹æ¥å£ï¼Œå®ƒå¯ä»¥æ¥æ”¶ 1 ä¸ªè¾“å…¥å¯¹è±¡ç„¶åè¿›è¡Œâ€œæ¶ˆè´¹â€ã€‚

```java
@FunctionalInterface
public interface Consumer<T> {

    void accept(T t);

    default Consumer<T> andThen(Consumer<? super T> after) {
        Objects.requireNonNull(after);
        return (T t) -> { accept(t); after.accept(t); };
    }
}
```

> **thenRun()æ–¹æ³•**

`thenRun()` çš„æ–¹æ³•æ˜¯çš„å‚æ•°æ˜¯ `Runnable` ã€‚

```java
public CompletableFuture<Void> thenRun(Runnable action) {
    return uniRunStage(null, action);
}

public CompletableFuture<Void> thenRunAsync(Runnable action) {
    return uniRunStage(defaultExecutor(), action);
}

public CompletableFuture<Void> thenRunAsync(Runnable action,
                                            Executor executor) {
    return uniRunStage(screenExecutor(executor), action);
}
```

> **`thenAccept()` å’Œ `thenRun()` ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹**

```java
CompletableFuture.completedFuture("hello!")
        .thenApply(s -> s + "world!").thenApply(s -> s + "nice!").thenAccept(System.out::println);//hello!world!nice!

CompletableFuture.completedFuture("hello!")
        .thenApply(s -> s + "world!").thenApply(s -> s + "nice!").thenRun(() -> System.out.println("hello!"));//hello!
```

### 2.2.3 whenComplete()

`whenComplete()` çš„æ–¹æ³•çš„å‚æ•°æ˜¯ `BiConsumer<? super T, ? super Throwable>` ã€‚

```java
public CompletableFuture<T> whenComplete(
    BiConsumer<? super T, ? super Throwable> action) {
    return uniWhenCompleteStage(null, action);
}


public CompletableFuture<T> whenCompleteAsync(
    BiConsumer<? super T, ? super Throwable> action) {
    return uniWhenCompleteStage(defaultExecutor(), action);
}
// ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± (æ¨è)
public CompletableFuture<T> whenCompleteAsync(
    BiConsumer<? super T, ? super Throwable> action, Executor executor) {
    return uniWhenCompleteStage(screenExecutor(executor), action);
}
```

ç›¸å¯¹äº `Consumer` ï¼Œ `BiConsumer` å¯ä»¥æ¥æ”¶ 2 ä¸ªè¾“å…¥å¯¹è±¡ç„¶åè¿›è¡Œâ€œæ¶ˆè´¹â€ã€‚

```java
@FunctionalInterface
public interface BiConsumer<T, U> {
    void accept(T t, U u);

    default BiConsumer<T, U> andThen(BiConsumer<? super T, ? super U> after) {
        Objects.requireNonNull(after);

        return (l, r) -> {
            accept(l, r);
            after.accept(l, r);
        };
    }
}
```

> `whenComplete()` ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š

```java
CompletableFuture<String> future = CompletableFuture.supplyAsync(() -> "hello!")
        .whenComplete((res, ex) -> {
            // res ä»£è¡¨è¿”å›çš„ç»“æœ
            // ex çš„ç±»å‹ä¸º Throwable ï¼Œä»£è¡¨æŠ›å‡ºçš„å¼‚å¸¸
            System.out.println(res);
            // è¿™é‡Œæ²¡æœ‰æŠ›å‡ºå¼‚å¸¸æ‰€æœ‰ä¸º null
            assertNull(ex);
        });
assertEquals("hello!", future.get());
```

## 2.3 å¼‚å¸¸å¤„ç†

### 2.3.1 ä½¿ç”¨handle()æ–¹æ³•å¤„ç†å¼‚å¸¸

ä½ å¯ä»¥é€šè¿‡ `handle()` æ–¹æ³•æ¥å¤„ç†ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°çš„æŠ›å‡ºå¼‚å¸¸çš„æƒ…å†µã€‚

```java
public <U> CompletableFuture<U> handle(
    BiFunction<? super T, Throwable, ? extends U> fn) {
    return uniHandleStage(null, fn);
}

public <U> CompletableFuture<U> handleAsync(
    BiFunction<? super T, Throwable, ? extends U> fn) {
    return uniHandleStage(defaultExecutor(), fn);
}

public <U> CompletableFuture<U> handleAsync(
    BiFunction<? super T, Throwable, ? extends U> fn, Executor executor) {
    return uniHandleStage(screenExecutor(executor), fn);
}
```

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
CompletableFuture<String> future
        = CompletableFuture.supplyAsync(() -> {
    if (true) {
        throw new RuntimeException("Computation error!");
    }
    return "hello!";
}).handle((res, ex) -> {
    // res ä»£è¡¨è¿”å›çš„ç»“æœ
    // ex çš„ç±»å‹ä¸º Throwable ï¼Œä»£è¡¨æŠ›å‡ºçš„å¼‚å¸¸
    return res != null ? res : "world!";
});
assertEquals("world!", future.get());
```

### 2.3.2 é€šè¿‡exceptionally()æ–¹æ³•å¤„ç†å¼‚å¸¸

ä½ è¿˜å¯ä»¥é€šè¿‡ `exceptionally()` æ–¹æ³•æ¥å¤„ç†å¼‚å¸¸æƒ…å†µã€‚

```java
CompletableFuture<String> future
        = CompletableFuture.supplyAsync(() -> {
    if (true) {
        throw new RuntimeException("Computation error!");
    }
    return "hello!";
}).exceptionally(ex -> {
    System.out.println(ex.toString());// CompletionException
    return "world!";
});
assertEquals("world!", future.get());
```

å¦‚æœä½ æƒ³è®© `CompletableFuture` çš„ç»“æœå°±æ˜¯å¼‚å¸¸çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ `completeExceptionally()` æ–¹æ³•ä¸ºå…¶èµ‹å€¼ã€‚

```java
CompletableFuture<String> completableFuture = new CompletableFuture<>();
// ...
completableFuture.completeExceptionally(
  new RuntimeException("Calculation failed!"));
// ...
completableFuture.get(); // ExecutionException
```

## 2.4 ç»„åˆ CompletableFuture

ä½ å¯ä»¥ä½¿ç”¨ `thenCompose()` æŒ‰é¡ºåºé“¾æ¥ä¸¤ä¸ª `CompletableFuture` å¯¹è±¡ã€‚

```java
public <U> CompletableFuture<U> thenCompose(
    Function<? super T, ? extends CompletionStage<U>> fn) {
    return uniComposeStage(null, fn);
}

public <U> CompletableFuture<U> thenComposeAsync(
    Function<? super T, ? extends CompletionStage<U>> fn) {
    return uniComposeStage(defaultExecutor(), fn);
}

public <U> CompletableFuture<U> thenComposeAsync(
    Function<? super T, ? extends CompletionStage<U>> fn,
    Executor executor) {
    return uniComposeStage(screenExecutor(executor), fn);
}
```

> `thenCompose()` æ–¹æ³•ä¼šä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š

```java
CompletableFuture<String> future
        = CompletableFuture.supplyAsync(() -> "hello!")
        .thenCompose(s -> CompletableFuture.supplyAsync(() -> s + "world!"));
assertEquals("hello!world!", future.get());
```

åœ¨å®é™…å¼€å‘ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•è¿˜æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬å…ˆè¦è·å–ç”¨æˆ·ä¿¡æ¯ç„¶åå†ç”¨ç”¨æˆ·ä¿¡æ¯å»åšå…¶ä»–äº‹æƒ…ã€‚

å’Œ `thenCompose()` æ–¹æ³•ç±»ä¼¼çš„è¿˜æœ‰ `thenCombine()` æ–¹æ³•ï¼Œ `thenCombine()` åŒæ ·å¯ä»¥ç»„åˆä¸¤ä¸ª `CompletableFuture` å¯¹è±¡ã€‚

```java
CompletableFuture<String> completableFuture
        = CompletableFuture.supplyAsync(() -> "hello!")
        .thenCombine(CompletableFuture.supplyAsync(
                () -> "world!"), (s1, s2) -> s1 + s2)
        .thenCompose(s -> CompletableFuture.supplyAsync(() -> s + "nice!"));
assertEquals("hello!world!nice!", completableFuture.get());
```

> **é‚£ `thenCompose()` å’Œ `thenCombine()` æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ**

- `thenCompose()` å¯ä»¥ä¸¤ä¸ª `CompletableFuture` å¯¹è±¡ï¼Œå¹¶å°†å‰ä¸€ä¸ªä»»åŠ¡çš„è¿”å›ç»“æœä½œä¸ºä¸‹ä¸€ä¸ªä»»åŠ¡çš„å‚æ•°ï¼Œå®ƒä»¬ä¹‹é—´å­˜åœ¨ç€å…ˆåé¡ºåºã€‚
- `thenCombine()` ä¼šåœ¨ä¸¤ä¸ªä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆåï¼ŒæŠŠä¸¤ä¸ªä»»åŠ¡çš„ç»“æœåˆå¹¶ã€‚ä¸¤ä¸ªä»»åŠ¡æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œå®ƒä»¬ä¹‹é—´å¹¶æ²¡æœ‰å…ˆåä¾èµ–é¡ºåºã€‚

## 2.5 å¹¶è¡Œè¿è¡Œå¤šä¸ª CompletableFuture

ä½ å¯ä»¥é€šè¿‡ `CompletableFuture` çš„ `allOf()`è¿™ä¸ªé™æ€æ–¹æ³•æ¥å¹¶è¡Œè¿è¡Œå¤šä¸ª `CompletableFuture` ã€‚

å®é™…é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å¹¶è¡Œè¿è¡Œå¤šä¸ªäº’ä¸ç›¸å…³çš„ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡ä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œå¯ä»¥äº’ç›¸ç‹¬ç«‹åœ°è¿è¡Œã€‚

æ¯”è¯´æˆ‘ä»¬è¦è¯»å–å¤„ç† 6 ä¸ªæ–‡ä»¶ï¼Œè¿™ 6 ä¸ªä»»åŠ¡éƒ½æ˜¯æ²¡æœ‰æ‰§è¡Œé¡ºåºä¾èµ–çš„ä»»åŠ¡ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦è¿”å›ç»™ç”¨æˆ·çš„æ—¶å€™å°†è¿™å‡ ä¸ªæ–‡ä»¶çš„å¤„ç†çš„ç»“æœè¿›è¡Œç»Ÿè®¡æ•´ç†ã€‚åƒè¿™ç§æƒ…å†µæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å¹¶è¡Œè¿è¡Œå¤šä¸ª `CompletableFuture` æ¥å¤„ç†ã€‚

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
CompletableFuture<Void> task1 =
  CompletableFuture.supplyAsync(()->{
    //è‡ªå®šä¹‰ä¸šåŠ¡æ“ä½œ
  });
......
CompletableFuture<Void> task6 =
  CompletableFuture.supplyAsync(()->{
    //è‡ªå®šä¹‰ä¸šåŠ¡æ“ä½œ
  });
......
 CompletableFuture<Void> headerFuture=CompletableFuture.allOf(task1,.....,task6);

  try {
    headerFuture.join();
  } catch (Exception ex) {
    ......
  }
System.out.println("all done. ");
```

ç»å¸¸å’Œ `allOf()` æ–¹æ³•æ‹¿æ¥å¯¹æ¯”çš„æ˜¯ `anyOf()` æ–¹æ³•ã€‚

**`allOf()` æ–¹æ³•ä¼šç­‰åˆ°æ‰€æœ‰çš„ `CompletableFuture` éƒ½è¿è¡Œå®Œæˆä¹‹åå†è¿”å›**

```java
Random rand = new Random();
CompletableFuture<String> future1 = CompletableFuture.supplyAsync(() -> {
    try {
        Thread.sleep(1000 + rand.nextInt(1000));
    } catch (InterruptedException e) {
        e.printStackTrace();
    } finally {
        System.out.println("future1 done...");
    }
    return "abc";
});
CompletableFuture<String> future2 = CompletableFuture.supplyAsync(() -> {
    try {
        Thread.sleep(1000 + rand.nextInt(1000));
    } catch (InterruptedException e) {
        e.printStackTrace();
    } finally {
        System.out.println("future2 done...");
    }
    return "efg";
});
```

è°ƒç”¨ `join()` å¯ä»¥è®©ç¨‹åºç­‰`future1` å’Œ `future2` éƒ½è¿è¡Œå®Œäº†ä¹‹åå†ç»§ç»­æ‰§è¡Œã€‚

```java
CompletableFuture<Void> completableFuture = CompletableFuture.allOf(future1, future2);
completableFuture.join();
assertTrue(completableFuture.isDone());
System.out.println("all futures done...");
```

è¾“å‡ºï¼š

```java
future1 done...
future2 done...
all futures done...
```

**`anyOf()` æ–¹æ³•ä¸ä¼šç­‰å¾…æ‰€æœ‰çš„ `CompletableFuture` éƒ½è¿è¡Œå®Œæˆä¹‹åå†è¿”å›ï¼Œåªè¦æœ‰ä¸€ä¸ªæ‰§è¡Œå®Œæˆå³å¯ï¼**

```java
CompletableFuture<Object> f = CompletableFuture.anyOf(future1, future2);
System.out.println(f.get());
```

è¾“å‡ºç»“æœå¯èƒ½æ˜¯ï¼š

```java
future2 done...
efg
```

ä¹Ÿå¯èƒ½æ˜¯ï¼š

```
future1 done...
abc
```

## åè®°

è¿™ç¯‡æ–‡ç« åªæ˜¯ç®€å•ä»‹ç»äº† `CompletableFuture` æ¯”è¾ƒå¸¸ç”¨çš„ä¸€äº› API ã€‚

å¦‚æœæƒ³è¦æ·±å…¥å­¦ä¹ çš„è¯ï¼Œå¯ä»¥å¤šæ‰¾ä¸€äº›ä¹¦ç±å’Œåšå®¢çœ‹ã€‚