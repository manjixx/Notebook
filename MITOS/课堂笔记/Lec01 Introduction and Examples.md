# Lecture 01 Introduction and Examples(Robert)

## 1.1 è¯¾ç¨‹å†…å®¹ç®€ä»‹

> **è¯¾ç¨‹ç›®æ ‡**

- O/S DESIGN
- HANDS-ON EXP

> **O/S PURPOSE**

- ABSTRACT H/W:æŠ½è±¡ç¡¬ä»¶
- MULTIPLEX:å¤ç”¨ç¡¬ä»¶
- ISOLATION:å¤šä¸ªç¨‹åºä»¶äº’ä¸å¹²æ‰°
- SHARING
- SECURITY/PERMISSION SYSTEM/ACCESS CONTROL
- GOOD PERFORMANCE
- RANGE OF USER

## 1.2 æ“ä½œç³»ç»Ÿç»“æ„

> **O/S ORAGNIZATION**

- USERSPACE:ç”¨æˆ·ç©ºé—´ï¼Œè¿è¡Œå„ç§å„æ ·çš„åº”ç”¨ç¨‹åºï¼Œå¦‚æ–‡æœ¬ç¼–è¾‘å™¨viï¼ŒCç¼–è¯‘å™¨(cc)
- KERNAL: è®¡ç®—æœºèµ„æºå®ˆæŠ¤è€…ï¼Œä¸»è¦å…³æ³¨ç‚¹åœ¨Kernelã€è¿æ¥Kernalå’Œç”¨æˆ·ç©ºé—´ç¨‹åºçš„æ¥å£ã€Kernelå†…è½¯ä»¶çš„æ¶æ„ã€‚
  - å½“å¯åŠ¨è®¡ç®—æœºæ—¶ï¼ŒKernelæ€»æ˜¯ç¬¬ä¸€ä¸ªè¢«å¯åŠ¨ã€‚Kernelç¨‹åºåªæœ‰ä¸€ä¸ªï¼Œå®ƒç»´æŠ¤æ•°æ®æ¥ç®¡ç†æ¯ä¸€ä¸ªç”¨æˆ·ç©ºé—´è¿›ç¨‹ã€‚KernelåŒæ—¶è¿˜ç»´æŠ¤äº†å¤§é‡çš„æ•°æ®ç»“æ„æ¥å¸®åŠ©å®ƒç®¡ç†å„ç§å„æ ·çš„ç¡¬ä»¶èµ„æºï¼Œä»¥ä¾›ç”¨æˆ·ç©ºé—´çš„ç¨‹åºä½¿ç”¨ã€‚KernelåŒæ—¶è¿˜æœ‰å¤§é‡å†…ç½®çš„æœåŠ¡ã€‚
  - FS:æ–‡ä»¶ç³»ç»Ÿé€šå¸¸æœ‰ä¸€äº›é€»è¾‘åˆ†åŒºã€‚ç›®å‰è€Œè¨€ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºæ–‡ä»¶ç³»ç»Ÿçš„ä½œç”¨æ˜¯ç®¡ç†æ–‡ä»¶å†…å®¹å¹¶æ‰¾å‡ºæ–‡ä»¶å…·ä½“åœ¨ç£ç›˜ä¸­çš„å“ªä¸ªä½ç½®ã€‚æ–‡ä»¶ç³»ç»Ÿè¿˜ç»´æŠ¤äº†ä¸€ä¸ªç‹¬ç«‹çš„å‘½åç©ºé—´ï¼Œå…¶ä¸­æ¯ä¸ªæ–‡ä»¶éƒ½æœ‰æ–‡ä»¶åï¼Œå¹¶ä¸”å‘½åç©ºé—´ä¸­æœ‰ä¸€ä¸ªå±‚çº§çš„ç›®å½•ï¼Œæ¯ä¸ªç›®å½•åŒ…å«äº†ä¸€äº›æ–‡ä»¶ã€‚æ‰€æœ‰è¿™äº›éƒ½è¢«æ–‡ä»¶ç³»ç»Ÿæ‰€ç®¡ç†ã€‚
  - PROCESS:è¿›ç¨‹ç®¡ç†ç³»ç»Ÿã€‚æ¯ä¸€ä¸ªç”¨æˆ·ç©ºé—´ç¨‹åºéƒ½è¢«ç§°ä¸ºä¸€ä¸ªè¿›ç¨‹ï¼Œå®ƒä»¬æœ‰è‡ªå·±çš„å†…å­˜å’Œå…±äº«çš„CPUæ—¶é—´ã€‚
  - MEM,ALLCO:ç®¡ç†å†…å­˜çš„åˆ†é…ã€‚ä¸åŒçš„è¿›ç¨‹éœ€è¦ä¸åŒæ•°é‡çš„å†…å­˜ï¼ŒKernelä¼šå¤ç”¨å†…å­˜ã€åˆ’åˆ†å†…å­˜ï¼Œå¹¶ä¸ºæ‰€æœ‰çš„è¿›ç¨‹åˆ†é…å†…å­˜ã€‚
  - ACCESS CTL:å½“ä¸€ä¸ªè¿›ç¨‹æƒ³è¦ä½¿ç”¨æŸäº›èµ„æºæ—¶ï¼Œæ¯”å¦‚è¯»å–ç£ç›˜ä¸­çš„æ•°æ®ï¼Œä½¿ç”¨æŸäº›å†…å­˜ï¼ŒKernelä¸­çš„Access Controlæœºåˆ¶ä¼šå†³å®šæ˜¯å¦å…è®¸è¿™æ ·çš„æ“ä½œã€‚
- ç¡¬ä»¶åº•å±‚èµ„æº:CPUã€RAMã€DISKã€NET

![](https://906337931-files.gitbook.io/~/files/v0/b/gitbook-legacy-files/o/assets%2F-MHZoT2b_bcLghjAOPsJ%2F-MH_0vtckm44OL-Ry80u%2F-MHfa6qidpjQGh_XpuRm%2Fimage.png?alt=media&token=13f0cc46-16b5-4e7e-bfc6-498ff3c6449a)

> **API-KERNAL**

Kernelçš„APIï¼Œå®ƒå†³å®šäº†åº”ç”¨ç¨‹åºå¦‚ä½•è®¿é—®Kernelã€‚

- system call: é€šè¿‡æ‰€è°“çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆSystem Callï¼‰æ¥å®Œæˆã€‚ç³»ç»Ÿè°ƒç”¨ä¸ç¨‹åºä¸­çš„å‡½æ•°è°ƒç”¨çœ‹èµ·æ¥æ˜¯ä¸€æ ·çš„ï¼Œä½†åŒºåˆ«æ˜¯ç³»ç»Ÿè°ƒç”¨ä¼šå®é™…è¿è¡Œåˆ°ç³»ç»Ÿå†…æ ¸ä¸­ï¼Œå¹¶æ‰§è¡Œå†…æ ¸ä¸­å¯¹äºç³»ç»Ÿè°ƒç”¨çš„å®ç°ã€‚

- ğŸ™‹ğŸŒ°: `fd = open("out",1)`
  - `open`æ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œopenä¼šè·³è½¬åˆ°Kernelï¼ŒKernelå¯ä»¥è·å–åˆ°openå‚æ•°ï¼Œæ‰§è¡Œä¸€äº›å®ç°opençš„kernelä»£ç ï¼Œæœ€åè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å¯¹è±¡
  - `fd`å…¨ç§°ä¸º`file descriptor`,åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ä½œä¸ºhandleï¼Œæ¥è¡¨ç¤ºç›¸åº”æ‰“å¼€çš„æ–‡ä»¶ã€‚
- ğŸ™‹ğŸŒ° `write(fd,"hello\n",6)`:å‘æ–‡ä»¶å†™å…¥æ•°æ®
  - å‘writeä¼ é€’ä¸€ä¸ªç”±openè¿”å›çš„æ–‡ä»¶æè¿°ç¬¦ä½œä¸ºå‚æ•°ã€‚
  - å‘writeä¼ é€’ä¸€ä¸ªæŒ‡å‘è¦å†™å…¥æ•°æ®çš„æŒ‡é’ˆï¼ˆæ•°æ®é€šå¸¸æ˜¯charå‹åºåˆ—ï¼‰,å®é™…ä¸Šæ˜¯å†…å­˜ä¸­çš„åœ°å€ã€‚æ‰€ä»¥è¿™é‡Œå®é™…ä¸Šå‘Šè¯‰å†…æ ¸ï¼Œå°†å†…å­˜ä¸­è¿™ä¸ªåœ°å€èµ·å§‹çš„6ä¸ªå­—èŠ‚æ•°æ®å†™å…¥åˆ°fdå¯¹åº”çš„æ–‡ä»¶ä¸­ã€‚
  - æƒ³è¦å†™å…¥å­—ç¬¦çš„æ•°é‡
- ğŸ™‹ğŸŒ° `pid = fork();`
  - åˆ›å»ºäº†ä¸€ä¸ªä¸è°ƒç”¨è¿›ç¨‹ä¸€æ¨¡ä¸€æ ·çš„æ–°çš„è¿›ç¨‹ï¼Œå¹¶è¿”å›æ–°è¿›ç¨‹çš„process ID/pid

> **Q:ç³»ç»Ÿè°ƒç”¨å’Œç¨‹åºé‡Œçš„å‡½æ•°çš„åŒºåˆ«ï¼Ÿ**

Robertæ•™æˆï¼šKernelçš„ä»£ç æ€»æ˜¯æœ‰ç‰¹æ®Šçš„æƒé™ã€‚å½“æœºå™¨å¯åŠ¨Kernelæ—¶ï¼ŒKernelä¼šæœ‰ç‰¹æ®Šçš„æƒé™èƒ½ç›´æ¥è®¿é—®å„ç§å„æ ·çš„ç¡¬ä»¶ï¼Œä¾‹å¦‚ç£ç›˜ã€‚è€Œæ™®é€šçš„ç”¨æˆ·ç¨‹åºæ˜¯æ²¡æœ‰åŠæ³•ç›´æ¥è®¿é—®è¿™äº›ç¡¬ä»¶çš„ã€‚æ‰€ä»¥ï¼Œå½“ä½ æ‰§è¡Œä¸€ä¸ªæ™®é€šçš„å‡½æ•°è°ƒç”¨æ—¶ï¼Œä½ æ‰€è°ƒç”¨çš„å‡½æ•°å¹¶æ²¡æœ‰å¯¹äºç¡¬ä»¶çš„ç‰¹æ®Šæƒé™ã€‚ç„¶è€Œï¼Œå¦‚æœä½ è§¦å‘ç³»ç»Ÿè°ƒç”¨åˆ°å†…æ ¸ä¸­ï¼Œå†…æ ¸ä¸­çš„å…·ä½“å®ç°ä¼šå…·æœ‰è¿™äº›ç‰¹æ®Šçš„æƒé™ï¼Œè¿™æ ·å°±èƒ½ä¿®æ”¹æ•æ„Ÿçš„å’Œè¢«ä¿æŠ¤çš„ç¡¬ä»¶èµ„æºï¼Œæ¯”å¦‚è®¿é—®ç¡¬ä»¶ç£ç›˜ã€‚æˆ‘ä»¬ä¹‹åä¼šä»‹ç»æ›´å¤šæœ‰å…³çš„ç»†èŠ‚ã€‚

## 1.3 WHY HARD/INTERESTING?
  
- UNFORGNING:å†…æ ¸ç¼–ç¨‹ç¯å¢ƒè¾ƒä¸ºå¤æ‚å›°éš¾
- TENSIONS
  - EFFICIENT vs ABSTRACT
  - POWERFUL vs SIMPLE
  - FLEXIBLE vs SECURITY
- INTERACTION:ç³»ç»Ÿæä¾›æœåŠ¡é—´çš„äº¤äº’
  - `fd = open()`ä¸ `pid = fork()`

> **è¯¾ç¨‹ç¯å¢ƒ**

- OS-XV6 ç±»unixæ“ä½œç³»ç»Ÿ
- RISC-V å¾®å¤„ç†å™¨ï¼ŒRISC-VæŒ‡ä»¤é›†
- QEMUç¡¬ä»¶ä»¿çœŸï¼Œæ¨¡æ‹ŸRISC-V

```zsh
make clean
make qemu
```

## 1.4 ç³»ç»Ÿè°ƒç”¨

XV6ä¹¦ç±çš„ç¬¬äºŒç« æœ‰ä¸€ä¸ªè¡¨æ ¼ï¼Œåˆ—ä¸¾äº†æ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°å’Œè¿”å›å€¼ã€‚

```zsh
cd xv6-riscv

// æ¸…é™¤ç¼–è¯‘
make clean

// ç¼–è¯‘
make qemu
```

### 1.4.1 read, write, exitç³»ç»Ÿè°ƒç”¨

```c
// copy.c:copy input to output

# include "kernel/types.h"
# include "user/user.h"

int 
main()
{
    char buf[64];
    
    while(1){
        int n = read(0,buf,sizeof(buf));
        if(n <= 0){
            break;
        }
        write(1,buf,n);
    }
    exit(0);
}
```

è¿™ä¸ªç¨‹åºé‡Œé¢æ‰§è¡Œäº†3ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œåˆ†åˆ«æ˜¯readï¼Œwriteå’Œexitã€‚

> **read**

readç³»ç»Ÿè°ƒç”¨æ¥æ”¶3ä¸ªå‚æ•°:

- ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯**æ–‡ä»¶æè¿°ç¬¦**ï¼ŒæŒ‡å‘ä¸€ä¸ªä¹‹å‰æ‰“å¼€çš„æ–‡ä»¶ã€‚
  - é»˜è®¤æƒ…å†µä¸‹ï¼Œæ–‡ä»¶æè¿°ç¬¦0è¿æ¥åˆ°consoleçš„è¾“å…¥ï¼Œæ–‡ä»¶æè¿°ç¬¦1è¿æ¥åˆ°äº†consoleçš„è¾“å‡ºã€‚
  - è¿™é‡Œçš„0ï¼Œ1æ–‡ä»¶æè¿°ç¬¦æ˜¯éå¸¸æ™®éçš„Unixé£æ ¼ï¼Œè®¸å¤šçš„Unixç³»ç»Ÿéƒ½ä¼šä»æ–‡ä»¶æè¿°ç¬¦0è¯»å–æ•°æ®ï¼Œç„¶åå‘æ–‡ä»¶æè¿°ç¬¦1å†™å…¥æ•°æ®ã€‚
- ç¬¬äºŒä¸ªå‚æ•°æ˜¯**æŒ‡å‘æŸæ®µå†…å­˜çš„æŒ‡é’ˆ**ï¼Œç¨‹åºå¯ä»¥é€šè¿‡æŒ‡é’ˆå¯¹åº”çš„åœ°å€è¯»å–å†…å­˜ä¸­çš„æ•°æ®ï¼Œè¿™é‡Œçš„æŒ‡é’ˆå°±æ˜¯ä»£ç ä¸­çš„bufå‚æ•°ã€‚
  - åœ¨ä»£ç ç¬¬10è¡Œï¼Œç¨‹åºåœ¨æ ˆé‡Œé¢ç”³è¯·äº†64å­—èŠ‚çš„å†…å­˜ï¼Œå¹¶å°†æŒ‡é’ˆä¿å­˜åœ¨bufä¸­ï¼Œè¿™æ ·readå¯ä»¥å°†æ•°æ®ä¿å­˜åœ¨è¿™64å­—èŠ‚ä¸­ã€‚
- ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä»£ç **è¯»å–çš„æœ€å¤§é•¿åº¦**ï¼Œsizeof(buf)è¡¨ç¤ºï¼Œæœ€å¤šè¯»å–64å­—èŠ‚çš„æ•°æ®ã€‚readæœ€å¤šåªèƒ½ä»è¿æ¥åˆ°æ–‡ä»¶æè¿°ç¬¦0çš„è®¾å¤‡ï¼Œä¹Ÿå°±æ˜¯consoleä¸­ï¼Œè¯»å–64å­—èŠ‚çš„æ•°æ®ã€‚

readçš„è¿”å›å€¼:å¯èƒ½æ˜¯è¯»åˆ°çš„å­—èŠ‚æ•°

- readå¯èƒ½ä»ä¸€ä¸ªæ–‡ä»¶è¯»æ•°æ®ï¼Œå¦‚æœåˆ°è¾¾äº†æ–‡ä»¶çš„ç»“å°¾æ²¡æœ‰æ›´å¤šçš„å†…å®¹äº†
- readä¼šè¿”å›0ã€‚å¦‚æœå‡ºç°äº†ä¸€äº›é”™è¯¯ï¼Œæ¯”å¦‚æ–‡ä»¶æè¿°ç¬¦ä¸å­˜åœ¨ï¼Œreadæˆ–è®¸ä¼šè¿”å›-1
- ç³»ç»Ÿè°ƒç”¨é€šå¸¸æ˜¯é€šè¿‡è¿”å›-1æ¥è¡¨ç¤ºé”™è¯¯ï¼Œä»£ç ç¼–å†™è¿‡ç¨‹ä¸­åº”è¯¥æ£€æŸ¥æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ä»¥ç¡®ä¿æ²¡æœ‰é”™è¯¯

âš ï¸**æ³¨æ„ï¼š** copyç¨‹åºï¼Œæˆ–è€…è¯´readï¼Œwriteç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒä»¬å¹¶ä¸å…³å¿ƒè¯»å†™çš„æ•°æ®æ ¼å¼ï¼Œå®ƒä»¬å°±æ˜¯å•çº¯çš„è¯»å†™ï¼Œè€Œcopyç¨‹åºä¼šæŒ‰ç…§8bitçš„å­—èŠ‚æµå¤„ç†æ•°æ®ï¼Œå¦‚ä½•è§£æå®ƒä»¬ï¼Œå®Œå…¨æ˜¯ç”¨åº”ç”¨ç¨‹åºå†³å®šçš„ã€‚æ‰€ä»¥åº”ç”¨ç¨‹åºå¯èƒ½ä¼šè§£æè¿™é‡Œçš„æ•°æ®ä¸ºCè¯­è¨€ç¨‹åºï¼Œä½†æ˜¯æ“ä½œç³»ç»Ÿåªä¼šè®¤ä¸ºè¿™é‡Œçš„æ•°æ®æ˜¯æŒ‰ç…§8bitçš„å­—èŠ‚æµã€‚

> **Q:å¦‚æœreadçš„ç¬¬ä¸‰ä¸ªå‚æ•°è®¾ç½®æˆ1 + sizeof(buf)ä¼šæ€æ ·ï¼Ÿ**

Robertæ•™æˆï¼šå¦‚æœç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯65å­—èŠ‚ï¼Œæ“ä½œç³»ç»Ÿä¼šæ‹·è´65ä¸ªå­—èŠ‚åˆ°ä½ æä¾›çš„å†…å­˜ä¸­ï¼ˆç¬¬äºŒä¸ªå‚æ•°ï¼‰ã€‚ä½†æ˜¯å¦‚æœæ ˆä¸­çš„ç¬¬65ä¸ªå­—èŠ‚æœ‰ä¸€äº›å…¶ä»–æ•°æ®ï¼Œé‚£ä¹ˆè¿™äº›æ•°æ®ä¼šè¢«è¦†ç›–ï¼Œè¿™é‡Œæ˜¯ä¸ªbugï¼Œæˆ–è®¸ä¼šå¯¼è‡´ä½ çš„ä»£ç å´©æºƒï¼Œæˆ–è€…ä¸€äº›å¼‚å¸¸çš„è¡Œä¸ºã€‚æ‰€ä»¥ï¼Œä½œä¸ºä¸€ä¸ªç¨‹åºå‘˜ï¼Œä½ å¿…é¡»è¦å°å¿ƒã€‚Cè¯­è¨€å¾ˆå®¹æ˜“å†™å‡ºä¸€äº›ç¼–è¯‘å™¨èƒ½é€šè¿‡çš„ï¼Œä½†æ˜¯æœ€åè¿è¡Œæ—¶å‡ºé”™çš„ä»£ç ã€‚è™½ç„¶å¾ˆç³Ÿç³•ï¼Œä½†æ˜¯ç°å®å°±æ˜¯è¿™æ ·ã€‚

### 1.4.2 openç³»ç»Ÿè°ƒç”¨

æœ€ç›´æ¥çš„åˆ›å»ºæ–‡ä»¶æè¿°ç¬¦çš„æ–¹æ³•æ˜¯openç³»ç»Ÿè°ƒç”¨ã€‚

> **open.c**

opençš„ç¨‹åºï¼Œä¼šåˆ›å»ºä¸€ä¸ªå«åšoutput.txtçš„æ–°æ–‡ä»¶ï¼Œå¹¶å‘å®ƒå†™å…¥ä¸€äº›æ•°æ®ï¼Œæœ€åé€€å‡ºã€‚æˆ‘ä»¬çœ‹ä¸åˆ°ä»»ä½•è¾“å‡ºï¼Œå› ä¸ºå®ƒåªæ˜¯å‘æ‰“å¼€çš„æ–‡ä»¶ä¸­å†™å…¥æ•°æ®ã€‚

```c
// open.c: create a file,write to it

# include "kernel/types.h"
# include "user/user.h"
# include "kernel/fcntl.h"

int main(){
    int fd = open("output.txt",O_WRONLY | O_CREATE);
    write(fd,"ooo\n",4);
    exit(0);
}
```

```zsh
$ cat output.txt
ooo
```

> **openç³»ç»Ÿè°ƒç”¨**

openç³»ç»Ÿè°ƒç”¨å‚æ•°:

- ç¬¬ä¸€ä¸ªå‚æ•°:æ–‡ä»¶åoutput.txt
- ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€äº›æ ‡å¿—ä½ï¼Œç”¨æ¥å‘Šè¯‰openç³»ç»Ÿè°ƒç”¨åœ¨å†…æ ¸ä¸­çš„å®ç°ï¼šæˆ‘ä»¬å°†è¦åˆ›å»ºå¹¶å†™å…¥ä¸€ä¸ªæ–‡ä»¶

openç³»ç»Ÿè°ƒç”¨è¿”å›å€¼

- è¿”å›ä¸€ä¸ªæ–°åˆ†é…çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™é‡Œçš„æ–‡ä»¶æè¿°ç¬¦æ˜¯ä¸€ä¸ªå°çš„æ•°å­—ï¼Œå¯èƒ½æ˜¯2ï¼Œ3ï¼Œ4æˆ–è€…å…¶ä»–çš„æ•°å­—ã€‚

> **writeç³»ç»Ÿè°ƒç”¨**

æ–‡ä»¶æè¿°ç¬¦ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°è¢«ä¼ åˆ°äº†writeï¼Œwriteçš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ•°æ®çš„æŒ‡é’ˆï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯è¦å†™å…¥çš„å­—èŠ‚æ•°ã€‚æ•°æ®è¢«å†™å…¥åˆ°äº†æ–‡ä»¶æè¿°ç¬¦å¯¹åº”çš„æ–‡ä»¶ä¸­ã€‚

> **æ–‡ä»¶æè¿°ç¬¦**

æ–‡ä»¶æè¿°ç¬¦æœ¬è´¨ä¸Šå¯¹åº”äº†å†…æ ¸ä¸­çš„ä¸€ä¸ªè¡¨å•æ•°æ®ã€‚å†…æ ¸ç»´æŠ¤äº†æ¯ä¸ªè¿è¡Œè¿›ç¨‹çš„çŠ¶æ€ï¼Œå†…æ ¸ä¼šä¸ºæ¯ä¸€ä¸ªè¿è¡Œè¿›ç¨‹ä¿å­˜ä¸€ä¸ªè¡¨å•ï¼Œè¡¨å•çš„keyæ˜¯æ–‡ä»¶æè¿°ç¬¦ã€‚è¿™ä¸ªè¡¨å•è®©å†…æ ¸çŸ¥é“ï¼Œæ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦å¯¹åº”çš„å®é™…å†…å®¹æ˜¯ä»€ä¹ˆã€‚

è¿™é‡Œæ¯”è¾ƒå…³é”®çš„ç‚¹æ˜¯ï¼Œ**æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„æ–‡ä»¶æè¿°ç¬¦ç©ºé—´**ï¼Œæ‰€ä»¥å¦‚æœè¿è¡Œäº†ä¸¤ä¸ªä¸åŒçš„ç¨‹åºï¼Œå¯¹åº”ä¸¤ä¸ªä¸åŒçš„è¿›ç¨‹ï¼Œå¦‚æœå®ƒä»¬éƒ½æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œå®ƒä»¬æˆ–è®¸å¯ä»¥å¾—åˆ°ç›¸åŒæ•°å­—çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä½†æ˜¯å› ä¸ºå†…æ ¸ä¸ºæ¯ä¸ªè¿›ç¨‹éƒ½ç»´æŠ¤äº†ä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶æè¿°ç¬¦ç©ºé—´ï¼Œ**è¿™é‡Œç›¸åŒæ•°å­—çš„æ–‡ä»¶æè¿°ç¬¦å¯èƒ½ä¼šå¯¹åº”åˆ°ä¸åŒçš„æ–‡ä»¶ã€‚**

### 1.4.3 shell

> **æ¦‚è¿°**

Shell:å‘½ä»¤è¡Œæ¥å£ï¼ŒShellæ˜¯ä¸€ç§å¯¹äºUnixç³»ç»Ÿç®¡ç†æ¥è¯´éå¸¸æœ‰ç”¨çš„æ¥å£ï¼Œå®ƒæä¾›äº†å¾ˆå¤šå·¥å…·æ¥ç®¡ç†æ–‡ä»¶ï¼Œç¼–å†™ç¨‹åºï¼Œç¼–å†™è„šæœ¬ã€‚

Shellæœ€å¸¸è§çš„åŠŸèƒ½æ˜¯ï¼šå½“ä½ è¾“å…¥å†…å®¹æ—¶ï¼Œæ˜¯åœ¨å‘Šè¯‰Shellè¿è¡Œç›¸åº”çš„ç¨‹åºã€‚

ğŸ™‹ğŸŒ°ï¼šå½“æˆ‘ä»¬è¾“å…¥lsæ—¶ï¼Œå®é™…çš„æ„ä¹‰æ˜¯è¦æ±‚**Shellè¿è¡Œåä¸ºlsçš„ç¨‹åº**ï¼Œæ–‡ä»¶ç³»ç»Ÿä¸­ä¼šæœ‰ä¸€ä¸ªæ–‡ä»¶åä¸ºlsï¼Œè¿™ä¸ªæ–‡ä»¶ä¸­åŒ…å«äº†ä¸€äº›è®¡ç®—æœºæŒ‡ä»¤ï¼Œæ‰€ä»¥å®é™…ä¸Šï¼Œå½“è¾“å…¥lsæ—¶ï¼Œæ˜¯åœ¨è¦æ±‚Shellè¿è¡Œä½äºæ–‡ä»¶lså†…çš„è¿™äº›è®¡ç®—æœºæŒ‡ä»¤ã€‚

> **Shell é‡å®šå‘IO**

```zsh
$ ls > out
$ cat out
.              1 1 1024
..             1 1 1024
README         2 2 2226
cat            2 3 24232
copy           2 4 22632
echo           2 5 23048
forktest       2 6 13272
grep           2 7 27528
init           2 8 23792
kill           2 9 22992
ln             2 10 22848
ls             2 11 26424
mkdir          2 12 23152
open           2 13 22480
rm             2 14 23128
sh             2 15 41952
stressfs       2 16 23984
usertests      2 17 157032
grind          2 18 38160
wc             2 19 25312
zombie         2 20 22384
console        3 21 0
output.txt     2 22 4
out            2 23 578
```

**ä¸Šè¿°æŒ‡ä»¤çš„å®é™…æ„ä¹‰æ˜¯:** è¦æ±‚Shellè¿è¡Œlså‘½ä»¤ï¼Œä½†æ˜¯**å°†è¾“å‡ºé‡å®šå‘åˆ°ä¸€ä¸ªå«åšoutçš„æ–‡ä»¶ä¸­**ã€‚è¿™é‡Œæ‰§è¡Œå®Œæˆä¹‹åæˆ‘ä»¬çœ‹ä¸åˆ°ä»»ä½•çš„è¾“å‡ºï¼Œå› ä¸ºè¾“å‡ºéƒ½é€åˆ°äº†outæ–‡ä»¶ã€‚ç°åœ¨æˆ‘ä»¬çŸ¥é“outæ–‡ä»¶åŒ…å«äº†ä¸€äº›æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡catæŒ‡ä»¤è¯»å–ä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶æ˜¾ç¤ºæ–‡ä»¶çš„å†…å®¹ã€‚

> **grepæŒ‡ä»¤**

grep xä¼šæœç´¢è¾“å…¥ä¸­åŒ…å«xçš„è¡Œï¼Œæˆ‘å¯ä»¥å‘Šè¯‰shellå°†è¾“å…¥é‡å®šå‘åˆ°æ–‡ä»¶outï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æŸ¥çœ‹outä¸­çš„xã€‚

```zsh
$ grep x

$ grep x < out
output.txt     2 22 4

$ grep l < out
kill           2 9 22992
ln             2 10 22848
ls             2 11 2642
```

å› ä¸ºoutæ–‡ä»¶åŒ…å«äº†lsçš„è¾“å‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæœ‰3ä¸ªæ–‡ä»¶çš„æ–‡ä»¶ååŒ…å«äº†lã€‚

> **Qï¼šæœ‰ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å’Œç¼–è¯‘å™¨çš„é—®é¢˜ã€‚ç¼–è¯‘å™¨å¦‚ä½•å¤„ç†ç³»ç»Ÿè°ƒç”¨ï¼Ÿç”Ÿæˆçš„æ±‡ç¼–è¯­è¨€æ˜¯ä¸æ˜¯ä¼šè°ƒç”¨ä¸€äº›ç”±æ“ä½œç³»ç»Ÿå®šä¹‰çš„ä»£ç æ®µï¼Ÿ**

Robertæ•™æˆï¼šæœ‰ä¸€ä¸ªç‰¹æ®Šçš„RISC-VæŒ‡ä»¤ï¼Œç¨‹åºå¯ä»¥è°ƒç”¨è¿™ä¸ªæŒ‡ä»¤ï¼Œå¹¶å°†æ§åˆ¶æƒäº¤ç»™å†…æ ¸ã€‚æ‰€ä»¥ï¼Œå®é™…ä¸Šå½“ä½ è¿è¡ŒCè¯­è¨€å¹¶æ‰§è¡Œä¾‹å¦‚openæˆ–è€…writeçš„ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œä»æŠ€æœ¯ä¸Šæ¥è¯´ï¼Œopenæ˜¯ä¸€ä¸ªCå‡½æ•°ï¼Œä½†æ˜¯è¿™ä¸ªå‡½æ•°å†…çš„æŒ‡ä»¤å®é™…ä¸Šæ˜¯æœºå™¨æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è°ƒç”¨çš„openå‡½æ•°å¹¶ä¸æ˜¯ä¸€ä¸ªCè¯­è¨€å‡½æ•°ï¼Œå®ƒæ˜¯ç”±æ±‡ç¼–è¯­è¨€å®ç°ï¼Œç»„æˆè¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ±‡ç¼–è¯­è¨€å®é™…ä¸Šåœ¨RISC-Vä¸­è¢«ç§°ä¸ºecallã€‚è¿™ä¸ªç‰¹æ®Šçš„æŒ‡ä»¤å°†æ§åˆ¶æƒè½¬ç»™å†…æ ¸ã€‚ä¹‹åå†…æ ¸æ£€æŸ¥è¿›ç¨‹çš„å†…å­˜å’Œå¯„å­˜å™¨ï¼Œå¹¶ç¡®å®šç›¸åº”çš„å‚æ•°ã€‚

### 1.4.4 fork

forkä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œä¸‹é¢æ˜¯ä½¿ç”¨forkçš„ä¸€ä¸ªç®€å•ç”¨ä¾‹ã€‚

> **fork**

```c
// fork.c: create a new process

# include "kernel/types.h"
# include "user/user.h"

int main(){
    int pid;

    pid = fork();

    printf("fork() return %d \n",pid);

    if(pid == 0){
        printf("child\n");
    }else{
        printf("parent\n");
    }
    exit(0);
}
```

- forkä¼š**æ‹·è´å½“å‰è¿›ç¨‹çš„å†…å­˜**ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œè¿™é‡Œçš„å†…å­˜åŒ…å«äº†è¿›ç¨‹çš„æŒ‡ä»¤å’Œæ•°æ®ã€‚ä¹‹åï¼Œæˆ‘ä»¬å°±æœ‰äº†ä¸¤ä¸ªæ‹¥æœ‰å®Œå…¨ä¸€æ ·å†…å­˜çš„è¿›ç¨‹ã€‚
- **forkç³»ç»Ÿè°ƒç”¨åœ¨ä¸¤ä¸ªè¿›ç¨‹ä¸­éƒ½ä¼šè¿”å›**
  - åœ¨åŸå§‹çš„è¿›ç¨‹ä¸­ï¼Œforkç³»ç»Ÿè°ƒç”¨ä¼šè¿”å›å¤§äº0çš„æ•´æ•°ï¼Œè¿™ä¸ªæ˜¯æ–°åˆ›å»ºè¿›ç¨‹çš„IDã€‚
  - åœ¨æ–°åˆ›å»ºçš„è¿›ç¨‹ä¸­ï¼Œforkç³»ç»Ÿè°ƒç”¨ä¼šè¿”å›0ã€‚
- é€šè¿‡æ ¡éªŒpidï¼Œå¦‚æœpidç­‰äº0ï¼Œé‚£ä¹ˆè¿™å¿…ç„¶æ˜¯å­è¿›ç¨‹ã€‚è°ƒç”¨è¿›ç¨‹é€šå¸¸ç§°ä¸ºçˆ¶è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹çœ‹åˆ°çš„pidå¿…ç„¶å¤§äº0ã€‚æ‰€ä»¥çˆ¶è¿›ç¨‹ä¼šæ‰“å°â€œparentâ€ï¼Œå­è¿›ç¨‹ä¼šæ‰“å°â€œchildâ€ã€‚ä¹‹åä¸¤ä¸ªè¿›ç¨‹éƒ½ä¼šé€€å‡ºã€‚

è¿è¡Œfork ä¹‹åå¦‚ä¸‹ä¸ºè¾“å‡º

```zsh
$ fork
ffoorrkk(() )r erteutrnur n4  
0pa re
nt
child
```

ä¸Šè¿°è¾“å‡ºåƒæ˜¯ä¹±ç ï¼Œå®é™…çŠ¶å†µæ˜¯ï¼šforkç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œ**ä¸¤ä¸ªè¿›ç¨‹éƒ½åœ¨åŒæ—¶è¿è¡Œ**ï¼ŒQEMUå®é™…ä¸Šæ˜¯åœ¨æ¨¡æ‹Ÿå¤šæ ¸å¤„ç†å™¨ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªè¿›ç¨‹å®é™…ä¸Šå°±æ˜¯åŒæ—¶åœ¨è¿è¡Œã€‚

å½“è¿™ä¸¤ä¸ªè¿›ç¨‹åœ¨è¾“å‡ºçš„æ—¶å€™ï¼Œå®ƒä»¬ä¼šåŒæ—¶ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚çš„è¾“å‡ºï¼Œä¸¤ä¸ªè¿›ç¨‹çš„è¾“å‡ºäº¤ç»‡åœ¨ä¸€èµ·ï¼Œæ‰€ä»¥ä½ å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªfï¼Œä¸¤ä¸ªoç­‰ç­‰ã€‚

**forkåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„è¿›ç¨‹ã€‚** å½“æˆ‘ä»¬åœ¨Shellä¸­è¿è¡Œä¸œè¥¿çš„æ—¶å€™ï¼Œ**Shellå®é™…ä¸Šä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹æ¥è¿è¡Œæˆ‘ä»¬è¾“å…¥çš„æ¯ä¸€ä¸ªæŒ‡ä»¤**ã€‚

æ‰€ä»¥ï¼Œå½“æˆ‘è¾“å…¥lsæ—¶ï¼Œæˆ‘ä»¬éœ€è¦Shellé€šè¿‡forkåˆ›å»ºä¸€ä¸ªè¿›ç¨‹æ¥è¿è¡Œlsï¼Œè¿™é‡Œéœ€è¦æŸç§æ–¹å¼æ¥è®©è¿™ä¸ªæ–°çš„è¿›ç¨‹æ¥è¿è¡Œlsç¨‹åºä¸­çš„æŒ‡ä»¤ï¼ŒåŠ è½½åä¸ºlsçš„æ–‡ä»¶ä¸­çš„æŒ‡ä»¤ï¼ˆä¹Ÿå°±æ˜¯åé¢çš„execç³»ç»Ÿè°ƒç”¨)ã€‚

> **Q:forkäº§ç”Ÿçš„å­è¿›ç¨‹æ˜¯ä¸æ˜¯æ€»æ˜¯ä¸çˆ¶è¿›ç¨‹æ˜¯ä¸€æ ·çš„ï¼Ÿå®ƒä»¬æœ‰å¯èƒ½ä¸ä¸€æ ·å—ï¼Ÿ**

Robertæ•™æˆï¼š**åœ¨XV6ä¸­**ï¼Œé™¤äº†forkçš„è¿”å›å€¼ï¼Œä¸¤ä¸ªè¿›ç¨‹æ˜¯ä¸€æ ·çš„ã€‚ä¸¤ä¸ªè¿›ç¨‹çš„æŒ‡ä»¤æ˜¯ä¸€æ ·çš„ï¼Œæ•°æ®æ˜¯ä¸€æ ·çš„ï¼Œæ ˆæ˜¯ä¸€æ ·çš„ï¼ŒåŒæ—¶ï¼Œä¸¤ä¸ªè¿›ç¨‹åˆæœ‰å„è‡ªç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œå®ƒä»¬éƒ½è®¤ä¸ºè‡ªå·±çš„å†…å­˜ä»0å¼€å§‹å¢é•¿ï¼Œä½†æ˜¯åœ¨XV6ä¸­ï¼Œçˆ¶å­è¿›ç¨‹é™¤äº†forkçš„è¿”å›å€¼ï¼Œå…¶ä»–éƒ½æ˜¯ä¸€æ ·çš„ã€‚æ–‡ä»¶æè¿°ç¬¦çš„è¡¨å•ä¹Ÿä»çˆ¶è¿›ç¨‹æ‹·è´åˆ°å­è¿›ç¨‹ã€‚æ‰€ä»¥å¦‚æœçˆ¶è¿›ç¨‹æ‰“å¼€äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œå­è¿›ç¨‹å¯ä»¥çœ‹åˆ°åŒä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå°½ç®¡å­è¿›ç¨‹çœ‹åˆ°çš„æ˜¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„è¡¨å•çš„æ‹·è´ã€‚é™¤äº†æ‹·è´å†…å­˜ä»¥å¤–ï¼Œforkè¿˜ä¼šæ‹·è´æ–‡ä»¶æè¿°ç¬¦è¡¨å•è¿™ä¸€ç‚¹è¿˜æŒºé‡è¦çš„ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä¼šçœ‹åˆ°ã€‚

åœ¨ä¸€ä¸ªæ›´åŠ å¤æ‚çš„æ“ä½œç³»ç»Ÿï¼Œæœ‰ä¸€äº›ç»†èŠ‚æˆ‘ä»¬ç°åœ¨å¹¶ä¸å…³å¿ƒï¼Œè¿™äº›ç»†èŠ‚å¶å°”ä¼šå¯¼è‡´çˆ¶å­è¿›ç¨‹ä¸ä¸€è‡´ã€‚

### 1.4.5 execã€waitç³»ç»Ÿè°ƒç”¨

#### 1.4.5.1 execç³»ç»Ÿè°ƒç”¨

> **execä»£ç **
echoæ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„å‘½ä»¤ï¼Œå®ƒæ¥æ”¶ä»»ä½•ä½ ä¼ é€’ç»™å®ƒçš„è¾“å…¥ï¼Œå¹¶å°†è¾“å…¥å†™åˆ°è¾“å‡ºã€‚

```c
// exec.c: replace a process with a executable file

# include "kernel/types.h"
# include "user/user.h"

int main(){
    char *argv[] = {"echo","this","is","echo",0};

    exec("echo",argv);

    printf("exec failed!\n");

    exit(0);
}
```

**ä¸Šè¿°ä»£ç ä¼šæ‰§è¡Œexecç³»ç»Ÿè°ƒç”¨**ï¼Œè¿™ä¸ªç³»ç»Ÿè°ƒç”¨**ä¼šä»æŒ‡å®šçš„æ–‡ä»¶ä¸­è¯»å–å¹¶åŠ è½½æŒ‡ä»¤**ï¼Œ**å¹¶æ›¿ä»£å½“å‰è°ƒç”¨è¿›ç¨‹çš„æŒ‡ä»¤**ã€‚ä»æŸç§ç¨‹åº¦ä¸Šæ¥è¯´ï¼Œè¿™æ ·*ç›¸å½“äºä¸¢å¼ƒäº†è°ƒç”¨è¿›ç¨‹çš„å†…å­˜ï¼Œå¹¶å¼€å§‹æ‰§è¡Œæ–°åŠ è½½çš„æŒ‡ä»¤*

`exec("echo",argv);`:è¯¥è¡Œä¼šæœ‰å¦‚ä¸‹æ•ˆæœ

- æ“ä½œç³»ç»Ÿä»åä¸º`echo`çš„æ–‡ä»¶ä¸­**åŠ è½½æŒ‡ä»¤åˆ°å½“å‰çš„è¿›ç¨‹ä¸­**ï¼Œå¹¶æ›¿æ¢äº†å½“å‰è¿›ç¨‹çš„å†…å­˜
- **ä¹‹åå¼€å§‹æ‰§è¡Œè¿™äº›æ–°åŠ è½½çš„æŒ‡ä»¤**ã€‚
- **ä¼ å…¥å‘½ä»¤è¡Œå‚æ•°**:execå…è®¸ä½ ä¼ å…¥ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°çš„æ•°ç»„ï¼Œè¿™é‡Œå°±æ˜¯ä¸€ä¸ªCè¯­è¨€ä¸­çš„æŒ‡é’ˆæ•°ç»„ï¼Œåœ¨ä¸Šé¢ä»£ç çš„ç¬¬10è¡Œè®¾ç½®å¥½äº†ä¸€ä¸ªå­—ç¬¦æŒ‡é’ˆçš„æ•°ç»„ï¼Œè¿™é‡Œçš„å­—ç¬¦æŒ‡é’ˆæœ¬è´¨å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ˆstringï¼‰ã€‚

ç»¼ä¸Šæ‰€è¿°æ­¤å¤„ç­‰ä»·äºè¿è¡Œ`echo`å‘½ä»¤ï¼Œå¹¶æºå¸¦"this is echo"è¿™ä¸‰ä¸ªå‚æ•°ã€‚æ‰€ä»¥å½“æˆ‘ä»¬è¿è¡Œexecæ–‡ä»¶æ—¶:

```zsh
$ exec
this is echo
```

å¯ä»¥çœ‹åˆ°â€œthis is echoâ€çš„è¾“å‡ºã€‚å³æ­¤å¤„è¿è¡Œäº†execç¨‹åºï¼Œä½†execç¨‹åºå®é™…ä¸Šè°ƒç”¨äº†execç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶ç”¨echoæŒ‡ä»¤æ¥ä»£æ›¿è‡ªå·±ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯**echoå‘½ä»¤åœ¨äº§ç”Ÿè¾“å‡ºã€‚**

> **execæ³¨æ„äº‹é¡¹**

- **execç³»ç»Ÿè°ƒç”¨ä¼šä¿ç•™å½“å‰çš„æ–‡ä»¶æè¿°ç¬¦è¡¨å•**ã€‚æ‰€ä»¥ä»»ä½•åœ¨execç³»ç»Ÿè°ƒç”¨ä¹‹å‰çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¾‹å¦‚0ï¼Œ1ï¼Œ2ç­‰ã€‚å®ƒä»¬åœ¨æ–°çš„ç¨‹åºä¸­è¡¨ç¤ºç›¸åŒçš„ä¸œè¥¿ã€‚
- **ä¸€èˆ¬è€Œè¨€execç³»ç»Ÿè°ƒç”¨ä¸ä¼šè¿”å›**ï¼Œå› ä¸ºexecä¼šå®Œå…¨æ›¿æ¢å½“å‰è¿›ç¨‹çš„å†…å­˜ï¼Œç›¸å½“äºå½“å‰è¿›ç¨‹ä¸å¤å­˜åœ¨äº†ï¼Œæ‰€ä»¥execç³»ç»Ÿè°ƒç”¨å·²ç»æ²¡æœ‰åœ°æ–¹èƒ½è¿”å›äº†ã€‚
- **execç³»ç»Ÿè°ƒç”¨åªä¼šå½“å‡ºé”™æ—¶æ‰ä¼šè¿”å›**ï¼Œå› ä¸ºæŸäº›é”™è¯¯ä¼šé˜»æ­¢æ“ä½œç³»ç»Ÿä¸ºä½ è¿è¡Œæ–‡ä»¶ä¸­çš„æŒ‡ä»¤ï¼Œä¾‹å¦‚ç¨‹åºæ–‡ä»¶æ ¹æœ¬ä¸å­˜åœ¨ï¼Œå› ä¸ºexecç³»ç»Ÿè°ƒç”¨ä¸èƒ½æ‰¾åˆ°æ–‡ä»¶ï¼Œexecä¼šè¿”å›-1æ¥è¡¨ç¤ºï¼šå‡ºé”™äº†ï¼Œæˆ‘æ‰¾ä¸åˆ°æ–‡ä»¶ã€‚

> **æ€»ç»“**

ä»¥ä¸Šä»£ç å°±æ˜¯å®ç°ï¼šä¸€ä¸ªç¨‹åºåˆ©ç”¨å¦å¤–ä¸€ä¸ªç¨‹åºä»£æ›¿è‡ªå·±ã€‚ä½†å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›è°ƒç”¨ä¸€ä¸ªç¨‹åºä¹‹åä¸¢å¤±æ§åˆ¶æƒï¼Œå¯¹äºè¿™ç§è¿˜å¸Œæœ›èƒ½æ‹¿å›æ§åˆ¶æƒçš„åœºæ™¯ï¼Œå¯ä»¥å…ˆæ‰§è¡Œforkç³»ç»Ÿè°ƒç”¨ï¼Œç„¶ååœ¨å­è¿›ç¨‹ä¸­è°ƒç”¨execã€‚

#### 1.4.5.2 fork/execç³»ç»Ÿè°ƒç”¨

> **fork/execæˆåŠŸè°ƒç”¨å­è¿›ç¨‹ä»£ç **

```c
// forkexec.c:fork then exec

# include "kernel/types.h"
# include "user/user.h"

int main(){
    int pid,status;

    pid = fork();

    if(pid == 0){
        char *argv[] = {"echo","THIS","IS","ECHO",0};
        exec("echo",argv);
        printf("exec failed!\n");
        exit(1);
    }else{
        printf("parent waiting\n");
        wait(&status);
        printf("the child exited with status %d\n",status);
    }
    exit(0);
}
```

- åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œé¦–å…ˆè°ƒç”¨äº†`fork`
- å­è¿›ç¨‹ä¼šåˆ©ç”¨`echo`å‘½ä»¤ä»£æ›¿è‡ªå·±ï¼Œechoæ‰§è¡Œå®Œæˆåå°±é€€å‡ºã€‚
- çˆ¶è¿›ç¨‹ä¼šé‡æ–°è·å¾—æ§åˆ¶æƒï¼Œforkåœ¨çˆ¶è¿›ç¨‹ä¸­è¿”å›å¤§äº0çš„å€¼ï¼Œçˆ¶è¿›ç¨‹ä¼šç»§ç»­åœ¨19è¡Œæ‰§è¡Œ

è¿è¡Œè¾“å‡º:

```zsh
$ forkexec
parent waiting
THIS IS ECHO
the child exited with status 0
```

> **waitç³»ç»Ÿè°ƒç”¨**

Unixæä¾›äº†ä¸€ä¸ªwaitç³»ç»Ÿè°ƒç”¨ï¼Œ**waitä¼šç­‰å¾…ä¹‹å‰åˆ›å»ºçš„å­è¿›ç¨‹é€€å‡º**ã€‚

å½“æˆ‘ä»¬åœ¨Shellå‘½ä»¤è¡Œæ‰§è¡Œä¸€ä¸ªæŒ‡ä»¤æ—¶ï¼Œä¸€èˆ¬ä¼šå¸Œæœ›Shellç­‰å¾…æŒ‡ä»¤æ‰§è¡Œå®Œæˆã€‚æ‰€ä»¥waitç³»ç»Ÿè°ƒç”¨ï¼Œä½¿å¾—çˆ¶è¿›ç¨‹å¯ä»¥ç­‰å¾…ä»»ä½•ä¸€ä¸ªå­è¿›ç¨‹è¿”å›ã€‚

**waitå‚æ•° status**ï¼šæ˜¯ä¸€ç§çˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹ä¹‹é—´çš„ä¸€ç§é€šä¿¡æ–¹å¼ï¼Œä»–å¯ä»¥è®©é€€å‡ºçš„å­è¿›ç¨‹ä»¥ä¸€ä¸ªæ•´æ•°ï¼ˆ32bitçš„æ•°æ®ï¼‰ä¸ç­‰å¾…çš„çˆ¶è¿›ç¨‹é€šä¿¡ã€‚

æ‰€ä»¥åœ¨ifè¯­å¥ä¸­çš„æœ€åä¸€è¡Œ`exit`çš„å‚æ•°æ˜¯1ï¼Œæ“ä½œç³»ç»Ÿä¼šå°†1ä»é€€å‡ºçš„å­è¿›ç¨‹ä¼ é€’åˆ°`wait(&status)`ï¼Œå³çˆ¶è¿›ç¨‹çš„ç­‰å¾…å¤„ã€‚

`&status`ï¼Œæ˜¯å°†statuså¯¹åº”çš„åœ°å€ä¼ é€’ç»™å†…æ ¸ï¼Œå†…æ ¸ä¼šå‘è¿™ä¸ªåœ°å€å†™å…¥å­è¿›ç¨‹å‘exitä¼ å…¥çš„å‚æ•°ã€‚

> **UNIXä¸­exitçš„ä¼ å‚é£æ ¼**

- å¦‚æœä¸€ä¸ªç¨‹åºæˆåŠŸé€€å‡ºï¼Œé‚£ä¹ˆexitçš„å‚æ•°å³ä¸º0ï¼›
- å¦‚æœä¸€ä¸ªç¨‹åºå‡ºç°é”™è¯¯ï¼Œé‚£ä¹ˆexitçš„å‚æ•°ä¸º1ã€‚

> **fork/execè°ƒç”¨å­è¿›ç¨‹ä»£ç å¤±è´¥ç¤ºä¾‹**

```c
// forkexec.c:fork then exec

# include "kernel/types.h"
# include "user/user.h"

int main(){
    int pid,status;

    pid = fork();

    if(pid == 0){
        char *argv[] = {"echo","THIS","IS","ECHO",0};
        // è°ƒç”¨äº†ä¸å­˜åœ¨çš„ç³»ç»Ÿè°ƒç”¨
        exec("sdfaddfaecho",argv);
        printf("exec failed!\n");
        exit(1);
    }else{
        printf("parent waiting\n");
        wait(&status);
        printf("the child exited with status %d\n",status);
    }
    exit(0);
}
```

è¿è¡Œè¾“å‡ºï¼š

```zsh
$ forkexec
parent waiting
exec failed!
the child exited with status 1
```

> **æ€»ç»“**

ä¸Šè¿°ä»£ç ä¸­æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªå¸¸ç”¨å†™æ³•ï¼Œå³å…ˆè°ƒç”¨`fork`,ç„¶ååœ¨å­è¿›ç¨‹ä¸­è°ƒç”¨`exec`ã€‚

è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œforké¦–å…ˆæ‹·è´äº†æ•´ä¸ªçˆ¶è¿›ç¨‹ï¼Œä¹‹åexecå°†è¿™ä¸ªæ‹·è´å…¨éƒ¨ä¸¢å¼ƒï¼ŒæŸç§ç¨‹åº¦ä¸Šè€Œè¨€ï¼Œè¿™é‡Œçš„æ‹·è´æ“ä½œæ˜¯æµªè´¹çš„ã€‚åœ¨å¤§å‹ç¨‹åºä¸­æ¯”è¾ƒæ˜æ˜¾ã€‚

åœ¨åç»­è¯¾ç¨‹ä¸­ä¼šé’ˆå¯¹è¿™ä¸ªé—®é¢˜å®ç°ä¼˜åŒ–ï¼Œæ¯”å¦‚`copy-on-write fork`,è¿™ç§æ–¹å¼ä¼šæ¶ˆé™¤forkçš„å‡ ä¹æ‰€æœ‰çš„æ˜æ˜¾çš„ä½æ•ˆï¼Œè€Œåªæ‹·è´æ‰§è¡Œexecæ‰€éœ€è¦çš„å†…å­˜ï¼Œè¿™é‡Œéœ€è¦å¾ˆå¤šæ¶‰åŠåˆ°è™šæ‹Ÿå†…å­˜ç³»ç»Ÿçš„æŠ€å·§ã€‚

åŒæ—¶å¯ä»¥æ„å»ºä¸€ä¸ªforkï¼Œå¯¹äºå†…å­˜å®è¡Œlazyæ‹·è´ï¼Œé€šå¸¸æ¥è¯´forkä¹‹åç«‹åˆ»æ˜¯execï¼Œè¿™æ ·ä½ å°±ä¸ç”¨å®é™…çš„æ‹·è´ï¼Œå› ä¸ºå­è¿›ç¨‹å®é™…ä¸Šå¹¶æ²¡æœ‰ä½¿ç”¨å¤§éƒ¨åˆ†çš„å†…å­˜ã€‚

### 1.4.6 I/O Redirect

Shellæä¾›äº†æ–¹ä¾¿çš„é‡å®šå‘å·¥å…·ï¼Œå¦‚æœè¿è¡Œä¸‹è¿°æŒ‡ä»¤åˆ™è¡¨ç¤º: 

- Shellä¼šå°†echoçš„è¾“å‡ºé€åˆ°æ–‡ä»¶out
- ä¹‹åè¿è¡ŒcatæŒ‡ä»¤ï¼Œå¹¶å°†outæ–‡ä»¶ä½œä¸ºè¾“å…¥

å¯ä»¥çœ‹åˆ°ä¿å­˜åœ¨outæ–‡ä»¶ä¸­çš„å†…å®¹å°±æ˜¯echoæŒ‡ä»¤çš„è¾“å‡ºã€‚

```zsh
$ echo hello > out
$ cat < out
hello
```

> **redirect.c**

```c
// redirect.c: run a commond with output redirected

# include "kernel/types.h"
# include "user/user.h"
# include "kernel/fcntl.h"


int main(){
    int pid;

    pid = fork();

    if(pid == 0){
        close(1);
        open("output.txt",O_WRONLY|O_CREATE);

        char *argv[] = {"echo","this","is","redirected","echo",0};
        exec("echo",argv);
        prinf("exec failed!\n");
        exit(1);
    }else{
        wait((int *)0);
    }
    exit(0);
}
```

> **ä»£ç åˆ†æ**

Shellä¹‹æ‰€ä»¥å…·å¤‡ä¸Šè¿°åŠŸèƒ½ï¼Œæ˜¯å› ä¸ºå¦‚ä¸Šè¿°ä»£ç æ‰€ç¤º:

- Shellé¦–å…ˆä¼šforkä¸€ä¸ªå­è¿›ç¨‹ï¼Œç„¶ååœ¨å­è¿›ç¨‹ä¸­Shellæ”¹å˜äº†æ–‡ä»¶æè¿°ç¬¦(åœ¨è¿™é‡Œä¸º"ouput.txt")ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸º1ï¼Œå³consoleçš„è¾“å‡ºæ–‡ä»¶ç¬¦ã€‚è¯¥æ–¹æ³•æ˜¯Unixä¸­çš„å¸¸è§çš„ç”¨æ¥é‡å®šå‘æŒ‡ä»¤çš„è¾“å…¥è¾“å‡ºçš„æ–¹æ³•ï¼Œè¿™ç§æ–¹æ³•åŒæ—¶åˆä¸ä¼šå½±å“çˆ¶è¿›ç¨‹çš„è¾“å…¥è¾“å‡ºã€‚å› ä¸ºæˆ‘ä»¬ä¸ä¼šæƒ³è¦é‡å®šå‘Shellçš„è¾“å‡ºï¼Œæˆ‘ä»¬åªæƒ³é‡å®šå‘å­è¿›ç¨‹çš„è¾“å‡ºã€‚

- ä»£ç `close(1)`çš„æ„ä¹‰æ˜¯:æˆ‘ä»¬å¸Œæœ›æ–‡ä»¶æè¿°ç¬¦1æŒ‡å‘ä¸€ä¸ªå…¶ä»–çš„ä½ç½®ï¼Œå³æˆ‘ä»¬è¿™é‡Œå…³é—­åŸæœ¬æŒ‡å‘consoleè¾“å‡ºçš„æ–‡ä»¶æè¿°ç¬¦1

- è€Œå› ä¸ºåˆšå…³é—­æ–‡ä»¶æè¿°ç¬¦1ï¼Œæ‰€ä»¥ä»£ç `open("output.txt",O_WRONLY|O_CREATE);`ä¸€å®šè¿”å›1ï¼Œå› ä¸º`open`ä¼šè¿”å›å½“å‰è¿›ç¨‹æœªä½¿ç”¨çš„æœ€å°æ–‡ä»¶æè¿°ç¬¦ã€‚è€Œæ–‡ä»¶æè¿°ç¬¦`0`å¯¹åº”ç€consoleè¾“å…¥ï¼Œ`1`æ˜¯æˆ‘ä»¬åˆšåˆšå…³é—­çš„æœ€å°æ–‡ä»¶æè¿°ç¬¦ï¼Œæ‰€ä»¥openä¸€å®šå¯ä»¥è¿”å›1ï¼Œå³æ‰§è¡Œå®Œä¸Šè¿°ä»£ç åæ–‡ä»¶æè¿°ç¬¦`1`ä¸æ–‡ä»¶`output.txt`å…³è”

- ä¹‹åæˆ‘ä»¬æ‰§è¡Œexec(echo)ï¼Œechoä¼šè¾“å‡ºåˆ°æ–‡ä»¶æè¿°ç¬¦1ï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶output.txtã€‚ä½†echoä¸æ¸…æ¥šå‘ç”Ÿäº†ä»€ä¹ˆã€‚

> **è¿è¡Œè¾“å‡º**

```zsh
$ redirect
$ cat < output.txt
this is redirected echo
```
