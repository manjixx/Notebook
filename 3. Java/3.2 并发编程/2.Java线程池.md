- [ä¸€ã€ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„](#ä¸€ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„)
- [äºŒã€ Executor æ¡†æ¶](#äºŒ-executor-æ¡†æ¶)
  - [2.1 ç®€ä»‹](#21-ç®€ä»‹)
  - [2.2 Executor æ¡†æ¶ç»“æ„(ä¸»è¦ç”±ä¸‰å¤§éƒ¨åˆ†ç»„æˆ)](#22-executor-æ¡†æ¶ç»“æ„ä¸»è¦ç”±ä¸‰å¤§éƒ¨åˆ†ç»„æˆ)
    - [2.2.1 ä»»åŠ¡(`Runnable` /`Callable`)](#221-ä»»åŠ¡runnable-callable)
    - [2.2.2 ä»»åŠ¡çš„æ‰§è¡Œ(`Executor`)](#222-ä»»åŠ¡çš„æ‰§è¡Œexecutor)
    - [2.2.3 å¼‚æ­¥è®¡ç®—çš„ç»“æœ(`Future`)](#223-å¼‚æ­¥è®¡ç®—çš„ç»“æœfuture)
  - [2.3 Executor æ¡†æ¶çš„ä½¿ç”¨ç¤ºæ„å›¾](#23-executor-æ¡†æ¶çš„ä½¿ç”¨ç¤ºæ„å›¾)
- [ä¸‰ã€(é‡è¦)ThreadPoolExecutor ç±»ç®€å•ä»‹ç»](#ä¸‰é‡è¦threadpoolexecutor-ç±»ç®€å•ä»‹ç»)
  - [3.1 ThreadPoolExecutor ç±»åˆ†æ](#31-threadpoolexecutor-ç±»åˆ†æ)
  - [3.2 ä½¿ç”¨ `ThreadPoolExecutor` æ„é€ å‡½æ•°åˆ›å»ºçº¿ç¨‹æ± ](#32-ä½¿ç”¨-threadpoolexecutor-æ„é€ å‡½æ•°åˆ›å»ºçº¿ç¨‹æ± )
- [å››ã€ ThreadPoolExecutor ä½¿ç”¨+åŸç†åˆ†æ](#å››-threadpoolexecutor-ä½¿ç”¨åŸç†åˆ†æ)
  - [4.1 ç¤ºä¾‹ä»£ç :`Runnable`+`ThreadPoolExecutor`](#41-ç¤ºä¾‹ä»£ç runnablethreadpoolexecutor)
  - [4.2 çº¿ç¨‹æ± åŸç†åˆ†æ](#42-çº¿ç¨‹æ± åŸç†åˆ†æ)
  - [4.3 å‡ ä¸ªå¸¸è§çš„å¯¹æ¯”](#43-å‡ ä¸ªå¸¸è§çš„å¯¹æ¯”)
    - [4.3.1 `Runnable` vs `Callable`](#431-runnable-vs-callable)
    - [4.3.2 `execute()` vs `submit()`](#432-execute-vs-submit)
    - [4.3.3 `shutdown()`VS`shutdownNow()`](#433-shutdownvsshutdownnow)
    - [4.3.4 `isTerminated()` VS `isShutdown()`](#434-isterminated-vs-isshutdown)
  - [4.4 `Callable`+`ThreadPoolExecutor`ç¤ºä¾‹ä»£ç ](#44-callablethreadpoolexecutorç¤ºä¾‹ä»£ç )
- [äº”ã€å‡ ç§å¸¸è§çš„çº¿ç¨‹æ± è¯¦è§£](#äº”å‡ ç§å¸¸è§çš„çº¿ç¨‹æ± è¯¦è§£)
  - [5.1 FixedThreadPool](#51-fixedthreadpool)
    - [5.1.1 ä»‹ç»](#511-ä»‹ç»)
    - [5.1.2 æ‰§è¡Œä»»åŠ¡è¿‡ç¨‹ä»‹ç»](#512-æ‰§è¡Œä»»åŠ¡è¿‡ç¨‹ä»‹ç»)
    - [5.1.3 ä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨`FixedThreadPool`ï¼Ÿ](#513-ä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨fixedthreadpool)
  - [5.2 SingleThreadExecutor è¯¦è§£](#52-singlethreadexecutor-è¯¦è§£)
    - [5.2.1 ä»‹ç»](#521-ä»‹ç»)
      - [5.2.2 æ‰§è¡Œä»»åŠ¡è¿‡ç¨‹ä»‹ç»](#522-æ‰§è¡Œä»»åŠ¡è¿‡ç¨‹ä»‹ç»)
    - [5.2.3 ä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨`SingleThreadExecutor`ï¼Ÿ](#523-ä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨singlethreadexecutor)
  - [5.3 CachedThreadPool è¯¦è§£](#53-cachedthreadpool-è¯¦è§£)
    - [5.3.1 ä»‹ç»](#531-ä»‹ç»)
    - [5.3.2 æ‰§è¡Œä»»åŠ¡è¿‡ç¨‹ä»‹ç»](#532-æ‰§è¡Œä»»åŠ¡è¿‡ç¨‹ä»‹ç»)
      - [5.3.3 ä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨`CachedThreadPool`ï¼Ÿ](#533-ä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨cachedthreadpool)
- [å…­ã€ScheduledThreadPoolExecutor è¯¦è§£](#å…­scheduledthreadpoolexecutor-è¯¦è§£)
  - [6.1 ç®€ä»‹](#61-ç®€ä»‹)
  - [6.2 è¿è¡Œæœºåˆ¶](#62-è¿è¡Œæœºåˆ¶)
  - [6.3 ScheduledThreadPoolExecutor æ‰§è¡Œå‘¨æœŸä»»åŠ¡çš„æ­¥éª¤](#63-scheduledthreadpoolexecutor-æ‰§è¡Œå‘¨æœŸä»»åŠ¡çš„æ­¥éª¤)
- [ä¸ƒã€çº¿ç¨‹æ± å¤§å°ç¡®å®š](#ä¸ƒçº¿ç¨‹æ± å¤§å°ç¡®å®š)
- [å…«ã€çº¿ç¨‹æ± æœ€ä½³å®è·µ](#å…«çº¿ç¨‹æ± æœ€ä½³å®è·µ)
  - [8.1 ä½¿ç”¨ `ThreadPoolExecutor` çš„æ„é€ å‡½æ•°å£°æ˜çº¿ç¨‹æ± ](#81-ä½¿ç”¨-threadpoolexecutor-çš„æ„é€ å‡½æ•°å£°æ˜çº¿ç¨‹æ± )
  - [8.2 ç›‘æµ‹çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€](#82-ç›‘æµ‹çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€)
  - [8.3 å»ºè®®ä¸åŒç±»åˆ«çš„ä¸šåŠ¡ç”¨ä¸åŒçš„çº¿ç¨‹æ± ](#83-å»ºè®®ä¸åŒç±»åˆ«çš„ä¸šåŠ¡ç”¨ä¸åŒçš„çº¿ç¨‹æ± )
  - [8.4 åˆ«å¿˜è®°ç»™çº¿ç¨‹æ± å‘½å](#84-åˆ«å¿˜è®°ç»™çº¿ç¨‹æ± å‘½å)
  - [8.5 æ­£ç¡®é…ç½®çº¿ç¨‹æ± å‚æ•°](#85-æ­£ç¡®é…ç½®çº¿ç¨‹æ± å‚æ•°)
    - [8.5.1å¸¸è§„æ“ä½œ](#851å¸¸è§„æ“ä½œ)
    - [8.5.2 ç¾å›¢çš„éªšæ“ä½œ](#852-ç¾å›¢çš„éªšæ“ä½œ)
- [ä¹ã€å‚è€ƒ](#ä¹å‚è€ƒ)
  
# ä¸€ã€ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„

> **æ± åŒ–æŠ€æœ¯æƒ³å¿…å¤§å®¶å·²ç»å±¡è§ä¸é²œäº†ï¼Œçº¿ç¨‹æ± ã€æ•°æ®åº“è¿æ¥æ± ã€Http è¿æ¥æ± ç­‰ç­‰éƒ½æ˜¯å¯¹è¿™ä¸ªæ€æƒ³çš„åº”ç”¨ã€‚æ± åŒ–æŠ€æœ¯çš„æ€æƒ³ä¸»è¦æ˜¯ä¸ºäº†å‡å°‘æ¯æ¬¡è·å–èµ„æºçš„æ¶ˆè€—ï¼Œæé«˜å¯¹èµ„æºçš„åˆ©ç”¨ç‡ã€‚**

**çº¿ç¨‹æ± **æä¾›äº†ä¸€ç§é™åˆ¶å’Œç®¡ç†èµ„æºï¼ˆåŒ…æ‹¬æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼‰çš„æ–¹å¼ã€‚ æ¯ä¸ª**çº¿ç¨‹æ± **è¿˜ç»´æŠ¤ä¸€äº›åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯ï¼Œä¾‹å¦‚å·²å®Œæˆä»»åŠ¡çš„æ•°é‡ã€‚

è¿™é‡Œå€Ÿç”¨ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹æåˆ°çš„æ¥è¯´ä¸€ä¸‹**ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„**ï¼š

- **é™ä½èµ„æºæ¶ˆè€—**ã€‚é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—ã€‚
- **æé«˜å“åº”é€Ÿåº¦**ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚
- **æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§**ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ã€‚

---

# äºŒã€ Executor æ¡†æ¶

## 2.1 ç®€ä»‹

`Executor` æ¡†æ¶æ˜¯ Java5 ä¹‹åå¼•è¿›çš„ï¼Œåœ¨ Java 5 ä¹‹åï¼Œé€šè¿‡ `Executor` æ¥å¯åŠ¨çº¿ç¨‹æ¯”ä½¿ç”¨ `Thread` çš„ `start` æ–¹æ³•æ›´å¥½ï¼Œé™¤äº†æ›´æ˜“ç®¡ç†ï¼Œæ•ˆç‡æ›´å¥½ï¼ˆç”¨çº¿ç¨‹æ± å®ç°ï¼ŒèŠ‚çº¦å¼€é”€ï¼‰å¤–ï¼Œè¿˜æœ‰å…³é”®çš„ä¸€ç‚¹ï¼š**æœ‰åŠ©äºé¿å… this é€ƒé€¸é—®é¢˜ã€‚**

> è¡¥å……ï¼šthis é€ƒé€¸æ˜¯æŒ‡åœ¨æ„é€ å‡½æ•°è¿”å›ä¹‹å‰å…¶ä»–çº¿ç¨‹å°±æŒæœ‰è¯¥å¯¹è±¡çš„å¼•ç”¨. è°ƒç”¨å°šæœªæ„é€ å®Œå…¨çš„å¯¹è±¡çš„æ–¹æ³•å¯èƒ½å¼•å‘ä»¤äººç–‘æƒ‘çš„é”™è¯¯ã€‚

`Executor` æ¡†æ¶ä¸ä»…åŒ…æ‹¬äº†**çº¿ç¨‹æ± çš„ç®¡ç†**ï¼Œè¿˜æä¾›äº†**çº¿ç¨‹å·¥å‚ã€é˜Ÿåˆ—ä»¥åŠæ‹’ç»ç­–ç•¥**ç­‰ï¼Œ`Executor` æ¡†æ¶è®©å¹¶å‘ç¼–ç¨‹å˜å¾—æ›´åŠ ç®€å•ã€‚

---

## 2.2 Executor æ¡†æ¶ç»“æ„(ä¸»è¦ç”±ä¸‰å¤§éƒ¨åˆ†ç»„æˆ)

### 2.2.1 ä»»åŠ¡(`Runnable` /`Callable`)

æ‰§è¡Œä»»åŠ¡éœ€è¦å®ç°çš„ **`Runnable` æ¥å£** æˆ– **`Callable`æ¥å£**ã€‚

**`Runnable` æ¥å£**æˆ– **`Callable` æ¥å£** å®ç°ç±»éƒ½å¯ä»¥è¢« **`ThreadPoolExecutor`** æˆ– **`ScheduledThreadPoolExecutor`** æ‰§è¡Œã€‚

### 2.2.2 ä»»åŠ¡çš„æ‰§è¡Œ(`Executor`)

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒåŒ…æ‹¬ä»»åŠ¡æ‰§è¡Œæœºåˆ¶çš„æ ¸å¿ƒæ¥å£ **`Executor`** ï¼Œä»¥åŠç»§æ‰¿è‡ª `Executor` æ¥å£çš„ **`ExecutorService` æ¥å£ã€‚

`ThreadPoolExecutor`** å’Œ **`ScheduledThreadPoolExecutor`** è¿™ä¸¤ä¸ªå…³é”®ç±»å®ç°äº† **ExecutorService æ¥å£**ã€‚

![ä»»åŠ¡çš„æ‰§è¡Œç›¸å…³æ¥å£](https://github.com/Snailclimb/JavaGuide/raw/main/docs/java/concurrent/images/java-thread-pool-summary/%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%89%A7%E8%A1%8C%E7%9B%B8%E5%85%B3%E6%8E%A5%E5%8F%A3.png)

**è¿™é‡Œæäº†å¾ˆå¤šåº•å±‚çš„ç±»å…³ç³»ï¼Œä½†æ˜¯ï¼Œå®é™…ä¸Šæˆ‘ä»¬éœ€è¦æ›´å¤šå…³æ³¨çš„æ˜¯ `ThreadPoolExecutor` è¿™ä¸ªç±»ï¼Œè¿™ä¸ªç±»åœ¨æˆ‘ä»¬å®é™…ä½¿ç”¨çº¿ç¨‹æ± çš„è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨é¢‘ç‡è¿˜æ˜¯éå¸¸é«˜çš„ã€‚**

> **æ³¨æ„ï¼š** é€šè¿‡æŸ¥çœ‹ `ScheduledThreadPoolExecutor` æºä»£ç æˆ‘ä»¬å‘ç° `ScheduledThreadPoolExecutor` å®é™…ä¸Šæ˜¯ç»§æ‰¿äº† `ThreadPoolExecutor` å¹¶å®ç°äº† ScheduledExecutorService ï¼Œè€Œ `ScheduledExecutorService` åˆå®ç°äº† `ExecutorService`ï¼Œæ­£å¦‚æˆ‘ä»¬ä¸‹é¢ç»™å‡ºçš„ç±»å…³ç³»å›¾æ˜¾ç¤ºçš„ä¸€æ ·ã€‚

**`ThreadPoolExecutor` ç±»æè¿°:**

```java
//AbstractExecutorServiceå®ç°äº†ExecutorServiceæ¥å£
public class ThreadPoolExecutor extends AbstractExecutorService
```

**`ScheduledThreadPoolExecutor` ç±»æè¿°:**

```java
//ScheduledExecutorServiceç»§æ‰¿ExecutorServiceæ¥å£
public class ScheduledThreadPoolExecutor
        extends ThreadPoolExecutor
        implements ScheduledExecutorService
```

### 2.2.3 å¼‚æ­¥è®¡ç®—çš„ç»“æœ(`Future`)

**`Future`** æ¥å£ä»¥åŠ `Future` æ¥å£çš„å®ç°ç±» **`FutureTask`** ç±»éƒ½å¯ä»¥ä»£è¡¨å¼‚æ­¥è®¡ç®—çš„ç»“æœã€‚

å½“æˆ‘ä»¬æŠŠ **`Runnable`æ¥å£** æˆ– **`Callable` æ¥å£** çš„å®ç°ç±»æäº¤ç»™ **`ThreadPoolExecutor`** æˆ– **`ScheduledThreadPoolExecutor`** æ‰§è¡Œã€‚ï¼ˆè°ƒç”¨ `submit()` æ–¹æ³•æ—¶ä¼šè¿”å›ä¸€ä¸ª **`FutureTask`** å¯¹è±¡ï¼‰

---

## 2.3 Executor æ¡†æ¶çš„ä½¿ç”¨ç¤ºæ„å›¾

![Executor æ¡†æ¶çš„ä½¿ç”¨ç¤ºæ„å›¾](https://github.com/Snailclimb/JavaGuide/raw/main/docs/java/concurrent/images/java-thread-pool-summary/Executor%E6%A1%86%E6%9E%B6%E7%9A%84%E4%BD%BF%E7%94%A8%E7%A4%BA%E6%84%8F%E5%9B%BE.png)

1. **ä¸»çº¿ç¨‹é¦–å…ˆè¦åˆ›å»ºå®ç° `Runnable` æˆ–è€… `Callable` æ¥å£çš„ä»»åŠ¡å¯¹è±¡ã€‚**
2. **æŠŠåˆ›å»ºå®Œæˆçš„å®ç° `Runnable`/`Callable`æ¥å£çš„ å¯¹è±¡ç›´æ¥äº¤ç»™ `ExecutorService` æ‰§è¡Œ**: `ExecutorService.executeï¼ˆRunnable commandï¼‰`ï¼‰æˆ–è€…ä¹Ÿå¯ä»¥æŠŠ `Runnable` å¯¹è±¡æˆ–`Callable` å¯¹è±¡æäº¤ç»™ `ExecutorService` æ‰§è¡Œï¼ˆ`ExecutorService.submitï¼ˆRunnable taskï¼‰`æˆ– `ExecutorService.submitï¼ˆCallable <T> taskï¼‰`ï¼‰ã€‚
3. **å¦‚æœæ‰§è¡Œ `ExecutorService.submitï¼ˆâ€¦ï¼‰`ï¼Œ`ExecutorService` å°†è¿”å›ä¸€ä¸ªå®ç°`Future`æ¥å£çš„å¯¹è±¡**ï¼ˆæˆ‘ä»¬åˆšåˆšä¹Ÿæåˆ°è¿‡äº†æ‰§è¡Œ `execute()`æ–¹æ³•å’Œ `submit()`æ–¹æ³•çš„åŒºåˆ«ï¼Œ`submit()`ä¼šè¿”å›ä¸€ä¸ª `FutureTask å¯¹è±¡ï¼‰ã€‚ç”±äº FutureTask` å®ç°äº† `Runnable`ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ›å»º `FutureTask`ï¼Œç„¶åç›´æ¥äº¤ç»™ `ExecutorService` æ‰§è¡Œã€‚
4. **æœ€åï¼Œä¸»çº¿ç¨‹å¯ä»¥æ‰§è¡Œ `FutureTask.get()`æ–¹æ³•æ¥ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚ä¸»çº¿ç¨‹ä¹Ÿå¯ä»¥æ‰§è¡Œ `FutureTask.cancelï¼ˆboolean mayInterruptIfRunningï¼‰`æ¥å–æ¶ˆæ­¤ä»»åŠ¡çš„æ‰§è¡Œã€‚**

---

# ä¸‰ã€(é‡è¦)ThreadPoolExecutor ç±»ç®€å•ä»‹ç»

**çº¿ç¨‹æ± å®ç°ç±» `ThreadPoolExecutor` æ˜¯ `Executor` æ¡†æ¶æœ€æ ¸å¿ƒçš„ç±»ã€‚**

## 3.1 ThreadPoolExecutor ç±»åˆ†æ

`ThreadPoolExecutor` ç±»ä¸­æä¾›çš„**å››ä¸ªæ„é€ æ–¹æ³•**ã€‚

æˆ‘ä»¬æ¥çœ‹æœ€é•¿çš„é‚£ä¸ªï¼Œå…¶ä½™ä¸‰ä¸ªéƒ½æ˜¯åœ¨è¿™ä¸ªæ„é€ æ–¹æ³•çš„åŸºç¡€ä¸Šäº§ç”Ÿï¼ˆå…¶ä»–å‡ ä¸ªæ„é€ æ–¹æ³•è¯´ç™½ç‚¹éƒ½æ˜¯ç»™å®šæŸäº›é»˜è®¤å‚æ•°çš„æ„é€ æ–¹æ³•æ¯”å¦‚é»˜è®¤åˆ¶å®šæ‹’ç»ç­–ç•¥æ˜¯ä»€ä¹ˆï¼‰ã€‚

```java
    /**
     * ç”¨ç»™å®šçš„åˆå§‹å‚æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ThreadPoolExecutorã€‚
     */
    public ThreadPoolExecutor(int corePoolSize,//çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°é‡
                              int maximumPoolSize,//çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°
                              long keepAliveTime,//å½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹å­˜æ´»çš„æœ€é•¿æ—¶é—´
                              TimeUnit unit,//æ—¶é—´å•ä½
                              BlockingQueue<Runnable> workQueue,//ä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨æ¥å‚¨å­˜ç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„é˜Ÿåˆ—
                              ThreadFactory threadFactory,//çº¿ç¨‹å·¥å‚ï¼Œç”¨æ¥åˆ›å»ºçº¿ç¨‹ï¼Œä¸€èˆ¬é»˜è®¤å³å¯
                              RejectedExecutionHandler handler//æ‹’ç»ç­–ç•¥ï¼Œå½“æäº¤çš„ä»»åŠ¡è¿‡å¤šè€Œä¸èƒ½åŠæ—¶å¤„ç†æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å®šåˆ¶ç­–ç•¥æ¥å¤„ç†ä»»åŠ¡
                               ) {
        if (corePoolSize < 0 ||
            maximumPoolSize <= 0 ||
            maximumPoolSize < corePoolSize ||
            keepAliveTime < 0)
            throw new IllegalArgumentException();
        if (workQueue == null || threadFactory == null || handler == null)
            throw new NullPointerException();
        this.corePoolSize = corePoolSize;
        this.maximumPoolSize = maximumPoolSize;
        this.workQueue = workQueue;
        this.keepAliveTime = unit.toNanos(keepAliveTime);
        this.threadFactory = threadFactory;
        this.handler = handler;
    }
```

ä¸‹é¢è¿™äº›å¯¹åˆ›å»ºéå¸¸é‡è¦ï¼Œåœ¨åé¢ä½¿ç”¨çº¿ç¨‹æ± çš„è¿‡ç¨‹ä¸­ä½ ä¸€å®šä¼šç”¨åˆ°ï¼æ‰€ä»¥ï¼ŒåŠ¡å¿…æ‹¿ç€å°æœ¬æœ¬è®°æ¸…æ¥šã€‚

> **`ThreadPoolExecutor` 3 ä¸ªæœ€é‡è¦çš„å‚æ•°ï¼š**

- **`corePoolSize` :** **æ ¸å¿ƒçº¿ç¨‹æ•°çº¿ç¨‹æ•°**å®šä¹‰äº†æœ€å°å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡ã€‚
- **`maximumPoolSize` :** å½“é˜Ÿåˆ—ä¸­å­˜æ”¾çš„ä»»åŠ¡è¾¾åˆ°é˜Ÿåˆ—å®¹é‡çš„æ—¶å€™ï¼Œå½“å‰å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡å˜ä¸º**æœ€å¤§çº¿ç¨‹æ•°**ã€‚
- **`workQueue`:** å½“æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœè¾¾åˆ°çš„è¯ï¼Œæ–°ä»»åŠ¡å°±ä¼šè¢«å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ã€‚**ä»»åŠ¡é˜Ÿåˆ—ã€‚**

`ThreadPoolExecutor`å…¶ä»–å¸¸è§å‚æ•° :

1. **`keepAliveTime`**:å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äº `corePoolSize` çš„æ—¶å€™ï¼Œå¦‚æœè¿™æ—¶æ²¡æœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œæ ¸å¿ƒçº¿ç¨‹å¤–çš„çº¿ç¨‹ä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯ä¼šç­‰å¾…ï¼Œç›´åˆ°ç­‰å¾…çš„æ—¶é—´è¶…è¿‡äº† `keepAliveTime`æ‰ä¼šè¢«å›æ”¶é”€æ¯ï¼›**éæ ¸å¿ƒçº¿ç¨‹å­˜æ´»æ—¶é—´**
2. **`unit`** : `keepAliveTime` å‚æ•°çš„æ—¶é—´å•ä½ã€‚
3. **`threadFactory`** :executor åˆ›å»ºæ–°çº¿ç¨‹çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚
4. **`handler`** :é¥±å’Œç­–ç•¥ã€‚å…³äºé¥±å’Œç­–ç•¥ä¸‹é¢å•ç‹¬ä»‹ç»ä¸€ä¸‹ã€‚

> **çº¿ç¨‹æ± ä¸­å„ä¸ªå‚æ•°çš„ç›¸äº’å…³ç³»**ï¼ˆå›¾ç‰‡æ¥æºï¼šã€ŠJava æ€§èƒ½è°ƒä¼˜å®æˆ˜ã€‹ï¼‰ï¼š

![çº¿ç¨‹æ± å„ä¸ªå‚æ•°çš„å…³ç³»](https://github.com/Snailclimb/JavaGuide/raw/main/docs/java/concurrent/images/java-thread-pool-summary/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%90%84%E4%B8%AA%E5%8F%82%E6%95%B0%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB.png)

> **`ThreadPoolExecutor` é¥±å’Œç­–ç•¥å®šä¹‰:**

å¦‚æœå½“å‰åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°é‡å¹¶ä¸”é˜Ÿåˆ—ä¹Ÿå·²ç»è¢«æ”¾æ»¡äº†ä»»åŠ¡æ—¶ï¼Œ`ThreadPoolTaskExecutor` å®šä¹‰ä¸€äº›ç­–ç•¥:

- **`ThreadPoolExecutor.AbortPolicy`** ï¼šæŠ›å‡º `RejectedExecutionException`æ¥æ‹’ç»æ–°ä»»åŠ¡çš„å¤„ç†ã€‚(**æŠ›å‡ºå¼‚å¸¸**)
- **`ThreadPoolExecutor.CallerRunsPolicy`** ï¼š**ä½¿ç”¨è°ƒç”¨è€…æ‰€åœ¨çº¿ç¨‹æ¥è¿è¡Œä»»åŠ¡**ã€‚å¦‚æœæ‰§è¡Œç¨‹åºå·²å…³é—­ï¼Œåˆ™ä¼šä¸¢å¼ƒè¯¥ä»»åŠ¡ã€‚å› æ­¤è¿™ç§ç­–ç•¥ä¼šé™ä½å¯¹äºæ–°ä»»åŠ¡æäº¤é€Ÿåº¦ï¼Œå½±å“ç¨‹åºçš„æ•´ä½“æ€§èƒ½ã€‚å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºå¯ä»¥æ‰¿å—æ­¤å»¶è¿Ÿå¹¶ä¸”ä½ è¦æ±‚ä»»ä½•ä¸€ä¸ªä»»åŠ¡è¯·æ±‚éƒ½è¦è¢«æ‰§è¡Œçš„è¯ï¼Œä½ å¯ä»¥é€‰æ‹©è¿™ä¸ªç­–ç•¥ã€‚
- **`ThreadPoolExecutor.DiscardPolicy`** ï¼š**ä¸å¤„ç†æ–°ä»»åŠ¡ï¼Œç›´æ¥ä¸¢å¼ƒæ‰**ã€‚(**é»˜é»˜ä¸¢å¼ƒï¼Œä¸æŠ›å‡ºå¼‚å¸¸**)
- **`ThreadPoolExecutor.DiscardOldestPolicy`** ï¼š æ­¤ç­–ç•¥å°†**ä¸¢å¼ƒæœ€æ—©çš„æœªå¤„ç†çš„ä»»åŠ¡è¯·æ±‚**ã€‚(**è°ƒç”¨pollä¸¢å¼ƒä¸€ä¸ªä»»åŠ¡ï¼Œæ‰§è¡Œå½“å‰ä»»åŠ¡**)

> ğŸ™‹â€â™‚ï¸ğŸŒ°

Spring é€šè¿‡ `ThreadPoolTaskExecutor` æˆ–è€…æˆ‘ä»¬ç›´æ¥é€šè¿‡ `ThreadPoolExecutor` çš„æ„é€ å‡½æ•°åˆ›å»ºçº¿ç¨‹æ± çš„æ—¶å€™

- å½“æˆ‘ä»¬ä¸æŒ‡å®š `RejectedExecutionHandler` é¥±å’Œç­–ç•¥çš„è¯æ¥é…ç½®çº¿ç¨‹æ± çš„æ—¶å€™é»˜è®¤ä½¿ç”¨çš„æ˜¯ `ThreadPoolExecutor.AbortPolicy`ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œ`ThreadPoolExecutor` å°†æŠ›å‡º `RejectedExecutionException` æ¥æ‹’ç»æ–°æ¥çš„ä»»åŠ¡ ï¼Œè¿™ä»£è¡¨ä½ å°†ä¸¢å¤±å¯¹è¿™ä¸ªä»»åŠ¡çš„å¤„ç†ã€‚
- å¯¹äºå¯ä¼¸ç¼©çš„åº”ç”¨ç¨‹åºï¼Œå»ºè®®ä½¿ç”¨ `ThreadPoolExecutor.CallerRunsPolicy`ã€‚å½“æœ€å¤§æ± è¢«å¡«æ»¡æ—¶ï¼Œæ­¤ç­–ç•¥ä¸ºæˆ‘ä»¬æä¾›å¯ä¼¸ç¼©é˜Ÿåˆ—ã€‚ï¼ˆè¿™ä¸ªç›´æ¥æŸ¥çœ‹ `ThreadPoolExecutor` çš„æ„é€ å‡½æ•°æºç å°±å¯ä»¥çœ‹å‡ºï¼Œæ¯”è¾ƒç®€å•çš„åŸå› ï¼Œè¿™é‡Œå°±ä¸è´´ä»£ç äº†ã€‚ï¼‰

## 3.2 ä½¿ç”¨ `ThreadPoolExecutor` æ„é€ å‡½æ•°åˆ›å»ºçº¿ç¨‹æ± 

> **çº¿ç¨‹èµ„æºå¿…é¡»é€šè¿‡çº¿ç¨‹æ± æä¾›ï¼Œä¸å…è®¸åœ¨åº”ç”¨ä¸­è‡ªè¡Œæ˜¾å¼åˆ›å»ºçº¿ç¨‹**

åœ¨ã€Šé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œã€‹â€œå¹¶å‘å¤„ç†â€è¿™ä¸€ç« èŠ‚ï¼Œæ˜ç¡®æŒ‡å‡º**çº¿ç¨‹èµ„æºå¿…é¡»é€šè¿‡çº¿ç¨‹æ± æä¾›ï¼Œä¸å…è®¸åœ¨åº”ç”¨ä¸­è‡ªè¡Œæ˜¾å¼åˆ›å»ºçº¿ç¨‹ã€‚**

**åŸå› **

ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„æ˜¯å‡å°‘åœ¨åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ä¸Šæ‰€æ¶ˆè€—çš„æ—¶é—´ä»¥åŠç³»ç»Ÿèµ„æºå¼€é”€ï¼Œè§£å†³èµ„æºä¸è¶³çš„é—®é¢˜ã€‚å¦‚æœä¸ä½¿ç”¨çº¿ç¨‹æ± ï¼Œæœ‰å¯èƒ½ä¼šé€ æˆç³»ç»Ÿåˆ›å»ºå¤§é‡åŒç±»çº¿ç¨‹è€Œå¯¼è‡´æ¶ˆè€—å®Œå†…å­˜æˆ–è€…â€œè¿‡åº¦åˆ‡æ¢â€çš„é—®é¢˜ã€‚

> **åˆ›å»ºçº¿ç¨‹æ± **

**æ–¹å¼ä¸€ï¼šé€šè¿‡`ThreadPoolExecutor`æ„é€ å‡½æ•°å®ç°ï¼ˆæ¨èï¼‰**
![é€šè¿‡æ„é€ æ–¹æ³•å®ç°](https://github.com/Snailclimb/JavaGuide/raw/main/docs/java/concurrent/images/java-thread-pool-summary/threadpoolexecutor%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0.png)

**æ–¹å¼äºŒï¼šé€šè¿‡ `Executor` æ¡†æ¶çš„å·¥å…·ç±» `Executors` æ¥å®ç°**
æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸‰ç§ç±»å‹çš„ `ThreadPoolExecutor`ï¼š

- `FixedThreadPool`
- `SingleThreadExecutor`
- `CachedThreadPool`

å¦å¤–ï¼Œã€Šé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œã€‹ä¸­å¼ºåˆ¶çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨ `Executors` å»åˆ›å»ºï¼Œè€Œæ˜¯**é€šè¿‡ `ThreadPoolExecutor` æ„é€ å‡½æ•°**çš„æ–¹å¼ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼è®©å†™çš„åŒå­¦æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©

> `Executors` è¿”å›çº¿ç¨‹æ± å¯¹è±¡çš„å¼Šç«¯å¦‚ä¸‹(åæ–‡ä¼šè¯¦ç»†ä»‹ç»åˆ°)ï¼š

- **`FixedThreadPool` å’Œ `SingleThreadExecutor`** ï¼š å…è®¸è¯·æ±‚çš„é˜Ÿåˆ—é•¿åº¦ä¸º `Integer.MAX_VALUE`,å¯èƒ½å †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚
- **`CachedThreadPool` å’Œ `ScheduledThreadPool`** ï¼š å…è®¸åˆ›å»ºçš„çº¿ç¨‹æ•°é‡ä¸º `Integer.MAX_VALUE` ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ OOMã€‚

å¯¹åº” Executors å·¥å…·ç±»ä¸­çš„æ–¹æ³•å¦‚å›¾æ‰€ç¤ºï¼š

![é€šè¿‡Executor æ¡†æ¶çš„å·¥å…·ç±»Executorsæ¥å®ç°](https://github.com/Snailclimb/JavaGuide/raw/main/docs/java/concurrent/images/java-thread-pool-summary/Executors%E5%B7%A5%E5%85%B7%E7%B1%BB.png)

# å››ã€ ThreadPoolExecutor ä½¿ç”¨+åŸç†åˆ†æ

æˆ‘ä»¬ä¸Šé¢è®²è§£äº† `Executor`æ¡†æ¶ä»¥åŠ `ThreadPoolExecutor` ç±»ï¼Œä¸‹é¢è®©æˆ‘ä»¬å®æˆ˜ä¸€ä¸‹ï¼Œæ¥é€šè¿‡å†™ä¸€ä¸ª `ThreadPoolExecutor` çš„å° Demo æ¥å›é¡¾ä¸Šé¢çš„å†…å®¹ã€‚

## 4.1 ç¤ºä¾‹ä»£ç :`Runnable`+`ThreadPoolExecutor`

> é¦–å…ˆåˆ›å»ºä¸€ä¸ª `Runnable` æ¥å£çš„å®ç°ç±»ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥æ˜¯ `Callable` æ¥å£ï¼Œæˆ‘ä»¬ä¸Šé¢ä¹Ÿè¯´äº†ä¸¤è€…çš„åŒºåˆ«ã€‚ï¼‰

`MyRunnable.java`

```java
import java.util.Date;

/**
 * è¿™æ˜¯ä¸€ä¸ªç®€å•çš„Runnableç±»ï¼Œéœ€è¦å¤§çº¦5ç§’é’Ÿæ¥æ‰§è¡Œå…¶ä»»åŠ¡ã€‚
 * @author shuang.kou
 */
public class MyRunnable implements Runnable {

    private String command;

    public MyRunnable(String s) {
        this.command = s;
    }

    @Override
    public void run() {
        System.out.println(Thread.currentThread().getName() + " Start. Time = " + new Date());
        processCommand();
        System.out.println(Thread.currentThread().getName() + " End. Time = " + new Date());
    }

    private void processCommand() {
        try {
            Thread.sleep(5000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }

    @Override
    public String toString() {
        return this.command;
    }
}

```

> ç¼–å†™æµ‹è¯•ç¨‹åºï¼Œæˆ‘ä»¬è¿™é‡Œä»¥é˜¿é‡Œå·´å·´æ¨èçš„ä½¿ç”¨ `ThreadPoolExecutor` æ„é€ å‡½æ•°è‡ªå®šä¹‰å‚æ•°çš„æ–¹å¼æ¥åˆ›å»ºçº¿ç¨‹æ± ã€‚

`ThreadPoolExecutorDemo.java`

```java
import java.util.concurrent.ArrayBlockingQueue;
import java.util.concurrent.ThreadPoolExecutor;
import java.util.concurrent.TimeUnit;

public class ThreadPoolExecutorDemo {

    private static final int CORE_POOL_SIZE = 5;
    private static final int MAX_POOL_SIZE = 10;
    private static final int QUEUE_CAPACITY = 100;
    private static final Long KEEP_ALIVE_TIME = 1L;
    public static void main(String[] args) {

        //ä½¿ç”¨é˜¿é‡Œå·´å·´æ¨èçš„åˆ›å»ºçº¿ç¨‹æ± çš„æ–¹å¼
        //é€šè¿‡ThreadPoolExecutoræ„é€ å‡½æ•°è‡ªå®šä¹‰å‚æ•°åˆ›å»º
        ThreadPoolExecutor executor = new ThreadPoolExecutor(
                CORE_POOL_SIZE,
                MAX_POOL_SIZE,
                KEEP_ALIVE_TIME,
                TimeUnit.SECONDS,
                new ArrayBlockingQueue<>(QUEUE_CAPACITY),
                new ThreadPoolExecutor.CallerRunsPolicy());

        for (int i = 0; i < 10; i++) {
            //åˆ›å»ºWorkerThreadå¯¹è±¡ï¼ˆWorkerThreadç±»å®ç°äº†Runnable æ¥å£ï¼‰
            Runnable worker = new MyRunnable("" + i);
            //æ‰§è¡ŒRunnable
            executor.execute(worker);
        }
        //ç»ˆæ­¢çº¿ç¨‹æ± 
        executor.shutdown();
        while (!executor.isTerminated()) {
        }
        System.out.println("Finished all threads");
    }
}

```

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¸Šé¢çš„ä»£ç æŒ‡å®šäº†ï¼š

1. `corePoolSize`: æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º 5ã€‚
2. `maximumPoolSize` ï¼šæœ€å¤§çº¿ç¨‹æ•° 10
3. `keepAliveTime` : ç­‰å¾…æ—¶é—´ä¸º 1Lã€‚
4. `unit`: ç­‰å¾…æ—¶é—´çš„å•ä½ä¸º TimeUnit.SECONDSã€‚
5. `workQueue`ï¼šä»»åŠ¡é˜Ÿåˆ—ä¸º `ArrayBlockingQueue`ï¼Œå¹¶ä¸”å®¹é‡ä¸º 100;
6. `handler`:é¥±å’Œç­–ç•¥ä¸º `CallerRunsPolicy`ã€‚

**Outputï¼š**

```
pool-1-thread-3 Start. Time = Sun Apr 12 11:14:37 CST 2020
pool-1-thread-5 Start. Time = Sun Apr 12 11:14:37 CST 2020
pool-1-thread-2 Start. Time = Sun Apr 12 11:14:37 CST 2020
pool-1-thread-1 Start. Time = Sun Apr 12 11:14:37 CST 2020
pool-1-thread-4 Start. Time = Sun Apr 12 11:14:37 CST 2020
pool-1-thread-3 End. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-4 End. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-1 End. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-5 End. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-1 Start. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-2 End. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-5 Start. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-4 Start. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-3 Start. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-2 Start. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-1 End. Time = Sun Apr 12 11:14:47 CST 2020
pool-1-thread-4 End. Time = Sun Apr 12 11:14:47 CST 2020
pool-1-thread-5 End. Time = Sun Apr 12 11:14:47 CST 2020
pool-1-thread-3 End. Time = Sun Apr 12 11:14:47 CST 2020
pool-1-thread-2 End. Time = Sun Apr 12 11:14:47 CST 2020

```

---

## 4.2 çº¿ç¨‹æ± åŸç†åˆ†æ

æ‰¿æ¥ 4.1 èŠ‚ï¼Œæˆ‘ä»¬é€šè¿‡ä»£ç è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºï¼š**çº¿ç¨‹æ± é¦–å…ˆä¼šå…ˆæ‰§è¡Œ 5 ä¸ªä»»åŠ¡ï¼Œç„¶åè¿™äº›ä»»åŠ¡æœ‰ä»»åŠ¡è¢«æ‰§è¡Œå®Œçš„è¯ï¼Œå°±ä¼šå»æ‹¿æ–°çš„ä»»åŠ¡æ‰§è¡Œã€‚** å¤§å®¶å¯ä»¥å…ˆé€šè¿‡ä¸Šé¢è®²è§£çš„å†…å®¹ï¼Œåˆ†æä¸€ä¸‹åˆ°åº•æ˜¯å’‹å›äº‹ï¼Ÿï¼ˆè‡ªå·±ç‹¬ç«‹æ€è€ƒä¸€ä¼šï¼‰

ç°åœ¨ï¼Œæˆ‘ä»¬å°±åˆ†æä¸Šé¢çš„è¾“å‡ºå†…å®¹æ¥ç®€å•åˆ†æä¸€ä¸‹çº¿ç¨‹æ± åŸç†ã€‚

> `execute`**æ–¹æ³•**

**ä¸ºäº†ææ‡‚çº¿ç¨‹æ± çš„åŸç†ï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆåˆ†æä¸€ä¸‹ `execute`æ–¹æ³•ã€‚** åœ¨ 4.1 èŠ‚ä¸­çš„ Demo ä¸­æˆ‘ä»¬ä½¿ç”¨ `executor.execute(worker)`æ¥æäº¤ä¸€ä¸ªä»»åŠ¡åˆ°çº¿ç¨‹æ± ä¸­å»ï¼Œè¿™ä¸ªæ–¹æ³•éå¸¸é‡è¦ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„æºç ï¼š

```java
   // å­˜æ”¾çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ (runState) å’Œçº¿ç¨‹æ± å†…æœ‰æ•ˆçº¿ç¨‹çš„æ•°é‡ (workerCount)
   private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));

    private static int workerCountOf(int c) {
        return c & CAPACITY;
    }
    //ä»»åŠ¡é˜Ÿåˆ—
    private final BlockingQueue<Runnable> workQueue;

    public void execute(Runnable command) {
        // å¦‚æœä»»åŠ¡ä¸ºnullï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚
        if (command == null)
            throw new NullPointerException();
        // ctl ä¸­ä¿å­˜çš„çº¿ç¨‹æ± å½“å‰çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯
        int c = ctl.get();

        //  ä¸‹é¢ä¼šæ¶‰åŠåˆ° 3 æ­¥ æ“ä½œ
        // 1.é¦–å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ± ä¸­ä¹‹è¡Œçš„ä»»åŠ¡æ•°é‡æ˜¯å¦å°äº corePoolSize
        // å¦‚æœå°äºçš„è¯ï¼Œé€šè¿‡addWorker(command, true)æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶å°†ä»»åŠ¡(command)æ·»åŠ åˆ°è¯¥çº¿ç¨‹ä¸­ï¼›ç„¶åï¼Œå¯åŠ¨è¯¥çº¿ç¨‹ä»è€Œæ‰§è¡Œä»»åŠ¡ã€‚
        if (workerCountOf(c) < corePoolSize) {
            if (addWorker(command, true))
                return;
            c = ctl.get();
        }
        // 2.å¦‚æœå½“å‰ä¹‹è¡Œçš„ä»»åŠ¡æ•°é‡å¤§äºç­‰äº corePoolSize çš„æ—¶å€™å°±ä¼šèµ°åˆ°è¿™é‡Œ
        // é€šè¿‡ isRunning æ–¹æ³•åˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€ï¼Œçº¿ç¨‹æ± å¤„äº RUNNING çŠ¶æ€å¹¶ä¸”é˜Ÿåˆ—å¯ä»¥åŠ å…¥ä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡æ‰ä¼šè¢«åŠ å…¥è¿›å»
        if (isRunning(c) && workQueue.offer(command)) {
            int recheck = ctl.get();
            // å†æ¬¡è·å–çº¿ç¨‹æ± çŠ¶æ€ï¼Œå¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸æ˜¯ RUNNING çŠ¶æ€å°±éœ€è¦ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­ç§»é™¤ä»»åŠ¡ï¼Œå¹¶å°è¯•åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ã€‚åŒæ—¶æ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚
            if (!isRunning(recheck) && remove(command))
                reject(command);
                // å¦‚æœå½“å‰çº¿ç¨‹æ± ä¸ºç©ºå°±æ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¹¶æ‰§è¡Œã€‚
            else if (workerCountOf(recheck) == 0)
                addWorker(null, false);
        }
        //3. é€šè¿‡addWorker(command, false)æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶å°†ä»»åŠ¡(command)æ·»åŠ åˆ°è¯¥çº¿ç¨‹ä¸­ï¼›ç„¶åï¼Œå¯åŠ¨è¯¥çº¿ç¨‹ä»è€Œæ‰§è¡Œä»»åŠ¡ã€‚
        //å¦‚æœaddWorker(command, false)æ‰§è¡Œå¤±è´¥ï¼Œåˆ™é€šè¿‡reject()æ‰§è¡Œç›¸åº”çš„æ‹’ç»ç­–ç•¥çš„å†…å®¹ã€‚
        else if (!addWorker(command, false))
            reject(command);
    }
```

é€šè¿‡ä¸‹å›¾å¯ä»¥æ›´å¥½çš„å¯¹ä¸Šé¢è¿™ 3 æ­¥åšä¸€ä¸ªå±•ç¤ºï¼Œä¸‹å›¾æ˜¯æˆ‘ä¸ºäº†çœäº‹ç›´æ¥ä»ç½‘ä¸Šæ‰¾åˆ°ï¼ŒåŸåœ°å€ä¸æ˜ã€‚

![å›¾è§£çº¿ç¨‹æ± å®ç°åŸç†](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/javaguide/%E5%9B%BE%E8%A7%A3%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86.png)

> **`addWorker` è¿™ä¸ªæ–¹æ³•ä¸»è¦ç”¨æ¥åˆ›å»ºæ–°çš„å·¥ä½œçº¿ç¨‹ï¼Œå¦‚æœè¿”å› true è¯´æ˜åˆ›å»ºå’Œå¯åŠ¨å·¥ä½œçº¿ç¨‹æˆåŠŸï¼Œå¦åˆ™çš„è¯è¿”å›çš„å°±æ˜¯ falseã€‚**

```java
    // å…¨å±€é”ï¼Œå¹¶å‘æ“ä½œå¿…å¤‡
    private final ReentrantLock mainLock = new ReentrantLock();
    // è·Ÿè¸ªçº¿ç¨‹æ± çš„æœ€å¤§å¤§å°ï¼Œåªæœ‰åœ¨æŒæœ‰å…¨å±€é”mainLockçš„å‰æä¸‹æ‰èƒ½è®¿é—®æ­¤é›†åˆ
    private int largestPoolSize;
    // å·¥ä½œçº¿ç¨‹é›†åˆï¼Œå­˜æ”¾çº¿ç¨‹æ± ä¸­æ‰€æœ‰çš„ï¼ˆæ´»è·ƒçš„ï¼‰å·¥ä½œçº¿ç¨‹ï¼Œåªæœ‰åœ¨æŒæœ‰å…¨å±€é”mainLockçš„å‰æä¸‹æ‰èƒ½è®¿é—®æ­¤é›†åˆ
    private final HashSet<Worker> workers = new HashSet<>();
    //è·å–çº¿ç¨‹æ± çŠ¶æ€
    private static int runStateOf(int c)     { return c & ~CAPACITY; }
    //åˆ¤æ–­çº¿ç¨‹æ± çš„çŠ¶æ€æ˜¯å¦ä¸º Running
    private static boolean isRunning(int c) {
        return c < SHUTDOWN;
    }


    /**
     * æ·»åŠ æ–°çš„å·¥ä½œçº¿ç¨‹åˆ°çº¿ç¨‹æ± 
     * @param firstTask è¦æ‰§è¡Œ
     * @param coreå‚æ•°ä¸ºtrueçš„è¯è¡¨ç¤ºä½¿ç”¨çº¿ç¨‹æ± çš„åŸºæœ¬å¤§å°ï¼Œä¸ºfalseä½¿ç”¨çº¿ç¨‹æ± æœ€å¤§å¤§å°
     * @return æ·»åŠ æˆåŠŸå°±è¿”å›trueå¦åˆ™è¿”å›false
     */
   private boolean addWorker(Runnable firstTask, boolean core) {
        retry:
        for (;;) {
            //è¿™ä¸¤å¥ç”¨æ¥è·å–çº¿ç¨‹æ± çš„çŠ¶æ€
            int c = ctl.get();
            int rs = runStateOf(c);

            // Check if queue empty only if necessary.
            if (rs >= SHUTDOWN &&
                ! (rs == SHUTDOWN &&
                   firstTask == null &&
                   ! workQueue.isEmpty()))
                return false;

            for (;;) {
               //è·å–çº¿ç¨‹æ± ä¸­å·¥ä½œçš„çº¿ç¨‹çš„æ•°é‡
                int wc = workerCountOf(c);
                // coreå‚æ•°ä¸ºtrueçš„è¯è¡¨æ˜é˜Ÿåˆ—ä¹Ÿæ»¡äº†ï¼Œçº¿ç¨‹æ± å¤§å°å˜ä¸º maximumPoolSize
                if (wc >= CAPACITY ||
                    wc >= (core ? corePoolSize : maximumPoolSize))
                    return false;
               //åŸå­æ“ä½œå°†workcountçš„æ•°é‡åŠ 1
                if (compareAndIncrementWorkerCount(c))
                    break retry;
                // å¦‚æœçº¿ç¨‹çš„çŠ¶æ€æ”¹å˜äº†å°±å†æ¬¡æ‰§è¡Œä¸Šè¿°æ“ä½œ
                c = ctl.get();
                if (runStateOf(c) != rs)
                    continue retry;
                // else CAS failed due to workerCount change; retry inner loop
            }
        }
        // æ ‡è®°å·¥ä½œçº¿ç¨‹æ˜¯å¦å¯åŠ¨æˆåŠŸ
        boolean workerStarted = false;
        // æ ‡è®°å·¥ä½œçº¿ç¨‹æ˜¯å¦åˆ›å»ºæˆåŠŸ
        boolean workerAdded = false;
        Worker w = null;
        try {

            w = new Worker(firstTask);
            final Thread t = w.thread;
            if (t != null) {
              // åŠ é”
                final ReentrantLock mainLock = this.mainLock;
                mainLock.lock();
                try {
                   //è·å–çº¿ç¨‹æ± çŠ¶æ€
                    int rs = runStateOf(ctl.get());
                   //rs < SHUTDOWN å¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¾ç„¶ä¸ºRUNNING,å¹¶ä¸”çº¿ç¨‹çš„çŠ¶æ€æ˜¯å­˜æ´»çš„è¯ï¼Œå°±ä¼šå°†å·¥ä½œçº¿ç¨‹æ·»åŠ åˆ°å·¥ä½œçº¿ç¨‹é›†åˆä¸­
                  //(rs=SHUTDOWN && firstTask == null)å¦‚æœçº¿ç¨‹æ± çŠ¶æ€å°äºSTOPï¼Œä¹Ÿå°±æ˜¯RUNNINGæˆ–è€…SHUTDOWNçŠ¶æ€ä¸‹ï¼ŒåŒæ—¶ä¼ å…¥çš„ä»»åŠ¡å®ä¾‹firstTaskä¸ºnullï¼Œåˆ™éœ€è¦æ·»åŠ åˆ°å·¥ä½œçº¿ç¨‹é›†åˆå’Œå¯åŠ¨æ–°çš„Worker
                   // firstTask == nullè¯æ˜åªæ–°å»ºçº¿ç¨‹è€Œä¸æ‰§è¡Œä»»åŠ¡
                    if (rs < SHUTDOWN ||
                        (rs == SHUTDOWN && firstTask == null)) {
                        if (t.isAlive()) // precheck that t is startable
                            throw new IllegalThreadStateException();
                        workers.add(w);
                       //æ›´æ–°å½“å‰å·¥ä½œçº¿ç¨‹çš„æœ€å¤§å®¹é‡
                        int s = workers.size();
                        if (s > largestPoolSize)
                            largestPoolSize = s;
                      // å·¥ä½œçº¿ç¨‹æ˜¯å¦å¯åŠ¨æˆåŠŸ
                        workerAdded = true;
                    }
                } finally {
                    // é‡Šæ”¾é”
                    mainLock.unlock();
                }
                //// å¦‚æœæˆåŠŸæ·»åŠ å·¥ä½œçº¿ç¨‹ï¼Œåˆ™è°ƒç”¨Workerå†…éƒ¨çš„çº¿ç¨‹å®ä¾‹tçš„Thread#start()æ–¹æ³•å¯åŠ¨çœŸå®çš„çº¿ç¨‹å®ä¾‹
                if (workerAdded) {
                    t.start();
                  /// æ ‡è®°çº¿ç¨‹å¯åŠ¨æˆåŠŸ
                    workerStarted = true;
                }
            }
        } finally {
           // çº¿ç¨‹å¯åŠ¨å¤±è´¥ï¼Œéœ€è¦ä»å·¥ä½œçº¿ç¨‹ä¸­ç§»é™¤å¯¹åº”çš„Worker
            if (! workerStarted)
                addWorkerFailed(w);
        }
        return workerStarted;
    }
```

æ›´å¤šå…³äºçº¿ç¨‹æ± æºç åˆ†æçš„å†…å®¹æ¨èè¿™ç¯‡æ–‡ç« ï¼šç¡¬æ ¸å¹²è´§ï¼š[4Wå­—ä»æºç ä¸Šåˆ†æJUCçº¿ç¨‹æ± ThreadPoolExecutorçš„å®ç°åŸç†](https://www.throwx.cn/2020/08/23/java-concurrency-thread-pool-executor/)

ç°åœ¨ï¼Œè®©æˆ‘ä»¬åœ¨å›åˆ° 4.1 èŠ‚æˆ‘ä»¬å†™çš„ Demoï¼Œ ç°åœ¨åº”è¯¥æ˜¯ä¸æ˜¯å¾ˆå®¹æ˜“å°±å¯ä»¥ææ‡‚å®ƒçš„åŸç†äº†å‘¢ï¼Ÿ

æ²¡ææ‡‚çš„è¯ï¼Œä¹Ÿæ²¡å…³ç³»ï¼Œå¯ä»¥çœ‹çœ‹æˆ‘çš„åˆ†æï¼š

> æˆ‘ä»¬åœ¨ä»£ç ä¸­æ¨¡æ‹Ÿäº† 10 ä¸ªä»»åŠ¡ï¼Œæˆ‘ä»¬é…ç½®çš„æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º 5 ã€ç­‰å¾…é˜Ÿåˆ—å®¹é‡ä¸º 100 ï¼Œæ‰€ä»¥æ¯æ¬¡åªå¯èƒ½å­˜åœ¨ 5 ä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼Œå‰©ä¸‹çš„ 5 ä¸ªä»»åŠ¡ä¼šè¢«æ”¾åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­å»ã€‚å½“å‰çš„ 5 ä¸ªä»»åŠ¡ä¸­å¦‚æœæœ‰ä»»åŠ¡è¢«æ‰§è¡Œå®Œäº†ï¼Œçº¿ç¨‹æ± å°±ä¼šå»æ‹¿æ–°çš„ä»»åŠ¡æ‰§è¡Œã€‚

---

## 4.3 å‡ ä¸ªå¸¸è§çš„å¯¹æ¯”

### 4.3.1 `Runnable` vs `Callable`

> **ä¸»è¦åŒºåˆ«**

`Runnable`è‡ª Java 1.0 ä»¥æ¥ä¸€ç›´å­˜åœ¨ï¼Œä½†`Callable`ä»…åœ¨ Java 1.5 ä¸­å¼•å…¥,ç›®çš„å°±æ˜¯ä¸ºäº†æ¥å¤„ç†`Runnable`ä¸æ”¯æŒçš„ç”¨ä¾‹ã€‚**`Runnable` æ¥å£**ä¸ä¼šè¿”å›ç»“æœæˆ–æŠ›å‡ºæ£€æŸ¥å¼‚å¸¸ï¼Œä½†æ˜¯ **`Callable` æ¥å£**å¯ä»¥ã€‚æ‰€ä»¥ï¼Œå¦‚æœä»»åŠ¡ä¸éœ€è¦è¿”å›ç»“æœæˆ–æŠ›å‡ºå¼‚å¸¸æ¨èä½¿ç”¨ **`Runnable` æ¥å£**ï¼Œè¿™æ ·ä»£ç çœ‹èµ·æ¥ä¼šæ›´åŠ ç®€æ´ã€‚

> **åˆ©ç”¨`Executors`å°† `Runnable` å¯¹è±¡è½¬æ¢æˆ `Callable` å¯¹è±¡**

å·¥å…·ç±» `Executors` å¯ä»¥å®ç°å°† `Runnable` å¯¹è±¡è½¬æ¢æˆ `Callable` å¯¹è±¡ã€‚ï¼ˆ`Executors.callable(Runnable task)` æˆ– `Executors.callable(Runnable task, Object result)`ï¼‰ã€‚

`Runnable.java`

```java
@FunctionalInterface
public interface Runnable {
   /**
    * è¢«çº¿ç¨‹æ‰§è¡Œï¼Œæ²¡æœ‰è¿”å›å€¼ä¹Ÿæ— æ³•æŠ›å‡ºå¼‚å¸¸
    */
    public abstract void run();
}
```

`Callable.java`

```java
@FunctionalInterface
public interface Callable<V> {
    /**
     * è®¡ç®—ç»“æœï¼Œæˆ–åœ¨æ— æ³•è¿™æ ·åšæ—¶æŠ›å‡ºå¼‚å¸¸ã€‚
     * @return è®¡ç®—å¾—å‡ºçš„ç»“æœ
     * @throws å¦‚æœæ— æ³•è®¡ç®—ç»“æœï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
     */
    V call() throws Exception;
}

```

### 4.3.2 `execute()` vs `submit()`

- `execute()`æ–¹æ³•ç”¨äº**æäº¤ä¸éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡**ï¼Œæ‰€ä»¥æ— æ³•åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«çº¿ç¨‹æ± æ‰§è¡ŒæˆåŠŸä¸å¦ï¼›
- `submit()`æ–¹æ³•ç”¨äº**æäº¤éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡**ã€‚çº¿ç¨‹æ± ä¼šè¿”å›ä¸€ä¸ª `Future` ç±»å‹çš„å¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ª `Future` å¯¹è±¡å¯ä»¥åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ `Future` çš„ `get()`æ–¹æ³•æ¥è·å–è¿”å›å€¼ï¼Œ`get()`æ–¹æ³•ä¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°ä»»åŠ¡å®Œæˆï¼Œè€Œä½¿ç”¨ `getï¼ˆlong timeoutï¼ŒTimeUnit unitï¼‰`æ–¹æ³•çš„è¯ï¼Œå¦‚æœåœ¨ `timeout` æ—¶é—´å†…ä»»åŠ¡è¿˜æ²¡æœ‰æ‰§è¡Œå®Œï¼Œå°±ä¼šæŠ›å‡º `java.util.concurrent.TimeoutException`ã€‚


> ğŸ™‹â€â™‚ï¸ğŸŒ°

è¿™é‡Œåªæ˜¯ä¸ºäº†æ¼”ç¤ºä½¿ç”¨ï¼Œæ¨èä½¿ç”¨ `ThreadPoolExecutor` æ„é€ æ–¹æ³•æ¥åˆ›å»ºçº¿ç¨‹æ± ã€‚

ç¤ºä¾‹1ï¼šä½¿ç”¨ `get() `æ–¹æ³•è·å–è¿”å›å€¼ã€‚

```java
ExecutorService executorService = Executors.newFixedThreadPool(3);

Future<String> submit = executorService.submit(() -> {
    try {
        Thread.sleep(5000L);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    return "abc";
});

String s = submit.get();
System.out.println(s);
executorService.shutdown();
```

è¾“å‡ºï¼š

```
abc
```

ç¤ºä¾‹2ï¼šä½¿ç”¨ `getï¼ˆlong timeoutï¼ŒTimeUnit unitï¼‰ `æ–¹æ³•è·å–è¿”å›å€¼ã€‚

```java
ExecutorService executorService = Executors.newFixedThreadPool(3);

Future<String> submit = executorService.submit(() -> {
    try {
        Thread.sleep(5000L);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    return "abc";
});

String s = submit.get(3, TimeUnit.SECONDS);
System.out.println(s);
executorService.shutdown();
```

è¾“å‡ºï¼š

```
Exception in thread "main" java.util.concurrent.TimeoutException
	at java.util.concurrent.FutureTask.get(FutureTask.java:205)
```

### 4.3.3 `shutdown()`VS`shutdownNow()`

- **`shutdownï¼ˆï¼‰`** :å…³é—­çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ± çš„çŠ¶æ€å˜ä¸º `SHUTDOWN`ã€‚çº¿ç¨‹æ± ä¸å†æ¥å—æ–°ä»»åŠ¡äº†ï¼Œä½†æ˜¯é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡å¾—æ‰§è¡Œå®Œæ¯•ã€‚
- **`shutdownNowï¼ˆï¼‰`** :å…³é—­çº¿ç¨‹æ± ï¼Œçº¿ç¨‹çš„çŠ¶æ€å˜ä¸º `STOP`ã€‚çº¿ç¨‹æ± ä¼šç»ˆæ­¢å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œå¹¶åœæ­¢å¤„ç†æ’é˜Ÿçš„ä»»åŠ¡å¹¶è¿”å›æ­£åœ¨ç­‰å¾…æ‰§è¡Œçš„ Listã€‚

### 4.3.4 `isTerminated()` VS `isShutdown()`

- **`isShutDown`** å½“è°ƒç”¨ `shutdown()` æ–¹æ³•åè¿”å›ä¸º trueã€‚
- **`isTerminated`** å½“è°ƒç”¨ `shutdown()` æ–¹æ³•åï¼Œå¹¶ä¸”æ‰€æœ‰æäº¤çš„ä»»åŠ¡å®Œæˆåè¿”å›ä¸º true

---

## 4.4 `Callable`+`ThreadPoolExecutor`ç¤ºä¾‹ä»£ç 

`MyCallable.java`

```java

import java.util.concurrent.Callable;

public class MyCallable implements Callable<String> {
    @Override
    public String call() throws Exception {
        Thread.sleep(1000);
        //è¿”å›æ‰§è¡Œå½“å‰ Callable çš„çº¿ç¨‹åå­—
        return Thread.currentThread().getName();
    }
}
```

`CallableDemo.java`

```java

import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.concurrent.ArrayBlockingQueue;
import java.util.concurrent.Callable;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.Future;
import java.util.concurrent.ThreadPoolExecutor;
import java.util.concurrent.TimeUnit;

public class CallableDemo {

    private static final int CORE_POOL_SIZE = 5;
    private static final int MAX_POOL_SIZE = 10;
    private static final int QUEUE_CAPACITY = 100;
    private static final Long KEEP_ALIVE_TIME = 1L;

    public static void main(String[] args) {

        //ä½¿ç”¨é˜¿é‡Œå·´å·´æ¨èçš„åˆ›å»ºçº¿ç¨‹æ± çš„æ–¹å¼
        //é€šè¿‡ThreadPoolExecutoræ„é€ å‡½æ•°è‡ªå®šä¹‰å‚æ•°åˆ›å»º
        ThreadPoolExecutor executor = new ThreadPoolExecutor(
                CORE_POOL_SIZE,
                MAX_POOL_SIZE,
                KEEP_ALIVE_TIME,
                TimeUnit.SECONDS,
                new ArrayBlockingQueue<>(QUEUE_CAPACITY),
                new ThreadPoolExecutor.CallerRunsPolicy());

        List<Future<String>> futureList = new ArrayList<>();
        Callable<String> callable = new MyCallable();
        for (int i = 0; i < 10; i++) {
            //æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± 
            Future<String> future = executor.submit(callable);
            //å°†è¿”å›å€¼ future æ·»åŠ åˆ° listï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ future è·å¾— æ‰§è¡Œ Callable å¾—åˆ°çš„è¿”å›å€¼
            futureList.add(future);
        }
        for (Future<String> fut : futureList) {
            try {
                System.out.println(new Date() + "::" + fut.get());
            } catch (InterruptedException | ExecutionException e) {
                e.printStackTrace();
            }
        }
        //å…³é—­çº¿ç¨‹æ± 
        executor.shutdown();
    }
}
```

Output:

```
Wed Nov 13 13:40:41 CST 2019::pool-1-thread-1
Wed Nov 13 13:40:42 CST 2019::pool-1-thread-2
Wed Nov 13 13:40:42 CST 2019::pool-1-thread-3
Wed Nov 13 13:40:42 CST 2019::pool-1-thread-4
Wed Nov 13 13:40:42 CST 2019::pool-1-thread-5
Wed Nov 13 13:40:42 CST 2019::pool-1-thread-3
Wed Nov 13 13:40:43 CST 2019::pool-1-thread-2
Wed Nov 13 13:40:43 CST 2019::pool-1-thread-1
Wed Nov 13 13:40:43 CST 2019::pool-1-thread-4
Wed Nov 13 13:40:43 CST 2019::pool-1-thread-5
```

---

# äº”ã€å‡ ç§å¸¸è§çš„çº¿ç¨‹æ± è¯¦è§£

ä¸ä½¿ç”¨`FixedThreadPool`ä¸`SingleThreadPool`åŸå› æ˜¯äºŒè€…ä½¿ç”¨æ— ç•Œé˜Ÿåˆ—ä½œä¸ºçº¿ç¨‹å·¥ä½œé˜Ÿåˆ—ï¼Œä¼šå¯¼è‡´OOM
ä¸ä½¿ç”¨`CachedThreadPool`æ˜¯å› ä¸ºæœ€å¤§çº¿ç¨‹æ•°é‡ä¸ºIngeter.MAX_VALUEï¼Œä¼šå¯¼è‡´OOM

## 5.1 FixedThreadPool

### 5.1.1 ä»‹ç»

`FixedThreadPool` è¢«ç§°ä¸º**å¯é‡ç”¨å›ºå®šçº¿ç¨‹æ•°çš„çº¿ç¨‹æ± **ã€‚é€šè¿‡ Executors ç±»ä¸­çš„ç›¸å…³æºä»£ç æ¥çœ‹ä¸€ä¸‹ç›¸å…³å®ç°ï¼š

```java
   /**
     * åˆ›å»ºä¸€ä¸ªå¯é‡ç”¨å›ºå®šæ•°é‡çº¿ç¨‹çš„çº¿ç¨‹æ± 
     */
    public static ExecutorService newFixedThreadPool(int nThreads, ThreadFactory threadFactory) {
        return new ThreadPoolExecutor(nThreads, nThreads,
                                      0L, TimeUnit.MILLISECONDS,
                                      new LinkedBlockingQueue<Runnable>(),
                                      threadFactory);
    }
```

å¦å¤–è¿˜æœ‰ä¸€ä¸ª `FixedThreadPool` çš„å®ç°æ–¹æ³•ï¼Œå’Œä¸Šé¢çš„ç±»ä¼¼ï¼Œæ‰€ä»¥è¿™é‡Œä¸å¤šåšé˜è¿°ï¼š

```java
    public static ExecutorService newFixedThreadPool(int nThreads) {
        return new ThreadPoolExecutor(nThreads, nThreads,
                                      0L, TimeUnit.MILLISECONDS,
                                      new LinkedBlockingQueue<Runnable>());
    }
```

**ä»ä¸Šé¢æºä»£ç å¯ä»¥çœ‹å‡ºæ–°åˆ›å»ºçš„ `FixedThreadPool` çš„ `corePoolSize` å’Œ `maximumPoolSize` éƒ½è¢«è®¾ç½®ä¸º nThreadsï¼Œè¿™ä¸ª nThreads å‚æ•°æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„æ—¶å€™è‡ªå·±ä¼ é€’çš„ã€‚**

### 5.1.2 æ‰§è¡Œä»»åŠ¡è¿‡ç¨‹ä»‹ç»

`FixedThreadPool` çš„ `execute()` æ–¹æ³•è¿è¡Œç¤ºæ„å›¾ï¼ˆè¯¥å›¾ç‰‡æ¥æºï¼šã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹ï¼‰ï¼š

![FixedThreadPoolçš„execute()æ–¹æ³•è¿è¡Œç¤ºæ„å›¾](https://github.com/Snailclimb/JavaGuide/raw/main/docs/java/concurrent/images/java-thread-pool-summary/FixedThreadPool.png)

**ä¸Šå›¾è¯´æ˜ï¼š**

1. å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å°äº corePoolSizeï¼Œ å¦‚æœå†æ¥æ–°ä»»åŠ¡çš„è¯ï¼Œå°±åˆ›å»ºæ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼›
2. å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°ç­‰äº corePoolSize åï¼Œ å¦‚æœå†æ¥æ–°ä»»åŠ¡çš„è¯ï¼Œä¼šå°†ä»»åŠ¡åŠ å…¥ `LinkedBlockingQueue`ï¼›
3. çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ‰§è¡Œå®Œ æ‰‹å¤´çš„ä»»åŠ¡åï¼Œä¼šåœ¨å¾ªç¯ä¸­åå¤ä» `LinkedBlockingQueue` ä¸­è·å–ä»»åŠ¡æ¥æ‰§è¡Œï¼›

### 5.1.3 ä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨`FixedThreadPool`ï¼Ÿ

**`FixedThreadPool` ä½¿ç”¨æ— ç•Œé˜Ÿåˆ— `LinkedBlockingQueue`ï¼ˆé˜Ÿåˆ—çš„å®¹é‡ä¸º Integer.MAX_VALUEï¼‰ä½œä¸ºçº¿ç¨‹æ± çš„å·¥ä½œé˜Ÿåˆ—ä¼šå¯¹çº¿ç¨‹æ± å¸¦æ¥å¦‚ä¸‹å½±å“ ï¼š**

1. å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°è¾¾åˆ° `corePoolSize` åï¼Œæ–°ä»»åŠ¡å°†åœ¨æ— ç•Œé˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œå› æ­¤çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸ä¼šè¶…è¿‡ corePoolSizeï¼›
2. ç”±äºä½¿ç”¨æ— ç•Œé˜Ÿåˆ—æ—¶ `maximumPoolSize` å°†æ˜¯ä¸€ä¸ªæ— æ•ˆå‚æ•°ï¼Œå› ä¸ºä¸å¯èƒ½å­˜åœ¨ä»»åŠ¡é˜Ÿåˆ—æ»¡çš„æƒ…å†µã€‚æ‰€ä»¥ï¼Œé€šè¿‡åˆ›å»º `FixedThreadPool`çš„æºç å¯ä»¥çœ‹å‡ºåˆ›å»ºçš„ `FixedThreadPool` çš„ `corePoolSize` å’Œ `maximumPoolSize` è¢«è®¾ç½®ä¸ºåŒä¸€ä¸ªå€¼ã€‚
3. ç”±äº 1 å’Œ 2ï¼Œä½¿ç”¨æ— ç•Œé˜Ÿåˆ—æ—¶ `keepAliveTime` å°†æ˜¯ä¸€ä¸ªæ— æ•ˆå‚æ•°ï¼›
4. è¿è¡Œä¸­çš„ `FixedThreadPool`ï¼ˆæœªæ‰§è¡Œ `shutdown()`æˆ– `shutdownNow()`ï¼‰ä¸ä¼šæ‹’ç»ä»»åŠ¡ï¼Œåœ¨ä»»åŠ¡æ¯”è¾ƒå¤šçš„æ—¶å€™ä¼šå¯¼è‡´ OOMï¼ˆå†…å­˜æº¢å‡ºï¼‰ã€‚

## 5.2 SingleThreadExecutor è¯¦è§£

### 5.2.1 ä»‹ç»

`SingleThreadExecutor` æ˜¯åªæœ‰**ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± **ã€‚ä¸‹é¢çœ‹çœ‹**SingleThreadExecutor çš„å®ç°ï¼š**

```java
   /**
     *è¿”å›åªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± 
     */
    public static ExecutorService newSingleThreadExecutor(ThreadFactory threadFactory) {
        return new FinalizableDelegatedExecutorService
            (new ThreadPoolExecutor(1, 1,
                                    0L, TimeUnit.MILLISECONDS,
                                    new LinkedBlockingQueue<Runnable>(),
                                    threadFactory));
    }
```

```java
   public static ExecutorService newSingleThreadExecutor() {
        return new FinalizableDelegatedExecutorService
            (new ThreadPoolExecutor(1, 1,
                                    0L, TimeUnit.MILLISECONDS,
                                    new LinkedBlockingQueue<Runnable>()));
    }
```

ä»ä¸Šé¢æºä»£ç å¯ä»¥çœ‹å‡ºæ–°åˆ›å»ºçš„ `SingleThreadExecutor` çš„ `corePoolSize` å’Œ `maximumPoolSize` éƒ½è¢«è®¾ç½®ä¸º 1.å…¶ä»–å‚æ•°å’Œ `FixedThreadPool` ç›¸åŒã€‚

#### 5.2.2 æ‰§è¡Œä»»åŠ¡è¿‡ç¨‹ä»‹ç»

`SingleThreadExecutor` çš„è¿è¡Œç¤ºæ„å›¾ï¼ˆè¯¥å›¾ç‰‡æ¥æºï¼šã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹ï¼‰ï¼š
![SingleThreadExecutorçš„è¿è¡Œç¤ºæ„å›¾](https://github.com/Snailclimb/JavaGuide/raw/main/docs/java/concurrent/images/java-thread-pool-summary/SingleThreadExecutor.png)

**ä¸Šå›¾è¯´æ˜** :

1. å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å°‘äº `corePoolSize`ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼›
2. å½“å‰çº¿ç¨‹æ± ä¸­æœ‰ä¸€ä¸ªè¿è¡Œçš„çº¿ç¨‹åï¼Œå°†ä»»åŠ¡åŠ å…¥ `LinkedBlockingQueue`
3. çº¿ç¨‹æ‰§è¡Œå®Œå½“å‰çš„ä»»åŠ¡åï¼Œä¼šåœ¨å¾ªç¯ä¸­åå¤ä»`LinkedBlockingQueue` ä¸­è·å–ä»»åŠ¡æ¥æ‰§è¡Œï¼›

### 5.2.3 ä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨`SingleThreadExecutor`ï¼Ÿ

`SingleThreadExecutor` ä½¿ç”¨æ— ç•Œé˜Ÿåˆ— `LinkedBlockingQueue` ä½œä¸ºçº¿ç¨‹æ± çš„å·¥ä½œé˜Ÿåˆ—ï¼ˆé˜Ÿåˆ—çš„å®¹é‡ä¸º Intger.MAX_VALUEï¼‰ã€‚`SingleThreadExecutor` ä½¿ç”¨æ— ç•Œé˜Ÿåˆ—ä½œä¸ºçº¿ç¨‹æ± çš„å·¥ä½œé˜Ÿåˆ—ä¼šå¯¹çº¿ç¨‹æ± å¸¦æ¥çš„å½±å“ä¸ `FixedThreadPool` ç›¸åŒã€‚**è¯´ç®€å•ç‚¹å°±æ˜¯å¯èƒ½ä¼šå¯¼è‡´ OOM**

## 5.3 CachedThreadPool è¯¦è§£

### 5.3.1 ä»‹ç»

`CachedThreadPool` æ˜¯ä¸€ä¸ª**ä¼šæ ¹æ®éœ€è¦åˆ›å»ºæ–°çº¿ç¨‹çš„çº¿ç¨‹æ± **ã€‚ä¸‹é¢é€šè¿‡æºç æ¥çœ‹çœ‹ `CachedThreadPool` çš„å®ç°ï¼š

```java
    /**
     * åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œæ ¹æ®éœ€è¦åˆ›å»ºæ–°çº¿ç¨‹ï¼Œä½†ä¼šåœ¨å…ˆå‰æ„å»ºçš„çº¿ç¨‹å¯ç”¨æ—¶é‡ç”¨å®ƒã€‚
     */
    public static ExecutorService newCachedThreadPool(ThreadFactory threadFactory) {
        return new ThreadPoolExecutor(0, Integer.MAX_VALUE,
                                      60L, TimeUnit.SECONDS,
                                      new SynchronousQueue<Runnable>(),
                                      threadFactory);
    }

```

```java
    public static ExecutorService newCachedThreadPool() {
        return new ThreadPoolExecutor(0, Integer.MAX_VALUE,
                                      60L, TimeUnit.SECONDS,
                                      new SynchronousQueue<Runnable>());
    }
```

`CachedThreadPool` çš„`corePoolSize` è¢«è®¾ç½®ä¸ºç©ºï¼ˆ0ï¼‰ï¼Œ`maximumPoolSize`è¢«è®¾ç½®ä¸º `Integer.MAX.VALUE`ï¼Œå³å®ƒæ˜¯æ— ç•Œçš„ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€å¦‚æœä¸»çº¿ç¨‹æäº¤ä»»åŠ¡çš„é€Ÿåº¦é«˜äº `maximumPool` ä¸­çº¿ç¨‹å¤„ç†ä»»åŠ¡çš„é€Ÿåº¦æ—¶ï¼Œ`CachedThreadPool` ä¼šä¸æ–­åˆ›å»ºæ–°çš„çº¿ç¨‹ã€‚æç«¯æƒ…å†µä¸‹ï¼Œè¿™æ ·ä¼šå¯¼è‡´è€—å°½ cpu å’Œå†…å­˜èµ„æºã€‚

### 5.3.2 æ‰§è¡Œä»»åŠ¡è¿‡ç¨‹ä»‹ç»

`CachedThreadPool` çš„ `execute()` æ–¹æ³•çš„æ‰§è¡Œç¤ºæ„å›¾ï¼ˆè¯¥å›¾ç‰‡æ¥æºï¼šã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹ï¼‰ï¼š
![[CachedThreadPoolçš„execute()æ–¹æ³•çš„æ‰§è¡Œç¤ºæ„å›¾]](https://github.com/Snailclimb/JavaGuide/raw/main/docs/java/concurrent/images/java-thread-pool-summary/CachedThreadPool-execute.png)

**ä¸Šå›¾è¯´æ˜ï¼š**

1. é¦–å…ˆæ‰§è¡Œ `SynchronousQueue.offer(Runnable task)` æäº¤ä»»åŠ¡åˆ°ä»»åŠ¡é˜Ÿåˆ—ã€‚å¦‚æœå½“å‰ `maximumPool` ä¸­æœ‰é—²çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ `SynchronousQueue.poll(keepAliveTime,TimeUnit.NANOSECONDS)`ï¼Œé‚£ä¹ˆä¸»çº¿ç¨‹æ‰§è¡Œ offer æ“ä½œä¸ç©ºé—²çº¿ç¨‹æ‰§è¡Œçš„ `poll` æ“ä½œé…å¯¹æˆåŠŸï¼Œä¸»çº¿ç¨‹æŠŠä»»åŠ¡äº¤ç»™ç©ºé—²çº¿ç¨‹æ‰§è¡Œï¼Œ`execute()`æ–¹æ³•æ‰§è¡Œå®Œæˆï¼Œå¦åˆ™æ‰§è¡Œä¸‹é¢çš„æ­¥éª¤ 2ï¼›
2. å½“åˆå§‹ `maximumPool` ä¸ºç©ºï¼Œæˆ–è€… `maximumPool` ä¸­æ²¡æœ‰ç©ºé—²çº¿ç¨‹æ—¶ï¼Œå°†æ²¡æœ‰çº¿ç¨‹æ‰§è¡Œ `SynchronousQueue.poll(keepAliveTime,TimeUnit.NANOSECONDS)`ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ­¥éª¤ 1 å°†å¤±è´¥ï¼Œæ­¤æ—¶ `CachedThreadPool` ä¼šåˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œexecute æ–¹æ³•æ‰§è¡Œå®Œæˆï¼›

#### 5.3.3 ä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨`CachedThreadPool`ï¼Ÿ

`CachedThreadPool`å…è®¸åˆ›å»ºçš„çº¿ç¨‹æ•°é‡ä¸º `Integer.MAX_VALUE` ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ OOMã€‚

# å…­ã€ScheduledThreadPoolExecutor è¯¦è§£

**`ScheduledThreadPoolExecutor` ä¸»è¦ç”¨æ¥åœ¨ç»™å®šçš„å»¶è¿Ÿåè¿è¡Œä»»åŠ¡ï¼Œæˆ–è€…å®šæœŸæ‰§è¡Œä»»åŠ¡ã€‚** è¿™ä¸ªåœ¨å®é™…é¡¹ç›®ä¸­åŸºæœ¬ä¸ä¼šè¢«ç”¨åˆ°ï¼Œä¹Ÿä¸æ¨èä½¿ç”¨ï¼Œå¤§å®¶åªéœ€è¦ç®€å•äº†è§£ä¸€ä¸‹å®ƒçš„æ€æƒ³å³å¯ã€‚

## 6.1 ç®€ä»‹

`ScheduledThreadPoolExecutor` ä½¿ç”¨çš„ä»»åŠ¡é˜Ÿåˆ— `DelayQueue` å°è£…äº†ä¸€ä¸ª `PriorityQueue`ï¼Œ`PriorityQueue` ä¼šå¯¹é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡è¿›è¡Œæ’åºï¼Œæ‰§è¡Œæ‰€éœ€æ—¶é—´çŸ­çš„æ”¾åœ¨å‰é¢å…ˆè¢«æ‰§è¡Œ(`ScheduledFutureTask` çš„ `time` å˜é‡å°çš„å…ˆæ‰§è¡Œ)ï¼Œå¦‚æœæ‰§è¡Œæ‰€éœ€æ—¶é—´ç›¸åŒåˆ™å…ˆæäº¤çš„ä»»åŠ¡å°†è¢«å…ˆæ‰§è¡Œ(`ScheduledFutureTask` çš„ `squenceNumber` å˜é‡å°çš„å…ˆæ‰§è¡Œ)ã€‚

> **`ScheduledThreadPoolExecutor` å’Œ `Timer` çš„æ¯”è¾ƒï¼š**

- `Timer` å¯¹ç³»ç»Ÿæ—¶é’Ÿçš„å˜åŒ–æ•æ„Ÿï¼Œ`ScheduledThreadPoolExecutor`ä¸æ˜¯ï¼›
- `Timer` åªæœ‰ä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹ï¼Œå› æ­¤é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡å¯ä»¥å»¶è¿Ÿå…¶ä»–ä»»åŠ¡ã€‚ `ScheduledThreadPoolExecutor` å¯ä»¥é…ç½®ä»»æ„æ•°é‡çš„çº¿ç¨‹ã€‚ æ­¤å¤–ï¼Œå¦‚æœä½ æƒ³ï¼ˆé€šè¿‡æä¾› ThreadFactoryï¼‰ï¼Œä½ å¯ä»¥å®Œå…¨æ§åˆ¶åˆ›å»ºçš„çº¿ç¨‹;
- åœ¨`TimerTask` ä¸­æŠ›å‡ºçš„è¿è¡Œæ—¶å¼‚å¸¸ä¼šæ€æ­»ä¸€ä¸ªçº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ `Timer` æ­»æœº:-( ...å³è®¡åˆ’ä»»åŠ¡å°†ä¸å†è¿è¡Œã€‚`ScheduledThreadExecutor` ä¸ä»…æ•è·è¿è¡Œæ—¶å¼‚å¸¸ï¼Œè¿˜å…è®¸æ‚¨åœ¨éœ€è¦æ—¶å¤„ç†å®ƒä»¬ï¼ˆé€šè¿‡é‡å†™ `afterExecute` æ–¹æ³•`ThreadPoolExecutor`ï¼‰ã€‚æŠ›å‡ºå¼‚å¸¸çš„ä»»åŠ¡å°†è¢«å–æ¶ˆï¼Œä½†å…¶ä»–ä»»åŠ¡å°†ç»§ç»­è¿è¡Œã€‚

**ç»¼ä¸Šï¼Œåœ¨ JDK1.5 ä¹‹åï¼Œä½ æ²¡æœ‰ç†ç”±å†ä½¿ç”¨ Timer è¿›è¡Œä»»åŠ¡è°ƒåº¦äº†ã€‚**

> å…³äºå®šæ—¶ä»»åŠ¡çš„è¯¦ç»†ä»‹ç»ï¼Œå°ä¼™ä¼´ä»¬å¯ä»¥åœ¨ JavaGuide çš„é¡¹ç›®é¦–é¡µæœç´¢â€œå®šæ—¶ä»»åŠ¡â€æ‰¾åˆ°å¯¹åº”çš„åŸåˆ›å†…å®¹ã€‚

## 6.2 è¿è¡Œæœºåˆ¶

![[ScheduledThreadPoolExecutorè¿è¡Œæœºåˆ¶]](https://github.com/Snailclimb/JavaGuide/raw/main/docs/java/concurrent/images/java-thread-pool-summary/ScheduledThreadPoolExecutor%E6%9C%BA%E5%88%B6.png)

**`ScheduledThreadPoolExecutor` çš„æ‰§è¡Œä¸»è¦åˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼š**

1. å½“è°ƒç”¨ `ScheduledThreadPoolExecutor` çš„ **`scheduleAtFixedRate()`** æ–¹æ³•æˆ–è€… **`scheduleWithFixedDelay()`** æ–¹æ³•æ—¶ï¼Œä¼šå‘ `ScheduledThreadPoolExecutor` çš„ **`DelayQueue`** æ·»åŠ ä¸€ä¸ªå®ç°äº† **`RunnableScheduledFuture`** æ¥å£çš„ **`ScheduledFutureTask`** ã€‚
2. çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ä» `DelayQueue` ä¸­è·å– `ScheduledFutureTask`ï¼Œç„¶åæ‰§è¡Œä»»åŠ¡ã€‚

**`ScheduledThreadPoolExecutor` ä¸ºäº†å®ç°å‘¨æœŸæ€§çš„æ‰§è¡Œä»»åŠ¡ï¼Œå¯¹ `ThreadPoolExecutor`åšäº†å¦‚ä¸‹ä¿®æ”¹ï¼š**

- ä½¿ç”¨ **`DelayQueue`** ä½œä¸ºä»»åŠ¡é˜Ÿåˆ—ï¼›
- è·å–ä»»åŠ¡çš„æ–¹ä¸åŒ
- æ‰§è¡Œå‘¨æœŸä»»åŠ¡åï¼Œå¢åŠ äº†é¢å¤–çš„å¤„ç†

## 6.3 ScheduledThreadPoolExecutor æ‰§è¡Œå‘¨æœŸä»»åŠ¡çš„æ­¥éª¤

![[ScheduledThreadPoolExecutoræ‰§è¡Œå‘¨æœŸä»»åŠ¡çš„æ­¥éª¤]](https://github.com/Snailclimb/JavaGuide/raw/main/docs/java/concurrent/images/java-thread-pool-summary/ScheduledThreadPoolExecutor%E6%89%A7%E8%A1%8C%E5%91%A8%E6%9C%9F%E4%BB%BB%E5%8A%A1%E6%AD%A5%E9%AA%A4.png)

1. çº¿ç¨‹ 1 ä» `DelayQueue` ä¸­è·å–å·²åˆ°æœŸçš„ `ScheduledFutureTaskï¼ˆDelayQueue.take()ï¼‰`ã€‚åˆ°æœŸä»»åŠ¡æ˜¯æŒ‡ `ScheduledFutureTask`çš„ time å¤§äºç­‰äºå½“å‰ç³»ç»Ÿçš„æ—¶é—´ï¼›
2. çº¿ç¨‹ 1 æ‰§è¡Œè¿™ä¸ª `ScheduledFutureTask`ï¼›
3. çº¿ç¨‹ 1 ä¿®æ”¹ `ScheduledFutureTask` çš„ time å˜é‡ä¸ºä¸‹æ¬¡å°†è¦è¢«æ‰§è¡Œçš„æ—¶é—´ï¼›
4. çº¿ç¨‹ 1 æŠŠè¿™ä¸ªä¿®æ”¹ time ä¹‹åçš„ `ScheduledFutureTask` æ”¾å› `DelayQueue` ä¸­ï¼ˆ`DelayQueue.add()`)ã€‚

# ä¸ƒã€çº¿ç¨‹æ± å¤§å°ç¡®å®š

**çº¿ç¨‹æ± æ•°é‡çš„ç¡®å®šä¸€ç›´æ˜¯å›°æ‰°ç€ç¨‹åºå‘˜çš„ä¸€ä¸ªéš¾é¢˜ï¼Œå¤§éƒ¨åˆ†ç¨‹åºå‘˜åœ¨è®¾å®šçº¿ç¨‹æ± å¤§å°çš„æ—¶å€™å°±æ˜¯éšå¿ƒè€Œå®šã€‚**

å¾ˆå¤šäººç”šè‡³å¯èƒ½éƒ½ä¼šè§‰å¾—æŠŠçº¿ç¨‹æ± é…ç½®è¿‡å¤§ä¸€ç‚¹æ¯”è¾ƒå¥½ï¼æˆ‘è§‰å¾—è¿™æ˜æ˜¾æ˜¯æœ‰é—®é¢˜çš„ã€‚å°±æ‹¿æˆ‘ä»¬ç”Ÿæ´»ä¸­éå¸¸å¸¸è§çš„ä¸€ä¾‹å­æ¥è¯´ï¼š**å¹¶ä¸æ˜¯äººå¤šå°±èƒ½æŠŠäº‹æƒ…åšå¥½ï¼Œå¢åŠ äº†æ²Ÿé€šäº¤æµæˆæœ¬ã€‚ä½ æœ¬æ¥ä¸€ä»¶äº‹æƒ…åªéœ€è¦ 3 ä¸ªäººåšï¼Œä½ ç¡¬æ˜¯æ‹‰æ¥äº† 6 ä¸ªäººï¼Œä¼šæå‡åšäº‹æ•ˆç‡å˜›ï¼Ÿæˆ‘æƒ³å¹¶ä¸ä¼šã€‚** çº¿ç¨‹æ•°é‡è¿‡å¤šçš„å½±å“ä¹Ÿæ˜¯å’Œæˆ‘ä»¬åˆ†é…å¤šå°‘äººåšäº‹æƒ…ä¸€æ ·ï¼Œå¯¹äºå¤šçº¿ç¨‹è¿™ä¸ªåœºæ™¯æ¥è¯´ä¸»è¦æ˜¯å¢åŠ äº†**ä¸Šä¸‹æ–‡åˆ‡æ¢**æˆæœ¬ã€‚ä¸æ¸…æ¥šä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢çš„è¯ï¼Œå¯ä»¥çœ‹æˆ‘ä¸‹é¢çš„ä»‹ç»ã€‚

> ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼š
>
> å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ä¸€èˆ¬çº¿ç¨‹çš„ä¸ªæ•°éƒ½å¤§äº CPU æ ¸å¿ƒçš„ä¸ªæ•°ï¼Œè€Œä¸€ä¸ª CPU æ ¸å¿ƒåœ¨ä»»æ„æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œä¸ºäº†è®©è¿™äº›çº¿ç¨‹éƒ½èƒ½å¾—åˆ°æœ‰æ•ˆæ‰§è¡Œï¼ŒCPU é‡‡å–çš„ç­–ç•¥æ˜¯ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…æ—¶é—´ç‰‡å¹¶è½®è½¬çš„å½¢å¼ã€‚å½“ä¸€ä¸ªçº¿ç¨‹çš„æ—¶é—´ç‰‡ç”¨å®Œçš„æ—¶å€™å°±ä¼šé‡æ–°å¤„äºå°±ç»ªçŠ¶æ€è®©ç»™å…¶ä»–çº¿ç¨‹ä½¿ç”¨ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å±äºä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚æ¦‚æ‹¬æ¥è¯´å°±æ˜¯ï¼šå½“å‰ä»»åŠ¡åœ¨æ‰§è¡Œå®Œ CPU æ—¶é—´ç‰‡åˆ‡æ¢åˆ°å¦ä¸€ä¸ªä»»åŠ¡ä¹‹å‰ä¼šå…ˆä¿å­˜è‡ªå·±çš„çŠ¶æ€ï¼Œä»¥ä¾¿ä¸‹æ¬¡å†åˆ‡æ¢å›è¿™ä¸ªä»»åŠ¡æ—¶ï¼Œå¯ä»¥å†åŠ è½½è¿™ä¸ªä»»åŠ¡çš„çŠ¶æ€ã€‚**ä»»åŠ¡ä»ä¿å­˜åˆ°å†åŠ è½½çš„è¿‡ç¨‹å°±æ˜¯ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢**ã€‚
>
> ä¸Šä¸‹æ–‡åˆ‡æ¢é€šå¸¸æ˜¯è®¡ç®—å¯†é›†å‹çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒéœ€è¦ç›¸å½“å¯è§‚çš„å¤„ç†å™¨æ—¶é—´ï¼Œåœ¨æ¯ç§’å‡ åä¸Šç™¾æ¬¡çš„åˆ‡æ¢ä¸­ï¼Œæ¯æ¬¡åˆ‡æ¢éƒ½éœ€è¦çº³ç§’é‡çº§çš„æ—¶é—´ã€‚æ‰€ä»¥ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¯¹ç³»ç»Ÿæ¥è¯´æ„å‘³ç€æ¶ˆè€—å¤§é‡çš„ CPU æ—¶é—´ï¼Œäº‹å®ä¸Šï¼Œå¯èƒ½æ˜¯æ“ä½œç³»ç»Ÿä¸­æ—¶é—´æ¶ˆè€—æœ€å¤§çš„æ“ä½œã€‚
>
> Linux ç›¸æ¯”ä¸å…¶ä»–æ“ä½œç³»ç»Ÿï¼ˆåŒ…æ‹¬å…¶ä»–ç±» Unix ç³»ç»Ÿï¼‰æœ‰å¾ˆå¤šçš„ä¼˜ç‚¹ï¼Œå…¶ä¸­æœ‰ä¸€é¡¹å°±æ˜¯ï¼Œå…¶ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ¨¡å¼åˆ‡æ¢çš„æ—¶é—´æ¶ˆè€—éå¸¸å°‘ã€‚

**ç±»æ¯”äºç°å®ä¸–ç•Œä¸­çš„äººç±»é€šè¿‡åˆä½œåšæŸä»¶äº‹æƒ…ï¼Œæˆ‘ä»¬å¯ä»¥è‚¯å®šçš„ä¸€ç‚¹æ˜¯çº¿ç¨‹æ± å¤§å°è®¾ç½®è¿‡å¤§æˆ–è€…è¿‡å°éƒ½ä¼šæœ‰é—®é¢˜ï¼Œåˆé€‚çš„æ‰æ˜¯æœ€å¥½ã€‚**

**å¦‚æœæˆ‘ä»¬è®¾ç½®çš„çº¿ç¨‹æ± æ•°é‡å¤ªå°çš„è¯ï¼Œå¦‚æœåŒä¸€æ—¶é—´æœ‰å¤§é‡ä»»åŠ¡/è¯·æ±‚éœ€è¦å¤„ç†ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¤§é‡çš„è¯·æ±‚/ä»»åŠ¡åœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­æ’é˜Ÿç­‰å¾…æ‰§è¡Œï¼Œç”šè‡³ä¼šå‡ºç°ä»»åŠ¡é˜Ÿåˆ—æ»¡äº†ä¹‹åä»»åŠ¡/è¯·æ±‚æ— æ³•å¤„ç†çš„æƒ…å†µï¼Œæˆ–è€…å¤§é‡ä»»åŠ¡å †ç§¯åœ¨ä»»åŠ¡é˜Ÿåˆ—å¯¼è‡´ OOMã€‚è¿™æ ·å¾ˆæ˜æ˜¾æ˜¯æœ‰é—®é¢˜çš„ï¼ CPU æ ¹æœ¬æ²¡æœ‰å¾—åˆ°å……åˆ†åˆ©ç”¨ã€‚**

**ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬è®¾ç½®çº¿ç¨‹æ•°é‡å¤ªå¤§ï¼Œå¤§é‡çº¿ç¨‹å¯èƒ½ä¼šåŒæ—¶åœ¨äº‰å– CPU èµ„æºï¼Œè¿™æ ·ä¼šå¯¼è‡´å¤§é‡çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»è€Œå¢åŠ çº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´ï¼Œå½±å“äº†æ•´ä½“æ‰§è¡Œæ•ˆç‡ã€‚**

æœ‰ä¸€ä¸ªç®€å•å¹¶ä¸”é€‚ç”¨é¢æ¯”è¾ƒå¹¿çš„å…¬å¼ï¼š

- **CPU å¯†é›†å‹ä»»åŠ¡(N+1)ï¼š** è¿™ç§ä»»åŠ¡æ¶ˆè€—çš„ä¸»è¦æ˜¯ CPU èµ„æºï¼Œå¯ä»¥å°†çº¿ç¨‹æ•°è®¾ç½®ä¸º Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰+1ï¼Œæ¯” CPU æ ¸å¿ƒæ•°å¤šå‡ºæ¥çš„ä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸ºäº†é˜²æ­¢çº¿ç¨‹å¶å‘çš„ç¼ºé¡µä¸­æ–­ï¼Œæˆ–è€…å…¶å®ƒåŸå› å¯¼è‡´çš„ä»»åŠ¡æš‚åœè€Œå¸¦æ¥çš„å½±å“ã€‚ä¸€æ—¦ä»»åŠ¡æš‚åœï¼ŒCPU å°±ä¼šå¤„äºç©ºé—²çŠ¶æ€ï¼Œè€Œåœ¨è¿™ç§æƒ…å†µä¸‹å¤šå‡ºæ¥çš„ä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥å……åˆ†åˆ©ç”¨ CPU çš„ç©ºé—²æ—¶é—´ã€‚
- **I/O å¯†é›†å‹ä»»åŠ¡(2N)ï¼š** è¿™ç§ä»»åŠ¡åº”ç”¨èµ·æ¥ï¼Œç³»ç»Ÿä¼šç”¨å¤§éƒ¨åˆ†çš„æ—¶é—´æ¥å¤„ç† I/O äº¤äº’ï¼Œè€Œçº¿ç¨‹åœ¨å¤„ç† I/O çš„æ—¶é—´æ®µå†…ä¸ä¼šå ç”¨ CPU æ¥å¤„ç†ï¼Œè¿™æ—¶å°±å¯ä»¥å°† CPU äº¤å‡ºç»™å…¶å®ƒçº¿ç¨‹ä½¿ç”¨ã€‚å› æ­¤åœ¨ I/O å¯†é›†å‹ä»»åŠ¡çš„åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¤šé…ç½®ä¸€äº›çº¿ç¨‹ï¼Œå…·ä½“çš„è®¡ç®—æ–¹æ³•æ˜¯ 2Nã€‚

**å¦‚ä½•åˆ¤æ–­æ˜¯ CPU å¯†é›†ä»»åŠ¡è¿˜æ˜¯ IO å¯†é›†ä»»åŠ¡ï¼Ÿ**

CPU å¯†é›†å‹ç®€å•ç†è§£å°±æ˜¯åˆ©ç”¨ CPU è®¡ç®—èƒ½åŠ›çš„ä»»åŠ¡æ¯”å¦‚ä½ åœ¨å†…å­˜ä¸­å¯¹å¤§é‡æ•°æ®è¿›è¡Œæ’åºã€‚ä½†å‡¡æ¶‰åŠåˆ°ç½‘ç»œè¯»å–ï¼Œæ–‡ä»¶è¯»å–è¿™ç±»éƒ½æ˜¯ IO å¯†é›†å‹ï¼Œè¿™ç±»ä»»åŠ¡çš„ç‰¹ç‚¹æ˜¯ CPU è®¡ç®—è€—è´¹æ—¶é—´ç›¸æ¯”äºç­‰å¾… IO æ“ä½œå®Œæˆçš„æ—¶é—´æ¥è¯´å¾ˆå°‘ï¼Œå¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±åœ¨äº†ç­‰å¾… IO æ“ä½œå®Œæˆä¸Šã€‚

---

# å…«ã€çº¿ç¨‹æ± æœ€ä½³å®è·µ

## 8.1 ä½¿ç”¨ `ThreadPoolExecutor` çš„æ„é€ å‡½æ•°å£°æ˜çº¿ç¨‹æ± 

**1. çº¿ç¨‹æ± å¿…é¡»æ‰‹åŠ¨é€šè¿‡ `ThreadPoolExecutor` çš„æ„é€ å‡½æ•°æ¥å£°æ˜ï¼Œé¿å…ä½¿ç”¨`Executors` ç±»çš„ `newFixedThreadPool` å’Œ `newCachedThreadPool` ï¼Œå› ä¸ºå¯èƒ½ä¼šæœ‰ OOM çš„é£é™©ã€‚**

> Executors è¿”å›çº¿ç¨‹æ± å¯¹è±¡çš„å¼Šç«¯å¦‚ä¸‹ï¼š
>
> - **`FixedThreadPool` å’Œ `SingleThreadExecutor`** ï¼š å…è®¸è¯·æ±‚çš„é˜Ÿåˆ—é•¿åº¦ä¸º `Integer.MAX_VALUE`,å¯èƒ½å †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚
> - **CachedThreadPool å’Œ ScheduledThreadPool** ï¼š å…è®¸åˆ›å»ºçš„çº¿ç¨‹æ•°é‡ä¸º `Integer.MAX_VALUE` ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ OOMã€‚

è¯´ç™½äº†å°±æ˜¯ï¼š**ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—ï¼Œæ§åˆ¶çº¿ç¨‹åˆ›å»ºæ•°é‡ã€‚**

é™¤äº†é¿å… OOM çš„åŸå› ä¹‹å¤–ï¼Œä¸æ¨èä½¿ç”¨ `Executors`æä¾›çš„ä¸¤ç§å¿«æ·çš„çº¿ç¨‹æ± çš„åŸå› è¿˜æœ‰ï¼š

1. å®é™…ä½¿ç”¨ä¸­éœ€è¦æ ¹æ®è‡ªå·±æœºå™¨çš„æ€§èƒ½ã€ä¸šåŠ¡åœºæ™¯æ¥æ‰‹åŠ¨é…ç½®çº¿ç¨‹æ± çš„å‚æ•°æ¯”å¦‚æ ¸å¿ƒçº¿ç¨‹æ•°ã€ä½¿ç”¨çš„ä»»åŠ¡é˜Ÿåˆ—ã€é¥±å’Œç­–ç•¥ç­‰ç­‰ã€‚
2. æˆ‘ä»¬åº”è¯¥æ˜¾ç¤ºåœ°ç»™æˆ‘ä»¬çš„çº¿ç¨‹æ± å‘½åï¼Œè¿™æ ·æœ‰åŠ©äºæˆ‘ä»¬å®šä½é—®é¢˜ã€‚

## 8.2 ç›‘æµ‹çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€

ä½ å¯ä»¥é€šè¿‡ä¸€äº›æ‰‹æ®µæ¥æ£€æµ‹çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€æ¯”å¦‚ SpringBoot ä¸­çš„ Actuator ç»„ä»¶ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åˆ©ç”¨ `ThreadPoolExecutor` çš„ç›¸å…³ API åšä¸€ä¸ªç®€é™‹çš„ç›‘æ§ã€‚ä»ä¸‹å›¾å¯ä»¥çœ‹å‡ºï¼Œ `ThreadPoolExecutor`æä¾›äº†è·å–çº¿ç¨‹æ± å½“å‰çš„çº¿ç¨‹æ•°å’Œæ´»è·ƒçº¿ç¨‹æ•°ã€å·²ç»æ‰§è¡Œå®Œæˆçš„ä»»åŠ¡æ•°ã€æ­£åœ¨æ’é˜Ÿä¸­çš„ä»»åŠ¡æ•°ç­‰ç­‰ã€‚

![](https://github.com/Snailclimb/JavaGuide/raw/main/docs/java/concurrent/images/thread-pool/ddf22709-bff5-45b4-acb7-a3f2e6798608.png)

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ Demoã€‚`printThreadPoolStatus()`ä¼šæ¯éš”ä¸€ç§’æ‰“å°å‡ºçº¿ç¨‹æ± çš„çº¿ç¨‹æ•°ã€æ´»è·ƒçº¿ç¨‹æ•°ã€å®Œæˆçš„ä»»åŠ¡æ•°ã€ä»¥åŠé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ•°ã€‚

```java
    /**
     * æ‰“å°çº¿ç¨‹æ± çš„çŠ¶æ€
     *
     * @param threadPool çº¿ç¨‹æ± å¯¹è±¡
     */
    public static void printThreadPoolStatus(ThreadPoolExecutor threadPool) {
        ScheduledExecutorService scheduledExecutorService = new ScheduledThreadPoolExecutor(1, createThreadFactory("print-images/thread-pool-status", false));
        scheduledExecutorService.scheduleAtFixedRate(() -> {
            log.info("=========================");
            log.info("ThreadPool Size: [{}]", threadPool.getPoolSize());
            log.info("Active Threads: {}", threadPool.getActiveCount());
            log.info("Number of Tasks : {}", threadPool.getCompletedTaskCount());
            log.info("Number of Tasks in Queue: {}", threadPool.getQueue().size());
            log.info("=========================");
        }, 0, 1, TimeUnit.SECONDS);
    }
```

## 8.3 å»ºè®®ä¸åŒç±»åˆ«çš„ä¸šåŠ¡ç”¨ä¸åŒçš„çº¿ç¨‹æ± 

å¾ˆå¤šäººåœ¨å®é™…é¡¹ç›®ä¸­éƒ½ä¼šæœ‰ç±»ä¼¼è¿™æ ·çš„é—®é¢˜ï¼š**æˆ‘çš„é¡¹ç›®ä¸­å¤šä¸ªä¸šåŠ¡éœ€è¦ç”¨åˆ°çº¿ç¨‹æ± ï¼Œæ˜¯ä¸ºæ¯ä¸ªçº¿ç¨‹æ± éƒ½å®šä¹‰ä¸€ä¸ªè¿˜æ˜¯è¯´å®šä¹‰ä¸€ä¸ªå…¬å…±çš„çº¿ç¨‹æ± å‘¢ï¼Ÿ**

ä¸€èˆ¬å»ºè®®æ˜¯ä¸åŒçš„ä¸šåŠ¡ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹æ± ï¼Œé…ç½®çº¿ç¨‹æ± çš„æ—¶å€™æ ¹æ®å½“å‰ä¸šåŠ¡çš„æƒ…å†µå¯¹å½“å‰çº¿ç¨‹æ± è¿›è¡Œé…ç½®ï¼Œå› ä¸ºä¸åŒçš„ä¸šåŠ¡çš„å¹¶å‘ä»¥åŠå¯¹èµ„æºçš„ä½¿ç”¨æƒ…å†µéƒ½ä¸åŒï¼Œé‡å¿ƒä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆç›¸å…³çš„ä¸šåŠ¡ã€‚

**æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ªçœŸå®çš„äº‹æ•…æ¡ˆä¾‹ï¼** (æœ¬æ¡ˆä¾‹æ¥æºè‡ªï¼š[ã€Šçº¿ç¨‹æ± è¿ç”¨ä¸å½“çš„ä¸€æ¬¡çº¿ä¸Šäº‹æ•…ã€‹](https://club.perfma.com/article/646639) ï¼Œå¾ˆç²¾å½©çš„ä¸€ä¸ªæ¡ˆä¾‹)

![[æ¡ˆä¾‹ä»£ç æ¦‚è§ˆ]](https://github.com/Snailclimb/JavaGuide/raw/main/docs/java/concurrent/images/thread-pool/5b9b814d-722a-4116-b066-43dc80fc1dc4.png)

ä¸Šé¢çš„ä»£ç å¯èƒ½ä¼šå­˜åœ¨æ­»é”çš„æƒ…å†µï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿç”»ä¸ªå›¾ç»™å¤§å®¶æ‹ä¸€æ‹ã€‚

è¯•æƒ³è¿™æ ·ä¸€ç§æç«¯æƒ…å†µï¼šå‡å¦‚æˆ‘ä»¬çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º **n**ï¼Œçˆ¶ä»»åŠ¡ï¼ˆæ‰£è´¹ä»»åŠ¡ï¼‰æ•°é‡ä¸º **n**ï¼Œçˆ¶ä»»åŠ¡ä¸‹é¢æœ‰ä¸¤ä¸ªå­ä»»åŠ¡ï¼ˆæ‰£è´¹ä»»åŠ¡ä¸‹çš„å­ä»»åŠ¡ï¼‰ï¼Œå…¶ä¸­ä¸€ä¸ªå·²ç»æ‰§è¡Œå®Œæˆï¼Œå¦å¤–ä¸€ä¸ªè¢«æ”¾åœ¨äº†ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚ç”±äºçˆ¶ä»»åŠ¡æŠŠçº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹èµ„æºç”¨å®Œï¼Œæ‰€ä»¥å­ä»»åŠ¡å› ä¸ºæ— æ³•è·å–åˆ°çº¿ç¨‹èµ„æºæ— æ³•æ­£å¸¸æ‰§è¡Œï¼Œä¸€ç›´è¢«é˜»å¡åœ¨é˜Ÿåˆ—ä¸­ã€‚çˆ¶ä»»åŠ¡ç­‰å¾…å­ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œè€Œå­ä»»åŠ¡ç­‰å¾…çˆ¶ä»»åŠ¡é‡Šæ”¾çº¿ç¨‹æ± èµ„æºï¼Œè¿™ä¹Ÿå°±é€ æˆäº† **"æ­»é”"**ã€‚

![[çº¿ç¨‹æ± ä½¿ç”¨ä¸å½“å¯¼è‡´æ­»é”]](https://github.com/Snailclimb/JavaGuide/raw/main/docs/java/concurrent/images/thread-pool/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%BD%93%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81.png)

è§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯æ–°å¢åŠ ä¸€ä¸ªç”¨äºæ‰§è¡Œå­ä»»åŠ¡çš„çº¿ç¨‹æ± ä¸“é—¨ä¸ºå…¶æœåŠ¡ã€‚

## 8.4 åˆ«å¿˜è®°ç»™çº¿ç¨‹æ± å‘½å

åˆå§‹åŒ–çº¿ç¨‹æ± çš„æ—¶å€™éœ€è¦æ˜¾ç¤ºå‘½åï¼ˆè®¾ç½®çº¿ç¨‹æ± åç§°å‰ç¼€ï¼‰ï¼Œæœ‰åˆ©äºå®šä½é—®é¢˜ã€‚

é»˜è®¤æƒ…å†µä¸‹åˆ›å»ºçš„çº¿ç¨‹åå­—ç±»ä¼¼ pool-1-thread-n è¿™æ ·çš„ï¼Œæ²¡æœ‰ä¸šåŠ¡å«ä¹‰ï¼Œä¸åˆ©äºæˆ‘ä»¬å®šä½é—®é¢˜ã€‚

ç»™çº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹å‘½åé€šå¸¸æœ‰ä¸‹é¢ä¸¤ç§æ–¹å¼ï¼š

> **1.åˆ©ç”¨ guava çš„ `ThreadFactoryBuilder`**

```java
ThreadFactory threadFactory = new ThreadFactoryBuilder()
                        .setNameFormat(threadNamePrefix + "-%d")
                        .setDaemon(true).build();
ExecutorService threadPool = new ThreadPoolExecutor(corePoolSize, maximumPoolSize, keepAliveTime, TimeUnit.MINUTES, workQueue, threadFactory)
```

> **2.è‡ªå·±å®ç° `ThreadFactor`**

```java
import java.util.concurrent.Executors;
import java.util.concurrent.ThreadFactory;
import java.util.concurrent.atomic.AtomicInteger;
/**
 * çº¿ç¨‹å·¥å‚ï¼Œå®ƒè®¾ç½®çº¿ç¨‹åç§°ï¼Œæœ‰åˆ©äºæˆ‘ä»¬å®šä½é—®é¢˜ã€‚
 */
public final class NamingThreadFactory implements ThreadFactory {

    private final AtomicInteger threadNum = new AtomicInteger();
    private final ThreadFactory delegate;
    private final String name;

    /**
     * åˆ›å»ºä¸€ä¸ªå¸¦åå­—çš„çº¿ç¨‹æ± ç”Ÿäº§å·¥å‚
     */
    public NamingThreadFactory(ThreadFactory delegate, String name) {
        this.delegate = delegate;
        this.name = name; // TODO consider uniquifying this
    }

    @Override
    public Thread newThread(Runnable r) {
        Thread t = delegate.newThread(r);
        t.setName(name + " [#" + threadNum.incrementAndGet() + "]");
        return t;
    }

}
```

## 8.5 æ­£ç¡®é…ç½®çº¿ç¨‹æ± å‚æ•°

è¯´åˆ°å¦‚ä½•ç»™çº¿ç¨‹æ± é…ç½®å‚æ•°ï¼Œç¾å›¢çš„éªšæ“ä½œè‡³ä»Šè®©æˆ‘éš¾å¿˜ï¼ˆåé¢ä¼šæåˆ°ï¼‰ï¼

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹å„ç§ä¹¦ç±å’Œåšå®¢ä¸Šä¸€èˆ¬æ¨èçš„é…ç½®çº¿ç¨‹æ± å‚æ•°çš„æ–¹å¼ï¼Œå¯ä»¥ä½œä¸ºå‚è€ƒï¼

### 8.5.1å¸¸è§„æ“ä½œ

å¾ˆå¤šäººç”šè‡³å¯èƒ½éƒ½ä¼šè§‰å¾—æŠŠçº¿ç¨‹æ± é…ç½®è¿‡å¤§ä¸€ç‚¹æ¯”è¾ƒå¥½ï¼æˆ‘è§‰å¾—è¿™æ˜æ˜¾æ˜¯æœ‰é—®é¢˜çš„ã€‚å°±æ‹¿æˆ‘ä»¬ç”Ÿæ´»ä¸­éå¸¸å¸¸è§çš„ä¸€ä¾‹å­æ¥è¯´ï¼š**å¹¶ä¸æ˜¯äººå¤šå°±èƒ½æŠŠäº‹æƒ…åšå¥½ï¼Œå¢åŠ äº†æ²Ÿé€šäº¤æµæˆæœ¬ã€‚ä½ æœ¬æ¥ä¸€ä»¶äº‹æƒ…åªéœ€è¦ 3 ä¸ªäººåšï¼Œä½ ç¡¬æ˜¯æ‹‰æ¥äº† 6 ä¸ªäººï¼Œä¼šæå‡åšäº‹æ•ˆç‡å˜›ï¼Ÿæˆ‘æƒ³å¹¶ä¸ä¼šã€‚** çº¿ç¨‹æ•°é‡è¿‡å¤šçš„å½±å“ä¹Ÿæ˜¯å’Œæˆ‘ä»¬åˆ†é…å¤šå°‘äººåšäº‹æƒ…ä¸€æ ·ï¼Œå¯¹äºå¤šçº¿ç¨‹è¿™ä¸ªåœºæ™¯æ¥è¯´ä¸»è¦æ˜¯å¢åŠ äº†**ä¸Šä¸‹æ–‡åˆ‡æ¢**æˆæœ¬ã€‚ä¸æ¸…æ¥šä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢çš„è¯ï¼Œå¯ä»¥çœ‹æˆ‘ä¸‹é¢çš„ä»‹ç»ã€‚

> ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼š
>
> å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ä¸€èˆ¬çº¿ç¨‹çš„ä¸ªæ•°éƒ½å¤§äº CPU æ ¸å¿ƒçš„ä¸ªæ•°ï¼Œè€Œä¸€ä¸ª CPU æ ¸å¿ƒåœ¨ä»»æ„æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œä¸ºäº†è®©è¿™äº›çº¿ç¨‹éƒ½èƒ½å¾—åˆ°æœ‰æ•ˆæ‰§è¡Œï¼ŒCPU é‡‡å–çš„ç­–ç•¥æ˜¯ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…æ—¶é—´ç‰‡å¹¶è½®è½¬çš„å½¢å¼ã€‚å½“ä¸€ä¸ªçº¿ç¨‹çš„æ—¶é—´ç‰‡ç”¨å®Œçš„æ—¶å€™å°±ä¼šé‡æ–°å¤„äºå°±ç»ªçŠ¶æ€è®©ç»™å…¶ä»–çº¿ç¨‹ä½¿ç”¨ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å±äºä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚æ¦‚æ‹¬æ¥è¯´å°±æ˜¯ï¼šå½“å‰ä»»åŠ¡åœ¨æ‰§è¡Œå®Œ CPU æ—¶é—´ç‰‡åˆ‡æ¢åˆ°å¦ä¸€ä¸ªä»»åŠ¡ä¹‹å‰ä¼šå…ˆä¿å­˜è‡ªå·±çš„çŠ¶æ€ï¼Œä»¥ä¾¿ä¸‹æ¬¡å†åˆ‡æ¢å›è¿™ä¸ªä»»åŠ¡æ—¶ï¼Œå¯ä»¥å†åŠ è½½è¿™ä¸ªä»»åŠ¡çš„çŠ¶æ€ã€‚**ä»»åŠ¡ä»ä¿å­˜åˆ°å†åŠ è½½çš„è¿‡ç¨‹å°±æ˜¯ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢**ã€‚
>
> ä¸Šä¸‹æ–‡åˆ‡æ¢é€šå¸¸æ˜¯è®¡ç®—å¯†é›†å‹çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒéœ€è¦ç›¸å½“å¯è§‚çš„å¤„ç†å™¨æ—¶é—´ï¼Œåœ¨æ¯ç§’å‡ åä¸Šç™¾æ¬¡çš„åˆ‡æ¢ä¸­ï¼Œæ¯æ¬¡åˆ‡æ¢éƒ½éœ€è¦çº³ç§’é‡çº§çš„æ—¶é—´ã€‚æ‰€ä»¥ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¯¹ç³»ç»Ÿæ¥è¯´æ„å‘³ç€æ¶ˆè€—å¤§é‡çš„ CPU æ—¶é—´ï¼Œäº‹å®ä¸Šï¼Œå¯èƒ½æ˜¯æ“ä½œç³»ç»Ÿä¸­æ—¶é—´æ¶ˆè€—æœ€å¤§çš„æ“ä½œã€‚
>
> Linux ç›¸æ¯”ä¸å…¶ä»–æ“ä½œç³»ç»Ÿï¼ˆåŒ…æ‹¬å…¶ä»–ç±» Unix ç³»ç»Ÿï¼‰æœ‰å¾ˆå¤šçš„ä¼˜ç‚¹ï¼Œå…¶ä¸­æœ‰ä¸€é¡¹å°±æ˜¯ï¼Œå…¶ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ¨¡å¼åˆ‡æ¢çš„æ—¶é—´æ¶ˆè€—éå¸¸å°‘ã€‚

ç±»æ¯”äºå®ç°ä¸–ç•Œä¸­çš„äººç±»é€šè¿‡åˆä½œåšæŸä»¶äº‹æƒ…ï¼Œæˆ‘ä»¬å¯ä»¥è‚¯å®šçš„ä¸€ç‚¹æ˜¯çº¿ç¨‹æ± å¤§å°è®¾ç½®è¿‡å¤§æˆ–è€…è¿‡å°éƒ½ä¼šæœ‰é—®é¢˜ï¼Œåˆé€‚çš„æ‰æ˜¯æœ€å¥½ã€‚

- å¦‚æœæˆ‘ä»¬è®¾ç½®çš„çº¿ç¨‹æ± æ•°é‡å¤ªå°çš„è¯ï¼Œå¦‚æœåŒä¸€æ—¶é—´æœ‰å¤§é‡ä»»åŠ¡/è¯·æ±‚éœ€è¦å¤„ç†ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¤§é‡çš„è¯·æ±‚/ä»»åŠ¡åœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­æ’é˜Ÿç­‰å¾…æ‰§è¡Œï¼Œç”šè‡³ä¼šå‡ºç°ä»»åŠ¡é˜Ÿåˆ—æ»¡äº†ä¹‹åä»»åŠ¡/è¯·æ±‚æ— æ³•å¤„ç†çš„æƒ…å†µï¼Œæˆ–è€…å¤§é‡ä»»åŠ¡å †ç§¯åœ¨ä»»åŠ¡é˜Ÿåˆ—å¯¼è‡´ OOMã€‚è¿™æ ·å¾ˆæ˜æ˜¾æ˜¯æœ‰é—®é¢˜çš„ï¼ŒCPU æ ¹æœ¬æ²¡æœ‰å¾—åˆ°å……åˆ†åˆ©ç”¨ã€‚
- å¦‚æœæˆ‘ä»¬è®¾ç½®çº¿ç¨‹æ•°é‡å¤ªå¤§ï¼Œå¤§é‡çº¿ç¨‹å¯èƒ½ä¼šåŒæ—¶åœ¨äº‰å– CPU èµ„æºï¼Œè¿™æ ·ä¼šå¯¼è‡´å¤§é‡çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»è€Œå¢åŠ çº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´ï¼Œå½±å“äº†æ•´ä½“æ‰§è¡Œæ•ˆç‡ã€‚

æœ‰ä¸€ä¸ªç®€å•å¹¶ä¸”é€‚ç”¨é¢æ¯”è¾ƒå¹¿çš„å…¬å¼ï¼š

- **CPU å¯†é›†å‹ä»»åŠ¡(N+1)ï¼š** è¿™ç§ä»»åŠ¡æ¶ˆè€—çš„ä¸»è¦æ˜¯ CPU èµ„æºï¼Œå¯ä»¥å°†çº¿ç¨‹æ•°è®¾ç½®ä¸º Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰+1ã€‚æ¯” CPU æ ¸å¿ƒæ•°å¤šå‡ºæ¥çš„ä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸ºäº†é˜²æ­¢çº¿ç¨‹å¶å‘çš„ç¼ºé¡µä¸­æ–­ï¼Œæˆ–è€…å…¶å®ƒåŸå› å¯¼è‡´çš„ä»»åŠ¡æš‚åœè€Œå¸¦æ¥çš„å½±å“ã€‚ä¸€æ—¦ä»»åŠ¡æš‚åœï¼ŒCPU å°±ä¼šå¤„äºç©ºé—²çŠ¶æ€ï¼Œè€Œåœ¨è¿™ç§æƒ…å†µä¸‹å¤šå‡ºæ¥çš„ä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥å……åˆ†åˆ©ç”¨ CPU çš„ç©ºé—²æ—¶é—´ã€‚
- **I/O å¯†é›†å‹ä»»åŠ¡(2N)ï¼š** è¿™ç§ä»»åŠ¡åº”ç”¨èµ·æ¥ï¼Œç³»ç»Ÿä¼šç”¨å¤§éƒ¨åˆ†çš„æ—¶é—´æ¥å¤„ç† I/O äº¤äº’ï¼Œè€Œçº¿ç¨‹åœ¨å¤„ç† I/O çš„æ—¶é—´æ®µå†…ä¸ä¼šå ç”¨ CPU æ¥å¤„ç†ï¼Œè¿™æ—¶å°±å¯ä»¥å°† CPU äº¤å‡ºç»™å…¶å®ƒçº¿ç¨‹ä½¿ç”¨ã€‚å› æ­¤åœ¨ I/O å¯†é›†å‹ä»»åŠ¡çš„åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¤šé…ç½®ä¸€äº›çº¿ç¨‹ï¼Œå…·ä½“çš„è®¡ç®—æ–¹æ³•æ˜¯ 2Nã€‚

> **å¦‚ä½•åˆ¤æ–­æ˜¯ CPU å¯†é›†ä»»åŠ¡è¿˜æ˜¯ IO å¯†é›†ä»»åŠ¡ï¼Ÿ**

CPU å¯†é›†å‹ç®€å•ç†è§£å°±æ˜¯åˆ©ç”¨ CPU è®¡ç®—èƒ½åŠ›çš„ä»»åŠ¡æ¯”å¦‚ä½ åœ¨å†…å­˜ä¸­å¯¹å¤§é‡æ•°æ®è¿›è¡Œæ’åºã€‚ä½†å‡¡æ¶‰åŠåˆ°ç½‘ç»œè¯»å–ï¼Œæ–‡ä»¶è¯»å–è¿™ç±»éƒ½æ˜¯ IO å¯†é›†å‹ï¼Œè¿™ç±»ä»»åŠ¡çš„ç‰¹ç‚¹æ˜¯ CPU è®¡ç®—è€—è´¹æ—¶é—´ç›¸æ¯”äºç­‰å¾… IO æ“ä½œå®Œæˆçš„æ—¶é—´æ¥è¯´å¾ˆå°‘ï¼Œå¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±åœ¨äº†ç­‰å¾… IO æ“ä½œå®Œæˆä¸Šã€‚

> ğŸŒˆ æ‹“å±•ä¸€ä¸‹ï¼ˆå‚è§ï¼š[issue#1737](https://github.com/Snailclimb/JavaGuide/issues/1737)ï¼‰ï¼š
>
> çº¿ç¨‹æ•°æ›´ä¸¥è°¨çš„è®¡ç®—çš„æ–¹æ³•åº”è¯¥æ˜¯ï¼š`æœ€ä½³çº¿ç¨‹æ•° = Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰âˆ—ï¼ˆ1+WTï¼ˆçº¿ç¨‹ç­‰å¾…æ—¶é—´ï¼‰/STï¼ˆçº¿ç¨‹è®¡ç®—æ—¶é—´ï¼‰ï¼‰`ï¼Œå…¶ä¸­ `WTï¼ˆçº¿ç¨‹ç­‰å¾…æ—¶é—´ï¼‰=çº¿ç¨‹è¿è¡Œæ€»æ—¶é—´ - STï¼ˆçº¿ç¨‹è®¡ç®—æ—¶é—´ï¼‰`ã€‚
>
> çº¿ç¨‹ç­‰å¾…æ—¶é—´æ‰€å æ¯”ä¾‹è¶Šé«˜ï¼Œéœ€è¦è¶Šå¤šçº¿ç¨‹ã€‚çº¿ç¨‹è®¡ç®—æ—¶é—´æ‰€å æ¯”ä¾‹è¶Šé«˜ï¼Œéœ€è¦è¶Šå°‘çº¿ç¨‹ã€‚
>
> æˆ‘ä»¬å¯ä»¥é€šè¿‡ JDK è‡ªå¸¦çš„å·¥å…· VisualVM æ¥æŸ¥çœ‹ `WT/ST` æ¯”ä¾‹ã€‚
>
> CPU å¯†é›†å‹ä»»åŠ¡çš„ `WT/ST` æ¥è¿‘æˆ–è€…ç­‰äº 0ï¼Œå› æ­¤ï¼Œ çº¿ç¨‹æ•°å¯ä»¥è®¾ç½®ä¸º Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰âˆ—ï¼ˆ1+0ï¼‰= Nï¼Œå’Œæˆ‘ä»¬ä¸Šé¢è¯´çš„ Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰+1 å·®ä¸å¤šã€‚
>
> IO å¯†é›†å‹ä»»åŠ¡ä¸‹ï¼Œå‡ ä¹å…¨æ˜¯çº¿ç¨‹ç­‰å¾…æ—¶é—´ï¼Œä»ç†è®ºä¸Šæ¥è¯´ï¼Œä½ å°±å¯ä»¥å°†çº¿ç¨‹æ•°è®¾ç½®ä¸º 2Nï¼ˆæŒ‰é“ç†æ¥è¯´ï¼ŒWT/ST çš„ç»“æœåº”è¯¥æ¯”è¾ƒå¤§ï¼Œè¿™é‡Œé€‰æ‹© 2N çš„åŸå› åº”è¯¥æ˜¯ä¸ºäº†é¿å…åˆ›å»ºè¿‡å¤šçº¿ç¨‹å§ï¼‰ã€‚

**å…¬ç¤ºä¹Ÿåªæ˜¯å‚è€ƒï¼Œå…·ä½“è¿˜æ˜¯è¦æ ¹æ®é¡¹ç›®å®é™…çº¿ä¸Šè¿è¡Œæƒ…å†µæ¥åŠ¨æ€è°ƒæ•´ã€‚æˆ‘åœ¨åé¢ä»‹ç»çš„ç¾å›¢çš„çº¿ç¨‹æ± å‚æ•°åŠ¨æ€é…ç½®è¿™ç§æ–¹æ¡ˆå°±éå¸¸ä¸é”™ï¼Œå¾ˆå®ç”¨ï¼**

### 8.5.2 ç¾å›¢çš„éªšæ“ä½œ

ç¾å›¢æŠ€æœ¯å›¢é˜Ÿåœ¨[ã€ŠJava çº¿ç¨‹æ± å®ç°åŸç†åŠå…¶åœ¨ç¾å›¢ä¸šåŠ¡ä¸­çš„å®è·µã€‹](https://tech.meituan.com/2020/04/02/java-pooling-pratice-in-meituan.html)è¿™ç¯‡æ–‡ç« ä¸­ä»‹ç»åˆ°å¯¹çº¿ç¨‹æ± å‚æ•°å®ç°å¯è‡ªå®šä¹‰é…ç½®çš„æ€è·¯å’Œæ–¹æ³•ã€‚

> ç¾å›¢æŠ€æœ¯å›¢é˜Ÿçš„æ€è·¯æ˜¯ä¸»è¦å¯¹çº¿ç¨‹æ± çš„æ ¸å¿ƒå‚æ•°å®ç°è‡ªå®šä¹‰å¯é…ç½®ã€‚è¿™ä¸‰ä¸ªæ ¸å¿ƒå‚æ•°æ˜¯ï¼š

- **`corePoolSize` :** æ ¸å¿ƒçº¿ç¨‹æ•°çº¿ç¨‹æ•°å®šä¹‰äº†æœ€å°å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡ã€‚
- **`maximumPoolSize` :** å½“é˜Ÿåˆ—ä¸­å­˜æ”¾çš„ä»»åŠ¡è¾¾åˆ°é˜Ÿåˆ—å®¹é‡çš„æ—¶å€™ï¼Œå½“å‰å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡å˜ä¸ºæœ€å¤§çº¿ç¨‹æ•°ã€‚
- **`workQueue`:** å½“æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœè¾¾åˆ°çš„è¯ï¼Œæ–°ä»»åŠ¡å°±ä¼šè¢«å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ã€‚

> **ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸‰ä¸ªå‚æ•°ï¼Ÿ**

æˆ‘åœ¨è¿™ç¯‡[ã€Šæ–°æ‰‹ä¹Ÿèƒ½çœ‹æ‡‚çš„çº¿ç¨‹æ± å­¦ä¹ æ€»ç»“ã€‹](https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&mid=2247485808&idx=1&sn=1013253533d73450cef673aee13267ab&chksm=cea246bbf9d5cfad1c21316340a0ef1609a7457fea4113a1f8d69e8c91e7d9cd6285f5ee1490&token=510053261&lang=zh_CN&scene=21#wechat_redirect) ä¸­å°±è¯´è¿‡è¿™ä¸‰ä¸ªå‚æ•°æ˜¯ `ThreadPoolExecutor` æœ€é‡è¦çš„å‚æ•°ï¼Œå®ƒä»¬åŸºæœ¬å†³å®šäº†çº¿ç¨‹æ± å¯¹äºä»»åŠ¡çš„å¤„ç†ç­–ç•¥ã€‚

> **å¦‚ä½•æ”¯æŒå‚æ•°åŠ¨æ€é…ç½®ï¼Ÿ** 

ä¸”çœ‹ `ThreadPoolExecutor` æä¾›çš„ä¸‹é¢è¿™äº›æ–¹æ³•ã€‚

![](https://github.com/Snailclimb/JavaGuide/raw/main/docs/java/concurrent/images/thread-pool/b6fd95a7-4c9d-4fc6-ad26-890adb3f6c4c.png)

æ ¼å¤–éœ€è¦æ³¨æ„çš„æ˜¯`corePoolSize`ï¼Œ ç¨‹åºè¿è¡ŒæœŸé—´çš„æ—¶å€™ï¼Œæˆ‘ä»¬è°ƒç”¨ `setCorePoolSizeï¼ˆï¼‰`è¿™ä¸ªæ–¹æ³•çš„è¯ï¼Œçº¿ç¨‹æ± ä¼šé¦–å…ˆåˆ¤æ–­å½“å‰å·¥ä½œçº¿ç¨‹æ•°æ˜¯å¦å¤§äº`corePoolSize`ï¼Œå¦‚æœå¤§äºçš„è¯å°±ä¼šå›æ”¶å·¥ä½œçº¿ç¨‹ã€‚

å¦å¤–ï¼Œä½ ä¹Ÿçœ‹åˆ°äº†ä¸Šé¢å¹¶æ²¡æœ‰åŠ¨æ€æŒ‡å®šé˜Ÿåˆ—é•¿åº¦çš„æ–¹æ³•ï¼Œç¾å›¢çš„æ–¹å¼æ˜¯è‡ªå®šä¹‰äº†ä¸€ä¸ªå«åš `ResizableCapacityLinkedBlockIngQueue` çš„é˜Ÿåˆ—ï¼ˆä¸»è¦å°±æ˜¯æŠŠ`LinkedBlockingQueue`çš„ capacity å­—æ®µçš„ final å…³é”®å­—ä¿®é¥°ç»™å»æ‰äº†ï¼Œè®©å®ƒå˜ä¸ºå¯å˜çš„ï¼‰ã€‚

æœ€ç»ˆå®ç°çš„å¯åŠ¨æ€ä¿®æ”¹çº¿ç¨‹æ± å‚æ•°æ•ˆæœå¦‚ä¸‹ã€‚ğŸ‘ğŸ‘ğŸ‘

![[åŠ¨æ€é…ç½®çº¿ç¨‹æ± å‚æ•°æœ€ç»ˆæ•ˆæœ]](https://github.com/Snailclimb/JavaGuide/raw/main/docs/java/concurrent/images/thread-pool/19a0255a-6ef3-4835-98d1-a839d1983332.png)
è¿˜æ²¡çœ‹å¤Ÿï¼Ÿæ¨è why ç¥çš„[ã€Šå¦‚ä½•è®¾ç½®çº¿ç¨‹æ± å‚æ•°ï¼Ÿç¾å›¢ç»™å‡ºäº†ä¸€ä¸ªè®©é¢è¯•å®˜è™èº¯ä¸€éœ‡çš„å›ç­”ã€‚ã€‹](https://mp.weixin.qq.com/s?__biz=Mzg3NjU3NTkwMQ==&mid=2247505103&idx=1&sn=a041dbec689cec4f1bbc99220baa7219&source=41#wechat_redirect)è¿™ç¯‡æ–‡ç« ï¼Œæ·±åº¦å‰–æï¼Œå¾ˆä¸é”™å“¦ï¼

# ä¹ã€å‚è€ƒ

- ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹
- [Java Scheduler ScheduledExecutorService ScheduledThreadPoolExecutor Example](https://www.journaldev.com/2340/java-scheduler-scheduledexecutorservice-scheduledthreadpoolexecutor-example "Java Scheduler ScheduledExecutorService ScheduledThreadPoolExecutor Example")
- [java.util.concurrent.ScheduledThreadPoolExecutor Example](https://examples.javacodegeeks.com/core-java/util/concurrent/scheduledthreadpoolexecutor/java-util-concurrent-scheduledthreadpoolexecutor-example/ "java.util.concurrent.ScheduledThreadPoolExecutor Example")
- [ThreadPoolExecutor â€“ Java Thread Pool Example](https://www.journaldev.com/1069/threadpoolexecutor-java-thread-pool-example-executorservice "ThreadPoolExecutor â€“ Java Thread Pool Example")

