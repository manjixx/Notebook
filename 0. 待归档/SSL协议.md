# SSL 协议

## 一、基本概念

SSL 的全称为`SecureSockets Layer`, 即安全套接层。它是一种网络安全协议，目的是为了保障网络通信的安全，校验通信双方的身份，加密传输的数据。

SSL协议的优势在于它与应用层协议独立无关，高层的应用层协议如HTTP、SSH,FTP 竺等，能透明的建立于SSL协议之上，**在应用层通信之前就已经完成加密算法、通信密钥的协商以及服务端及客户端的认证工作，在此之后所有应用层协议所传输的数据都会被加密**，从而保证通信的私密性。

SSL 的继任者是 TLS 协议（Transport Layer Security）, 即传输层安全协议，是基于 SSL 协议的通用化协议，同样位于应用层与传输层之间，正逐步接替SSL成为下一代网络安全协议。

`SSL/TLS` 协议均可以分为两层：

- 一层为`RecordProtocol`, 即记录协议。记录协议建立在可靠的传输协议（如TCP）之上，提供数据封装、加密解密、数据压缩、数据校验等基本功能。
- 另一层为Handshake Protocol, 即握手协议。握手协议建立在记录协议之上，在实际的数据传输开始前，进行加密算法的协商，通信密钥的交换，通信双方身份的认证等工作。

## 二、SSL 握手流程

![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/8/30/16ce0e0117fbc94d~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.png)

步骤如下:

1. 客户端发送一个 `say hello` 信息，消息包含 协议的版本信息，`sessionid`信息，客户端支持的加密算法，压缩算法信息，并且包含客户端产生的随机数。

2. 服务端响应 `server hello`信息，消息包含服务端产生的随机数协议版本等等客户端类似的以及服务端数字证书。如果服务端配置的双向认证，这时候服务端还要验证客户端证书。

3. 客户端通过证书验证服务端合法性。

4. 如果证书验证通过，客户端向服务端发送经过服务端加密的预主密钥 PMS(`PreMaster Secret`)。假如服务端在上一个步骤请求了客户端证书，客户端会将客户端证书发送给服务端校验。

5. 服务端验证证书有效，并通过自己私钥对 PMS 进行解密，**使用客户端发送的随机数和服务端发送的随机数，加上解密的 PMS 来生成主密钥(MS)**，然后通过主密钥来生成加密密钥。

6. 客户端也将使用两个随机数加上 PMS 生成 MS，然后通过MS生成加密密钥。

客户端

7. 通知服务端未来信息使用加密密钥加密。

8. 给服务端发送加密密钥来加密信息，终止握手。

服务端

9. 通知客户端使用加密密钥加密。

10. 给客户端发送加密密钥，终止握手。

在服务端与客户端真正的数据交换阶段，实际上数据是通过对称加密算法来实现加密的，密钥为双方约定好的加密密钥。客户端首先使用加密密钥来加密请求内容，发送给服务端，服务端使用加密密钥对请求进行解密并处理相应的汕求，然后生成响应内容。响应经过加密密钥。加密后，发送给客户端，客户端通过加密密钥对响应内容进行解密，以获得响应内容。

