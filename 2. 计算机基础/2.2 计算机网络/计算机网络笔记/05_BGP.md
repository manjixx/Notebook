# BGP (Border Gateway Protocol|边界网关协议)
## 自治系统AS
- AS号
  - 取值范围：1～65536
  - 64512～65535：运营商私用，用于为特定付费客户提供服务
  - 私用号码段的网络访问公有网络之前，会在外出时被ISP的PE（边界设备）替换掉。
- 分类   
  1. **单宿主AS**
     - *末节网络，stub，single-homed*
     - 指到达外部网络有且只有一个出口
     - 到达外部网络往往只需要一条缺省路由
     - 按客户需求，ISP也可以与单宿主AS之间运行IGP或EGP
  2. 多宿主AS
     - 多宿主指客户网络到达外部网络有且不止一个出口
     - 2.1 **多宿主非渡越型AS**
       - 不允许两个外部网络穿越本地AS进行数据通讯
     - 2.2 **多宿主渡越型AS** 
       - 允许两个外部网络穿越本地AS进行数据通讯
## BGP
- 应用于ISP之间，用于连接不同AS。确保建立 **无环拓扑结构**。
  - 偶尔用于Client与ISP之间，此时客户与运营商之间互相需要注入路由条目，而不仅仅是ISP提供网络通信。
  - 不限制路由器个数。
- 何时不用BGP
  1. 只有一条通往Internet或其它AS的链接时
  2. 在单宿主AS中，若客户网络与ISP之间仅有连通性需求，无需学习ISP的路由条目和ISP的策略（即路由策略和路由选择与AS无关）时；
  3. AS间的链路带宽有限时；
  4. 路由器自身的CPU算力较低，内存较小时。
- BGP基于TCP（179号端口）实现
  - 具备TCP的特点：面向连接、可靠的
  - 只要两端在第四层能够通过TCP三次握手建立连接，则可建立BGP的对等体关系，即时中间的所有路由器都不配置BGP 
- 对等体（Peer）
  - 两台BGP邻居路由器建立的关系称之为 **对等体关系**
  - 在对等体关系 **建立时**，会交换所有 **候选BGP**（待发送的所有路由条目）
  - 在对等体关系 **建立完成后**，增量更新（同OSPF）
  - **保活**：
  - 增量更新内容：
    - 路由前缀（掩码），AS路径，路径属性（由此确保得到无环路径）
  - **路由表版本号码**：由BGP路由器保存，路由表发生变化时版本号增加
  - 对等体关系
    - IBGP关系：同一个AS的路由器之间；EBGP关系：不同AS的路由器之间
    - 从IBGP获得的路由不向它的IBGP peer发布（确保路径无环），<u>因此每个IBGP peer之间都需要配置建立关系</u>，此时，IBGP学习到的路由的下一跳是其IBGP的对端接口，该接口不一定是其直连路由对端。
      - 路由反射器（RR）功能可以打破这一规定。
- **同步问题**
  - BGP同步，指IBGP和IGP之间的同步
    ```bash
    # 关闭同步，华为设备默认执行，无需手动配置这一行，且不允许开启
    undo synchronization  
    ```
  - 从IBGP获得的路由是否发布给它的EBGP peer，与BGP是否 **同步** 有关。
    - 开启同步后，只有在IGP也知道这条IBGP路由时，才会被发布给EBGP peer。
      - 也就是说，**开启同步后，EBGP peer之间只会通告各自的IGP路由。**
      - 关闭同步后，EBGP peer之间会通告自己的IBGP路由，而无需运行IGP 。
## 消息格式
- 包头格式
   - 标记字段marker（16字节）
     - 认证BGP消息 或 检测对等体的同步
   - 长度字段（2字节）= 19～4096
   - 类型字段（1字节，5种）
     - Keepalive，保活消息
       - 16+2+1共19字节，只包含BGP包头
       - 无增量更新时，每隔60s，发送19字节的keepalive包
       - 保持时间（holddown）是保活时间（keepalive）的3倍
       - 为0则不发送周期性消息
     - Open，发起连接消息
       - 路由器正在建立对等体关系过程中
       - 包含：BGP版本号，AS号码（判断IBGP/EBGP关系），路由器ID
     - Notification，通知消息
       - 通告 **错误**
     - Update，更新消息
       - 正在发送增量更新，传输无环路径的所有信息
     - Route-refresh，刷新消息
       - 管理员通过命令手动刷新BGP路由 
## 6种对等体关系协商状态
1. 空闲状态，Idle
   - 侦听和等待对端发送的TCP握手（SYN）消息
2. 连接状态，Connect
   - 与对端进行TCP三次握手
   - 若成功，则进入Open-Sent状态
   - 若失败，则进入Active状态
3. 活跃状态，Active
   - 用于表明两台BGP路由器TCP三次握手未成功的特殊状态
   - 该状态下路由器不断尝试与对端进行TCP三次握手
   - 若成功，则进入Open-Sent状态
   - 若手动停止，则进入Idle状态
4. Open消息发送状态，Open-Sent
   - 给对端设备发送Open消息，等待对端的Open确认消息
5. Open消息确认状态，Open-Confirm
   - 若正常接收到对端所发送的Open消息，则向对端回应Open确认消息
6. 连接已建立状态，Established
   - 表明双方已完成BGP对等体关系的建立
## 路由过程
1. 从对等体接收到路由后，首先在入站接口配置 **入站引擎策略**，过滤不想要的数据包
2. 通过过滤的数据包进入内部 **BPG表**，在该表中，根据管理员配置的策略及属性选择 **最佳路径**
3. 到达目标网络的最佳路径倍安装入 **路由表项**
4. 出站接口配置 **出站策略引擎**，决定哪些数据包从哪些接口发出
- *注：从入站接口到出站接口，整个过程都是 <u>可被策略的</u>*
- *两张表：<u>BGP表，IP路由表</u>*
## 策略路由（policy-based-route|PBR）
- PBR **直接对数据报文进行操作**，匹配感兴趣报文，从而丢弃或强制转发路径等操作
- 可以打破原有协议的既定选路规则
## 路由策略（route-policy）
- 在路由协议框架下操作、控制、修改 **路由信息** 的相关参数、属性，从而影响数据报文的转发路径
- 应用某协议的规则来更改路由表的过程（应用规则而非更改规则）（）
- 每一种路由协议也可以被当作一种路由策略
- ***二者区别***   
    名称|操作对象|描述
    :-:|:-:|:-
    路由策略（route-policy）|路由信息|路由优先于策略，修改规则属性
    策略路由（PBR）|数据报文|策略优先于路由，更改规则本身
## BGP的8个属性
1. 下一跳（Next Hop）
   - 用于AS的边界路由器向其各个IBGP peer通告学习到的EBGP路由，使得其它IBGP peer以该边界路由器为下一跳，来访问到达EBGP路由。。
   - ```peer 2.2.2.2 next-hop-local```
2. AS-Path（AS Path）
   - 用于防止环路。
   - EBGP通告的增量路由条目会携带AS号，各个AS的边界路由器通过识别AS号判断该路由条目是否源自或经过过本AS，从而决定是否转发。
3. 原子汇总（Atomic Aggregate）
4. 汇总子（Aggregator）
5. 本地优先级（Local Preference）
6. 优先级值（Preference Value）
7. 多出口鉴别（Multiple Exit Discriminator， MED）
8. 起源（Origin）


# 配置
```bash
# 一、开启BGP服务
# 对边界路由器配置BGP，需要对peer双方进行以下相同的配置12345+67
# 对同一AS的路由器配置BGP，只需要执行以下12345+89

#1.本地AS号为65501。后面所有对BGP的配置都需要首先执行这一步进入BGP视图。
bgp 65501 
#2.须指定路由器ID
route-id 1.1.1.1 
#3.与rid为2.2.2.2的peer路由器的lo接口（默认up）建立peer关系，该路由器属于AS7
peer 2.2.2.2 as-number 7 
#4.本地利用lo0接口与peer交换消息
peer 2.2.2.2 connect-interface lo0 
#5.通告网段。在AS边界路由器上的直连网段只需要ISP端通告，客户端路由器无需通告。
network 10.1.1.0 24 
undo summary automatic #关闭自动汇总

#6.不同AS建立ebgp关系，距离2跳
peer 2.2.2.2 ebgp-max-hop 2 
#7.不同AS之间的边界路由器，配置静态路由，使得peer双方的lo接口连通
ip route-static 2.2.2.2 32 10.1.1.2 

#8.同一个AS之间启动一个IGP路由协议，否则两两同7配置也可
ospf 1 #....
#9.同一个AS之间配置下一跳属性。AS的边界BGP路由器向其各个IBGP peer通告自己是对方的下一跳
peer 2.2.2.2 next-hop-local

#10.设置只传递公有AS号。
#在ISP的边界路由器设置，用其所属的公有AS号替换客户网络内部私有AS号，使其不出现在AS Path中。
peer 2.2.2.2 public-as-only

# <>
reset bgp 65501 #重置BGP表

# []
display bgp peer #查询peer关系
display bgp routing-table #查询BGP表，可查询到AS Path 
```
