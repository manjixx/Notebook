# 一、前言

## 1.1 数据存储发展历程


> **单机MySQL时代**

APP -> DAL(Data Access Layer) -> MySQL

这种模式下的瓶颈：
- 数据量太大，一个机器存放不下
- 数据的索引太大，一个机器的内存放不下
- 访问量（读写混合）太大，一个服务器承受不住 

> **缓存MemCache + 读写分离**

网站上80%的情况都是在读，每次都去查询数据库，效率很低。

此时可以引入缓存机制，第一次查询去MySQL中读取数据，数据返回给用户时，在缓存中也存储下来。第二次访问，就可以直接从缓存中读取


> **分库分表 + 水平拆分(MySQL集群)**

随着社会的发展，要存储数据的类型（音乐，视频，地理位置，人际交往圈、用户自己产生的数据，用户日志等）也越来越繁多，数据量也爆发式增长。这样MySQL等关系型数据库就越来越不够用了！NoSQL数据库就开始进入人们的视野！NoSQL数据库可以很好的解决这些问题。


## 1.2 NOSQL简介

NoSQL（Not Only SQL） 泛指非关系型数据库

> **NoSQL特点**

- 方便扩展（数据之间没有关系）
- 大数据量高性能（Redis写8w/s, 读11w/s，NoSQL的缓存记录级是一种细粒度的，性能会更高）
- 数据类型多样：不需要事先设计数据库，随取随用
- **存储方式多样**：键值对，列存储，文档存储，图形数据库
- 没有固定的查询语言

> **NoSQL的四大分类**

- **Key-Value 键值对:** 新浪 Redis、美团 Redis+Tair 、阿里与百度 Redis+Memcached 
- **文档型数据库 bson格式：** MongoDB是一个基于分布式文件存储的数据库，C++编写，主要用来处理大量的文档；MongoDB是一个介于关系型数据库和非关系型数据库的中间产品。MongoDB是非关系型数据库。
- **列存储数据库：** HBase、分布式文件系统 GFS
- **图关系数据库：** 不是用于存储图片，而是用来存储关系，比如：朋友圈社交网络、广告推荐！Neo4j，infoGrid

**四种分类对比**

|   分类    |   Example |   典型应用场景    |   数据模型    |   优点    |   缺点    |
|   ----    |   ---- |   ----    |   ----    |   ----    |   ----   |
|   Key-Value 键值对    |   Tokyo Cabinet/Tyrant、redis、Voldemort、Oracle DBD |   ==内容缓存==，主要用于处理大量数据的高访问负载，也用于一些日志系统    |   Key-Value键值对，通常利用Hash-table实现    |   查找速度快    |   数据无结构化、通常只被当做字符串或二进制数据  | 
|   列存储数据库    |   Cassandra、Hbase、Riak |   ==分布式文件系统==    |   以列簇式存储，将同一列数据存储在一起    |   查找速度快、可扩展性强，更容易进行分布式扩展    |   功能相对局限  |
|   文档型数据库     |   CouchDB、MongoDB |   ==web应用==（与Key-Value相似，value是结构化的，不同的是数据库能够了解value的内容）    |   Key-Value对应的键值对，Value为结构化数据    |   数据结构要求不严格，表结构可变，不需要像关系型数据库一样需要预先定义表结构    |   查询性能不高，而且缺乏统一的查询语法  |  
|   图关系数据库     |   Neo4j、InfoGrid、Infinite Graph |   社交网络，推荐系统。专注于构建==关系图谱==    |   图结构    |   利用图结构相关算法，如最短路径寻址，N度关系查找等    |   很多时候需要对整个图做计算才能得出需要的信息，而且这种结构不太好做分布式方案  |  

# 二、 Redis 简介

## 2.1 Redis简介

- Redis是一种开放源代码（BSD许可）的内存中数据结构存储，用作数据库，缓存和消息代理。
- Redis提供数据结构，例如**字符串**，**哈希，列表，集合，带范围查询的排序集合，位图，超日志，地理空间索引和流**。
- Redis具有内置的复制，Lua脚本，LRU驱逐，事务和不同级别的磁盘持久性，并通过`Redis Sentinel哨兵`和`Redis Cluster`自动分区提供了高可用性。

> **Redis、Memcached、MySQL和PostgreSQL比较**

> **Redis为什么单线程还这么快？**

Redis是C语言实现的，基于内存操作，CPU不是Redis的性能瓶颈，Redis的瓶颈就是根
据机器的内存和网络带宽。

Redis官方数据：读：110000/s 写： 80000/s

**核心：** Redis是将所有的数据全部放在内存中的，此时使用单线程操作效率就是最高的，相比多线程，减少了CPU上下文切换的耗时。
- **纯内存操作** ，避免大量访问数据库，减少直接读取磁盘数据，redis将数据储存在内存里面，读写数据的时候都不会受到硬盘 I/O 速度的限制，所以速度快；
- **单线程操作**，避免了**不必要的上下文切换和竞争条件**，不用去考虑各种**锁的问题**，不存在加锁释放锁操作，没有因为可能出现死锁而导致的性能消耗；
- 采用了非阻塞I/O多路复用机制

**注意：** Redis读写是单线程的，但Redis server是多线程，因为redis它还要做其他事情

## 2.2 Redis基本命令

Redis 默认有16个数据库，默认使用的是第0个数据库，可以通过select切换数据库 **(Redis的命令同SQL语句一样对大小写不敏感）**

> **数据库相关命令**

```shell
# 启动客户端
redis-cli

# 启动客户端，-p 指定端口号
redis-cli -p 6379

# 切换数据库
select 3

# 查看当前数据库中键keys的个数是(元素个数)
dbsize

# 清空当前数据库
flushdb

# 清空所有数据库
flushall

```

> **Redis键值对，键key相关命令**
```shell
# 查看当前数据库所有key
keys *

# 设置key
set stu wang

# 查看key的值
get stu

# 设置key的国企时间
expire stu 10

# 查看key的过期时间
ttl stu

# 判断key是否存在
exists stu

# 删除key
del stu

# 查看key对应的value的类型
type stu
```

> **帮助命令**

```bash
help

help 命令  # help set

help @类型  # help @string
```

****

# 三、Redis数据类型


# 四、Redis数据结构

## 4.1 前言

> **Redis为什么这么快?**

- 内存数据
- 实现的数据库，使得我们对数据进行增删改查操作时，Redis能高效处理

> **注意**

Redis数据结构是指**数据的保存形式**，是指Redis键值对中`value`的数据类型在底层实现的方式。

> **Redis对象和底层数据结构的对应关系**

Redis **数据类型的底层数据结构随着版本的更新也有所不同**,如:
- 在 Redis 3.0 版本中 List 对象的底层数据结构由「双向链表」或「压缩表列表」实现，但是在 3.2 版本之后，List 数据类型底层数据结构是由 quicklist 实现的；
- 在最新的 Redis 代码（还未发布正式版本）中，压缩列表数据结构已经废弃了，交由 listpack 数据结构来实现了。

![Redis对象和底层数据结构的对应关系图](https://camo.githubusercontent.com/e27c316103db0dd0b585b0bc569efc263bd0736dc55feb01828abafe0f84807a/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f39666132366137343936356566626630663536623730376130336262396237662e706e67)


本文对Redis新旧版本的数据结构进行讲解：共有 9 种数据结构：SDS、双向链表、压缩列表、哈希表、跳表、整数集合、quicklist、listpack。
![Redis数据结构](https://camo.githubusercontent.com/5d4451175e10f2befdea0ccdb31f45d41abc3830224f925b83b5b3b11b2dc7dd/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f61396333653764633461633739333633643865623865623232393061353865362e706e67)

## 4.1 键值对数据库如何实现

Redis键值对中:
- Key：字符串对象
- Value：可以是字符串对象，也可以是集合数据类型的对象，如List对象、Hash对象、Set对象和Zset对象

> **几种 Redis 新增键值对的命令**

```bash
# name:字符串键，因为键的对象是一个字符串对象
> SET name "xiaolincoding"
ok

# person：哈希表键，因为键值时一个包含两个键值对的哈希表对象
> HSET person name "xiaolincoding" age 18
0

# stu：列表键，因为键值是一个包含两个元素的列表对象
> RPUSH stu "xiaolin" "xiaomei"
(integer) 4
```

> **键值对如何保存在Redis**

Redis使用一个**哈希表**保存所有键值对，哈希表的最大好处是可以用${O(1)}$的时间复杂度来快速查找到键值对。

哈希表其实就是一个数组，数组的中的元素叫**哈希桶**

> **Redis的哈希桶是如何保存键值对**
